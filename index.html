<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Авторизация по пин-коду</title>
<link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
<style>
  :root {
    --black-color: #121212;
    --white-color1: #F4F5F0;
    --white-color2: #D1D5D0;
    --borderRadius: 10px;
    --spacer: 1vw;
    --linkHeight: 3.5rem;
    --timing: 250ms;
    --transition: 250ms ease all;
  }

  * {
    box-sizing: border-box;
    font-family: "Comfortaa", sans-serif;
    margin: 0;
    padding: 0;
    font-optical-sizing: auto;
  }

  body, html {
    margin: 0;
    padding: 0;
    background-color: var(--black-color);
    color: var(--white-color1);
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  #app {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    height: 100vh;
    width: 100vw;
    position: relative;
    overflow: hidden;
  }
  
  /*функция фильтрации данных*/
  #pin-wrapper {
    transition: opacity 0.5s ease, transform 0.5s ease;
  }

  #pin {
    display: flex;
    gap: 10px;
  }

  .pin-input {
    width: 60px;
    height: 70px;
    font-size: 30px;
    text-align: center;
    background-color: transparent;
    border: 2px solid var(--white-color1);
    color: var(--white-color1);
    outline: none;
    border-radius: 10px;
    transition: border-color 0.3s, background-color 0.3s;
  }

  .pin-input:hover {
    border-color: var(--white-color1);
    background-color: rgba(255, 255, 255, 0.1);
    box-shadow: 0 0 16px 2px var(--white-color1);
  }

  .pin-input:focus {
    border-color: var(--white-color2);
    background-color: rgba(255, 255, 255, 0.1);
    box-shadow: 0 0 32px 4px var(--white-color1);
  }

  #error-message {
    margin-top: 20px;
    color: var(--white-color2);
    font-size: 20px;
    opacity: 0;
    transition: opacity 0.5s ease;
  }

  .shake {
    animation: shake 0.5s;
  }

  @keyframes shake {
    0% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    50% { transform: translateX(5px); }
    75% { transform: translateX(-5px); }
    100% { transform: translateX(0); }
  }

  .navbar {
    display: flex;
    position: fixed;
    top: var(--spacer);
    left: var(--spacer);
    background: rgba(255, 255, 255, 0.04);
    box-shadow: 0 0 1vw rgba(0, 0, 0, 0.5);
    border-radius: var(--borderRadius);
    padding: var(--spacer) 0;
    box-shadow: 0 0 40px rgba(0,0,0,0.03);
    height: calc(100vh - (var(--spacer)*2));
    width: 3vw;
    z-index: 3000;
    opacity: 0;
    transform: translateY(-20px);
    transition: opacity 1s ease, transform 1s ease;
  }

  .navbar.fade-in {
    opacity: 1;
    transform: translateY(0);
  }

  .navbar__menu {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .navbar__item {
    position: relative;
    margin-bottom: 1vw;
    height: var(--linkHeight);
  }

  .navbar__link {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    height: var(--linkHeight);
    width: calc(var(--spacer)*3);
    margin: 0 auto;
    color: var(--white-color1);
    text-decoration: none;
    transition: var(--transition);

    box-sizing: border-box;
  }

  .navbar__link i.material-symbols-outlined {
    font-size: 1vw;;
    color: var(--white-color2);
  }

  .navbar__link span {
    position: absolute;
    left: 80%;
    white-space: nowrap;
    margin-left: 1vw;
    opacity: 0;
    pointer-events: auto;
    color: var(--white-color1);
    padding: 0.3vw 0.5vw;
    transform: translateX(0);
    transition: var(--transition);
  font-size: 0.3vw;;
  background: rgba(255, 255, 255, 0.19);
  border-radius: 10px;
  box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
  backdrop-filter: blur(13px);
  -webkit-backdrop-filter: blur(13px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  }

  .navbar__item:hover .navbar__link span {
    opacity: 1;
    transform: translateX(0);
    pointer-events: auto;
  }

  .navbar__link:hover {
    background: var(--white-color1);
    border-radius: 10px;
    height: 1.7vw;
    width: 1.7vw;
    height: var(--linkHeight);
  }

  .navbar__link i.material-symbols-outlined:hover {
    color: var(--black-color);
}

  /*ключи для рендеринга карточек с данными*/
  .modal {
    display: none;
    position: fixed;
    top: 1vw;
    left: calc(100vw - (var(--spacer)*95));
    background: rgba(255, 255, 255, 0.04);
    padding: 1vw;
    border-radius: 0.4vw;
    box-shadow: 0 0 1vw rgba(0, 0, 0, 0.5);
    height: calc(100vh - (var(--spacer)*2));
    width: calc(100vw - (var(--spacer)*6));
    color: black;
    z-index: 2000;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.5s ease, transform 0.5s ease;
    overflow-y: auto;
  }

  .modal.show {
    display: block;
    opacity: 1;
    transform: translateY(0);
  }

  .modal.hide {
    display: block;
    opacity: 0;
    transform: translateY(20px);
  }

  .fade-out {
    opacity: 0;
    transform: translateY(20px);
  }

  .fade-in {
    opacity: 1;
    transform: translateY(0);
  }

  h2 {
    position: fixed;
    top: 1vw;
    left: 1vw;
    font-size: 0.65vw;;
    color: var(--white-color2);
  }

  p {
    position: fixed;
    top: 1.85vw;
    left: 1vw;
    font-size: 0.4vw;;
    color: var(--white-color2);
  }

  .material-symbols-outlined {
    font-variation-settings:
    'FILL' 0,
    'wght' 400,
    'GRAD' 0,
    'opsz' 24
  }

  /*Стили для блока загрузки подгружаемых html*/
  .modal-content {
    margin-top: 4vw; /* отодвигаем ниже заголовка и описания */
    /* Можно добавить стили для скрытия при загрузке */
    display: none;
  }

  /* Добавляем стили для лоадера и плавных переключений */
.lines-loader, .modal-content {
  transition: opacity 0.5s ease;
  opacity: 0; /* Изначально скрываем контент, лоадер будет показан через JS */
  pointer-events: none;
}

.lines-loader.show, .modal-content.show {
  opacity: 1;
  pointer-events: auto;
}

/*стили лоадера перенесены сюда же, чтобы они не конфликтовали*/
.lines-loader {
  display: flex;
  align-items: center;
  gap: 10px;
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
}

.line {
  width: 10px;
  height: 70px;
  background-color: #ffffff;
  animation: bounce 1.5s infinite ease-in-out;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  border-radius: 10px;
}

.line:nth-child(2) { animation-delay: 0.3s; }
.line:nth-child(3) { animation-delay: 0.6s; }
.line:nth-child(5) { animation-delay: 1.2s; }

@keyframes bounce {
  0%,20%,50%,80%,100% { transform: translateY(0); }
  40% { transform: translateY(-30px); }
  60% { transform: translateY(-15px); }
}
  
</style>
</head>
<body>
<div id="app">
   
   <!-- РАЗМЕТКА для полей пин-кода -->
  <div id="pin-wrapper">
    <div id="pin">
      <input type="password" maxlength="1" class="pin-input" />
      <input type="password" maxlength="1" class="pin-input" />
      <input type="password" maxlength="1" class="pin-input" />
      <input type="password" maxlength="1" class="pin-input" />
      <input type="password" maxlength="1" class="pin-input" />
      <input type="password" maxlength="1" class="pin-input" />
      <input type="password" maxlength="1" class="pin-input" />
      <input type="password" maxlength="1" class="pin-input" />
    </div>
  </div>
  <div id="error-message"></div>

  <!-- РАЗМЕТКА МЕНЮ -->
  <nav class="navbar" id="success-modal">
    <ul class="navbar__menu">
      <li class="navbar__item" data-levels="A,B,C,D" onclick="openModal('modal1')">
        <a href="#" class="navbar__link">
          <i class="material-symbols-outlined">analytics</i><span>ELABORATION</span>
        </a>
      </li>
      <li class="navbar__item" data-levels="A,B,C,D" onclick="openModal('modal2')">
        <a href="#" class="navbar__link">
          <i class="material-symbols-outlined">finance_mode</i><span>ANALYTICS</span>
        </a>
      </li>
      <li class="navbar__item" data-levels="A,B" onclick="openModal('modal3')">
        <a href="#" class="navbar__link">
          <i class="material-symbols-outlined">data_table</i><span>TASKS</span>
        </a>
      </li>
      <li class="navbar__item" data-levels="A,B" onclick="openModal('modal4')">
        <a href="#" class="navbar__link">
          <i class="material-symbols-outlined">full_stacked_bar_chart</i><span>in_development</span>
        </a>
      </li>
      <li class="navbar__item" data-levels="A,B" onclick="openModal('modal5')">
        <a href="#" class="navbar__link">
          <i class="material-symbols-outlined">full_stacked_bar_chart</i><span>in_development</span>
        </a>
      </li>
    </ul>
  </nav>

  <!-- РАЗМЕТКА модальных окон вызываемых МЕНЮ -->
  <div class="modal" id="modal1">
  <h2>ELABORATION</h2>
  <p>проекты компании</p>
  <!-- Лоадер и контент -->
  <div class="modal-content" id="modal1-content-container">
    <div class="lines-loader" id="modal1-loader">
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
    </div>
    <!-- Здесь будет подгружаемый контент -->
    <div class="modal-content" id="modal1-content"></div>
  </div>
</div>

  <div class="modal" id="modal2">
    <h2>ANALYTICS</h2>
    <p>текущая аналитика</p>
    <!--контейнер для подгружаемого контента modal2-->
    <div class="modal-content" id="modal2-content"></div>
  </div>

  <div class="modal" id="modal3">
    <h2>TASKS</h2>
    <p>проектные задачи</p>
    <!--контейнер для подгружаемого контента modal3-->
    <div class="modal-content" id="modal3-content"></div>
  </div>

  <div class="modal" id="modal4">
    <h2>in_development</h2>
    <p>страница в разработке</p>
    <!--контейнер для подгружаемого контента modal4-->
    <div class="modal-content" id="modal4-content"></div>
  </div>

  <div class="modal" id="modal5">
    <h2>in_development</h2>
    <p>страница в разработке</p>
    <!--контейнер для подгружаемого контента modal5-->
    <div class="modal-content" id="modal5-content"></div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://lhgwxwsawnmstplseokz.supabase.co'; 
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxoZ3d4d3Nhd25tc3RwbHNlb2t6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQzNzkxNDgsImV4cCI6MjA0OTk1NTE0OH0.yfvxLZEdkA2tGmz5ga5uZajT9xN-SbRqpy3t1S3jusA';  
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const pinInputs = document.querySelectorAll('.pin-input');
const errorMessage = document.getElementById('error-message');
const pinWrapper = document.getElementById('pin-wrapper');
const successModal = document.getElementById('success-modal');

let currentUser = null;
let currentModal = null;

// Фокус на первый инпут (без стартового символа)
pinInputs[0].focus();

// Переход к следующему полю при вводе символа
pinInputs.forEach((input, index) => {
  input.addEventListener('input', () => {
    if (input.value.length === 1 && index < pinInputs.length - 1) {
      pinInputs[index+1].focus();
    } else if (index === pinInputs.length - 1 && input.value.length === 1) {
      checkPinCode();
    }
  });

  input.addEventListener('keydown', (e) => {
    if (e.key === 'Backspace' && input.value === '' && index > 0) {
      pinInputs[index-1].focus();
    }
  });
});

async function checkPinCode() {
  const pinCode = Array.from(pinInputs).map(i => i.value).join('');

  const { data, error } = await supabase
    .from('users')
    .select('*')
    .eq('pin_code', pinCode)
    .single();

  if (error || !data) {
    showError("Код авторизации введён неверно");
    clearInputs();
  } else {
    currentUser = data;
    hidePinAndShowMenu(currentUser);
  }
}

function clearInputs() {
  pinInputs.forEach(i => i.value = '');
  pinInputs[0].focus();
}

function showError(msg) {
  errorMessage.textContent = msg;
  errorMessage.style.opacity = '1';
  errorMessage.classList.add('shake');
  setTimeout(() => {
    errorMessage.classList.remove('shake');
    errorMessage.style.opacity = '0';
  }, 1000);
}

function hidePinAndShowMenu(user) {
  pinWrapper.style.opacity = '0';
  pinWrapper.style.transform = 'translateY(20px)';
  setTimeout(() => {
    pinWrapper.style.display = 'none';
    successModal.classList.add('fade-in');
    filterMenuByAccess(user.access_level);
  }, 500);
}

function filterMenuByAccess(accessLevel) {
  const menuItems = successModal.querySelectorAll('.navbar__item');
  menuItems.forEach(item => {
    const levels = item.getAttribute('data-levels');
    if (levels && !levels.split(',').includes(accessLevel)) {
      item.style.display = 'none';
    } else {
      item.style.display = 'list-item';
    }
  });
}

//функция загрузки HTML контента в конкретный контейнер
async function loadModalContent(modalId) {
  const fileName = modalId + '.html';
  const url = `./pages/${fileName}`;
  const loader = document.getElementById(modalId + '-loader');
  const contentDiv = document.getElementById(modalId + '-content');
  const contentContainer = document.getElementById(modalId + '-content-container');

  if (loader && contentDiv && contentContainer) {
    // Показать лоадер
    loader.classList.add('show');
    contentDiv.classList.remove('show');

    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error('Ошибка загрузки контента');
      const html = await response.text();

      // Подставляем HTML в contentDiv
      contentDiv.innerHTML = `<div class="modal1-container">${html}</div>`;

      // Ждем 1.5 секунды, затем скрываем лоадер и показываем контент
      setTimeout(() => {
        // Скрываем лоадер
        loader.classList.remove('show');
        // Через 0.5 секунды после начала скрытия лоадера показываем контент
        setTimeout(() => {
          contentDiv.classList.add('show');
        }, 500);
      }, 1500);

    } catch (e) {
      console.error(e);
      loader.classList.remove('show');
    }
  }
}


// Функции работы с модальными окнами
function fadeInModal(modal) {
  modal.classList.add('show');
  modal.classList.remove('hide');
}

function fadeOutModal(modal, callback) {
  modal.classList.add('hide');
  setTimeout(() => {
    modal.classList.remove('show');
    modal.classList.remove('hide');
    if (callback) callback();
  }, 500);
}

function openModal(modalId) {
  const newModal = document.getElementById(modalId);
  if (!newModal) return;

  if (currentModal && currentModal !== newModal) {
    fadeOutModal(currentModal, () => {
      fadeInModal(newModal);
      //загружаем контент для нового окна
      loadModalContent(modalId);
    });
  } else if (!currentModal) {
    fadeInModal(newModal);
    //загружаем контент для окна
    loadModalContent(modalId);
  }
  currentModal = newModal;
}

// Делаем функции глобально доступными
window.openModal = openModal;
window.fadeInModal = fadeInModal;
window.fadeOutModal = fadeOutModal;
</script>
</body>
</html>
