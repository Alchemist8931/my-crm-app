<!-- /pages/modal2.html -->
<button class="close-modal" onclick="closeModal()">×</button>
<div class="kanban-content" style="justify-content: flex-start;">
  <h2 class="kanban-title">TASK MANAGER</h2>
  <p class="kanban-subtitle">простая канбан-доска</p>

  <!-- Основной контейнер для колонок -->
  <div class="kanban-board">
    <!-- Колонка "Создано" -->
    <div class="kanban-column" data-status="created">
      <h3>Создано</h3>
      <div class="task-list" id="column-created"></div>
    </div>

    <!-- Колонка "В работе" -->
    <div class="kanban-column" data-status="in_progress">
      <h3>В работе</h3>
      <div class="task-list" id="column-in-progress"></div>
    </div>

    <!-- Колонка "Завершено" -->
    <div class="kanban-column" data-status="done">
      <h3>Завершено</h3>
      <div class="task-list" id="column-done"></div>
    </div>
  </div>

  <!--   Кнопка добавления тестовой задачи  -->
  <button id="addTaskBtn" class="add-task-btn">Добавить тестовую задачу</button>
</div>

<!-- Шаблон одной задачи (container) -->
<template id="task-template">
  <div class="task-item">
    <div class="task-title"></div>
  </div>
</template>

<style>
  :root {
    --white-color2: #D1D5D0; 
    --black-color: #121212;
    --borderRadius: 10px;
    --spacer: 1vw;
    --transition: 250ms ease all;
  }

  .close-modal {
    position: absolute;
    top: 1vw;
    right: 1vw;
    background: none;
    border: none;
    font-size: 1.3vw;
    cursor: pointer;
    color: var(--white-color2);
    z-index: 999;
  }
  .close-modal:hover {
    color: red;
  }

  .kanban-content {
    font-family: "Comfortaa", sans-serif;
    color: var(--white-color2);
    background-color: transparent;
    border-radius: var(--borderRadius);
    height: calc(100vh - (var(--spacer)*2));
    width: calc(100vw - (var(--spacer)*6));
    box-sizing: border-box;
    position: relative;
    padding: 1vw;
    display: flex;
    flex-direction: column;
  }

  .kanban-title {
    color: var(--white-color2);
    font-size: 1vw;
    margin-bottom: 0.3vw;
  }

  .kanban-subtitle {
    color: var(--white-color2);
    font-size: 0.6vw;
    margin-bottom: 1vw;
  }

  /* Стили доски */
  .kanban-board {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1vw;
    flex-grow: 1;
    overflow: hidden;
  }

  .kanban-column {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: var(--borderRadius);
    width: 32%;
    min-height: 70%;
    max-height: 100%;
    display: flex;
    flex-direction: column;
    padding: 0.5vw;
    box-sizing: border-box;
  }

  .kanban-column h3 {
    font-size: 0.7vw;
    margin-bottom: 0.5vw;
    text-transform: uppercase;
    color: var(--white-color2);
  }

  .task-list {
    flex-grow: 1;
    overflow-y: auto;
  }
  .task-list::-webkit-scrollbar {
    width: 4px;
  }
  .task-list::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.04);
  }
  .task-list::-webkit-scrollbar-thumb {
    background: var(--white-color2);
    border-radius: 2px;
  }

  .task-item {
    position: relative;
    background: rgba(255, 255, 255, 0.15);
    border-radius: var(--borderRadius);
    padding: 0.5vw;
    margin-bottom: 0.5vw;
    color: #fff;
    transition: all 0.3s ease;
    overflow: hidden;
  }
  .task-title {
    font-size: 0.7vw;
    margin-bottom: 0.3vw;
  }

  /* Кнопка "Добавить тестовую задачу" */
  .add-task-btn {
    height: 1vw;
    width: 8vw;
    position: fixed;
    background-color: transparent;
    cursor: pointer;
    border: 2px solid var(--white-color2);
    border-radius: 10px;
    color: var(--black-color);
    transition: all 0.2s ease-in-out;
    z-index: 5000;
  }
  .add-task-btn:active {
    transform: scale(0.9);
  }
</style>

<script type="module">
  // Предполагаем, что window.supabase уже создан в index.html
  // Пример: const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  // window.supabase = supabase;

  const supabase = window.supabase;

  // Селекторы колонок
  const columnCreated = document.getElementById('column-created');
  const columnInProgress = document.getElementById('column-in-progress');
  const columnDone = document.getElementById('column-done');

  // Кнопка
  const addTaskBtn = document.getElementById('addTaskBtn');

  // Шаблон задачи
  const taskTemplate = document.getElementById('task-template');

  // Сопоставление статусов со столбцами
  const columnMap = {
    created: columnCreated,
    in_progress: columnInProgress,
    done: columnDone
  };

  // Создание DOM-элемента задачи из шаблона
  function createTaskElement(taskData) {
    const taskEl = taskTemplate.content.cloneNode(true).querySelector('.task-item');
    const titleEl = taskEl.querySelector('.task-title');
    // Заполним заголовок задачи
    titleEl.textContent = taskData.title || 'Без названия';
    return taskEl;
  }

  // Загрузка всех задач из Supabase и отображение
  async function loadTasks() {
    console.log("loadTasks called...");
    try {
      const { data, error } = await supabase
        .from('tasks')
        .select('*')
        .order('created_at', { ascending: true });
      
      if (error) throw error;
      console.log("fetch tasks results:", data);

      // Очищаем все колонки
      columnCreated.innerHTML = '';
      columnInProgress.innerHTML = '';
      columnDone.innerHTML = '';

      // Разносим задачи по колонкам
      data.forEach(task => {
        const col = columnMap[task.status];
        if (col) {
          const taskEl = createTaskElement(task);
          col.appendChild(taskEl);
        }
      });
    } catch (err) {
      console.error('Ошибка загрузки задач:', err);
    }
  }

  // Добавление тестовой задачи
  async function addTestTask() {
    console.log('addTestTask clicked!');

    // Создаём новую запись со статусом "created"
    const newTask = {
      title: 'Задача ' + Math.floor(Math.random() * 1000),
      status: 'created'
    };

    try {
      const { data, error } = await supabase
        .from('tasks')
        .insert([newTask])  // передаём массив из одного объекта
        .select();          // вернуть все поля

      console.log('after insert(), data =', data, 'error =', error);

      if (error) {
        throw error;
      }

      // Если запись успешно создалась, отрисуем её в колонке "Создано"
      if (data && data.length > 0) {
        const insertedTask = data[0];
        // Создаём DOM-элемент
        const taskEl = createTaskElement(insertedTask);
        columnCreated.appendChild(taskEl);
      }
    } catch (err) {
      console.error('Ошибка добавления задачи:', err);
    }
  }

  // Инициализация при загрузке
  document.addEventListener('DOMContentLoaded', async () => {
    // Загрузим уже существующие задачи
    await loadTasks();

    // Навесим обработчик на кнопку "Добавить тестовую задачу"
    addTaskBtn.addEventListener('click', addTestTask);
  });
</script>
