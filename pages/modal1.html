<!-- /pages/modal1.html -->
<button class="close-modal" onclick="closeModal()">×</button>
<div class="modal111-content" style="justify-content: flex-start;">
  <h2 class="modal1-title">ELABORATION SALES</h2>
  <p class="modal1-subtitle">проекты в работе</p>
  <!-- Дополнительный контент -->

  <!--    Кнопка для добавления нового проекта    -->
  <button id="add-project-button" style="margin-top: -4.2vw; padding: 0.5vw 1vw; font-size: 0.4vw; cursor: pointer;">Добавить проект</button>

  <!-- модальное окно проектов -->
  <div id="modalBottom" class="modalVNUT" style="top: 4.5vw; left: 6vw; right: 2vw; height: calc(100vh - 6.4vw); width: 99%;">
    <div class="modalVNUT-content" id="projects-container">
      <!-- Контейнеры проектов будут динамически добавляться здесь -->
    </div>
  </div>
</div>


<style>
.close-modal {
    position: absolute;
    top: 0.5vw;
    right: 0.5vw;
    background: none;
    border: none;
    font-size: 1vw;
    cursor: pointer;
    color: var(--white-color2);
  }

  .close-modal:hover {
    color: #393E41;
  }

  .modal111-content {
    font-family: "Comfortaa", sans-serif;
    color: var(--white-color2);
    background-color: none; /* Белый фон для контента */
    border-radius: var(--borderRadius);
    height: calc(100vh - (var(--spacer)*2));
    width: calc(100vw - (var(--spacer)*6));
    box-sizing: border-box;
    position: relative;
    pading: 1vw
  }

  /* Заголовок */
.modal1-title {
  color: var(--white-color2);
  font-size: 0.7vw;
  margin-top: 1vw;
  margin-left: 1vw;
  display: flex
}

/* Подзаголовок */
.modal1-subtitle {
  color: var(--white-color2);
  font-size: 0.45vw;
  margin-top: 0.2vw;
  margin-left: 1vw;
  display: flex
}

  /* Если необходимо выровнять h2 и p внутри flex-контейнера, можно добавить */
.modal1-content h2,
.modal1-content p {
  align-self: flex-start;
  display: flex
}
  
  
  
  /* _______________________________  стили модального окна с прокруткой / скроллом */
  
  /* Модальное окно с прокруткой */
.modalVNUT {
  display: flex;
  position: fixed;
  background: none;
  padding: 0vw;
  border-radius: 0.4vw;
  border: 0px solid rgba(255, 255, 255, 0.18);
  color: black;
  z-index: 1000;
  overflow: hidden; /* Отключаем общий скролл */
  box-sizing: border-box;
}

/* Внутренний контейнер с прокруткой */
.modalVNUT-content {
  padding: 0.5vh 2vh 0vw 0vw; /* Отступы внутри модального окна */
  height: 100%;
  width: 100%;
  overflow-y: auto; /* Включаем вертикальную прокрутку */
  box-sizing: border-box;
}

/* Стилизация скроллбара */
.modalVNUT-content::-webkit-scrollbar {
  width: 4px; /* Ширина скроллбара */
  background-color: var(--scrollbar-color);
}

.modalVNUT-content::-webkit-scrollbar-thumb {
  background-color: var(--scrollbar-thumb-color); /* Цвет ползунка */
  border-radius: 10px; /* Скругление */
}

.modalVNUT-content::-webkit-scrollbar-track {
  background-color: var(--scrollbar-color);
}
  
  /* Внутренний контейнер с прокруткой */
.modalVNUT-content {
  padding: 0.5vh 2vh 0vw 0vw; /* Отступы внутри модального окна */
  height: 100%;
  width: 100%;
  overflow-y: auto; /* Включаем вертикальную прокрутку */
  box-sizing: border-box;
}

/* Стилизация скроллбара */
.modalVNUT-content::-webkit-scrollbar {
  width: 4px; /* Ширина скроллбара */
  background-color: var(--scrollbar-color);
}

.modalVNUT-content::-webkit-scrollbar-thumb {
  background-color: var(--scrollbar-thumb-color); /* Цвет ползунка */
  border-radius: 10px; /* Скругление */
}

.modalVNUT-content::-webkit-scrollbar-track {
  background-color: var(--scrollbar-color);
}



  /* _____________________________________________________________________    Контейнеры внутри модального окна */

  .modal1-container {
    display: flex;
    align-items: center; /* Центрирование по вертикали */
    padding: 0.4vw;
    border-radius: var(--borderRadius);
    color: var(--white-color2);
    z-index: 1100;
    box-sizing: border-box;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.18);
    width: 100%; /* Ширина контейнера остается неизменной */
    height: 2.1vw;
    transform: scale(0.86); /* Уменьшаем все элементы внутри контейнера на 30% */
    transform-origin: top left; /* Сохраняем ширину контейнера */
  }

  .modal1-container:hover,
  .modal1-container:focus {
    border: 1px solid var(--white-color2);
  }

  /* Отступы только между контейнерами */
  .modal1-container:not(:last-child) {
    margin-bottom: 0.5vw; /* Отступ снизу только между контейнерами */
  }

  /* Иконки */
  .modal1-icon {
    color: rgba(255, 255, 255, 0.6);
    font-size: 1.4vw; /* Уменьшено на 30% */
    margin-right: 0.175vw; /* Уменьшено на 30% */
    cursor: pointer;
    display: flex;
    align-items: center; /* Центрирование иконок по вертикали */
  }

  .modal1-icon:hover {
    color: var(--white-color2);
    transform: scale(0.7 * 1.1); /* Увеличение иконки при наведении с учетом масштаба */
  }

  .modal1-icon:active {
    transform: scale(0.7 * 0.92); /* Сжатие иконки при клике с учетом масштаба */
  }

  /* Input группы */
  .modal1-input-group {
    position: relative;
    font-family: "Comfortaa", sans-serif;
  }

  .modal1-input-group.left {
    margin-left: 1.54vw; /* Уменьшено на 30% от 2.2vw */
  }

  .modal1-input-group.right {
    margin-left: 0.28vw; /* Уменьшено на 30% от 0.4vw */
  }

  .modal1-input-group label {
    background: none;
    color: rgba(255, 255, 255, 0.6);
    position: absolute;
    top: 0.61vw; /* Уменьшено на 30% от 0.86vw */
    left: 0.28vw; /* Уменьшено на 30% от 0.4vw */
    transform: translateY(-50%);
    text-transform: uppercase;
    font-weight: 700;
    pointer-events: none;
    font-size: 0.42vw; /* Уменьшено на 30% от 0.6vw */
    transition: all 0.3s;
  }

  .modal1-input-group .modal1-input {
    padding: 0.28vw 0.28vw; /* Уменьшено на 30% от 0.4vw */
    width: 100%;
    border: 1px solid rgba(255, 255, 255, 0.18);
    outline: none;
    color: var(--white-color2);
    font-size: 0.49vw; /* Уменьшено на 30% от 0.7vw */
    font-family: inherit;
    background-color: transparent;
    border-radius: 7px; /* Уменьшено на 30% от 10px → 7px */
  }

  .modal1-input-group .modal1-input:hover,
  .modal1-input-group .modal1-input:focus {
    border: 1px solid var(--white-color2);
  }

  .modal1-input-group .modal1-input:focus + label,
  .modal1-input-group .modal1-input:not(:placeholder-shown) + label {
    top: -0.06vw; /* Уменьшено на 30% от -0.5vw */
    font-size: 0.28vw; /* Уменьшено на 30% от 0.4vw */
    padding: 0 0.28vw; /* Уменьшено на 30% от 0.4vw */
    background: rgba(0, 0, 0, 0.5);
    border-radius: 7px; /* Уменьшено на 30% от 10px → 7px */
    color: var(--white-color2);
  }

  /* Input заголовок без границ */
  .modal1-input-TYPE1 {
    position: relative;
    font-family: "Comfortaa", sans-serif;
    width: 1.4vw; /* Уменьшено на 30% от 2vw */
    border: none;
    outline: none;
    color: rgba(255, 255, 255, 0.6);
    background-color: transparent;
    margin-top: 0.7vw; /* Уменьшено на 30% от 1vw */
  }

  /* Иконки внутри контейнера */
  .modal1-icon {
    color: rgba(255, 255, 255, 0.6);
    font-size: 1.4vw; /* Уменьшено на 30% от 2vw */
    margin-right: 0.175vw; /* Уменьшено на 30% от 0.25vw */
    cursor: pointer;
    display: flex;
    align-items: center; /* Центрирование иконок по вертикали */
  }

  .modal1-icon:hover {
    color: var(--white-color2);
    transform: scale(1.1); /* Увеличение иконки при наведении */
  }

  .modal1-icon:active {
    transform: scale(0.92); /* Сжатие иконки при клике */
  }





    /* Дополнительные стили для кнопки добавления проекта */
  #add-project-button {
    background-color: var(--white-color2);
    color: var(--black-color);
    border: none;
    border-radius: 5px;
    transition: background-color 0.3s;
  }

  #add-project-button:hover {
    background-color: var(--white-color1);
  }
  
  
</style>

<script type="module">
  const supabase = window.supabase;
  const projectsContainer = document.getElementById('projects-container');
  const addProjectButton = document.getElementById('add-project-button');
  let allProjects = [];
  const visibleProjects = new Set();

  // Генерация уникального project_id
  const generateProjectID = () => 'proj_' + Math.random().toString(36).substr(2, 9);

  // Создание HTML-контейнера для проекта
  function createProjectContainer(project) {
    const container = document.createElement('div');
    container.classList.add('modal1-container');
    container.dataset.id = project.id;
    container.style.opacity = '0';

    container.innerHTML = `
  <!-- Иконка для удаления проекта -->
  <span class="modal1-icon" data-action="delete" data-id="${project.id}">
    <i class="material-symbols-outlined">delete</i>
  </span>
  
  <!-- Иконка для редактирования проекта -->
  <span class="modal1-icon" data-action="edit" data-id="${project.id}">
    <i class="material-symbols-outlined">edit</i>
  </span>
  
  <!-- Группа ввода для имени проекта -->
  <div class="modal1-input-group left">
    <input 
      type="text" 
      class="modal1-input" 
      id="project-name-${project.id}" 
      value="${project.project_name}" 
      placeholder=" " 
      data-field="project_name"
    />
    <label for="project-name-${project.id}">Project Name</label>
  </div>

  <!-- Группа ввода для статуса проекта -->
  <div class="modal1-input-group right">
    <input 
      type="text" 
      class="modal1-input" 
      id="project-status-${project.id}" 
      value="${project.status || ''}" 
      placeholder=" " 
      data-field="status"
    />
    <label for="project-status-${project.id}">Status</label>
  </div>

  <!-- Группа ввода для суммы контракта -->
  <div class="modal1-input-group left">
    <input 
      type="number" 
      step="0.01" 
      class="modal1-input" 
      id="project-contract-amount-${project.id}" 
      value="${project.contract_amount || ''}" 
      placeholder=" " 
      data-field="contract_amount"
    />
    <label for="project-contract-amount-${project.id}">Contract Amount</label>
  </div>

  <!-- Группа ввода для стоимости контракта -->
  <div class="modal1-input-group right">
    <input 
      type="number" 
      step="0.01" 
      class="modal1-input" 
      id="project-contract-cost-${project.id}" 
      value="${project.contract_cost || ''}" 
      placeholder=" " 
      data-field="contract_cost"
    />
    <label for="project-contract-cost-${project.id}">Contract Cost</label>
  </div>

  <!-- Группа ввода для прибыли проекта -->
  <div class="modal1-input-group left">
    <input 
      type="number" 
      step="0.01" 
      class="modal1-input" 
      id="project-profit-${project.id}" 
      value="${project.profit || ''}" 
      placeholder=" " 
      data-field="profit"
    />
    <label for="project-profit-${project.id}">Profit</label>
  </div>

  <!-- Группа ввода для процента прибыли -->
  <div class="modal1-input-group right">
    <input 
      type="number" 
      step="0.01" 
      class="modal1-input" 
      id="project-profit-percentage-${project.id}" 
      value="${project.profit_percentage || ''}" 
      placeholder=" " 
      data-field="profit_percentage"
    />
    <label for="project-profit-percentage-${project.id}">Profit %</label>
  </div>

  <!-- Группа ввода для компании-продавца -->
  <div class="modal1-input-group left">
    <input 
      type="text" 
      class="modal1-input" 
      id="project-company-seller-${project.id}" 
      value="${project.company_seller || ''}" 
      placeholder=" " 
      data-field="company_seller"
    />
    <label for="project-company-seller-${project.id}">Company Seller</label>
  </div>

  <!-- Группа ввода для ИНН продавца -->
  <div class="modal1-input-group right">
    <input 
      type="text" 
      class="modal1-input" 
      id="project-tin-seller-${project.id}" 
      value="${project.tin_seller || ''}" 
      placeholder=" " 
      data-field="tin_seller"
    />
    <label for="project-tin-seller-${project.id}">TIN Seller</label>
  </div>

  <!-- Группа ввода для компании-покупателя -->
  <div class="modal1-input-group left">
    <input 
      type="text" 
      class="modal1-input" 
      id="project-company-buyer-${project.id}" 
      value="${project.buyer_company || ''}" 
      placeholder=" " 
      data-field="buyer_company"
    />
    <label for="project-company-buyer-${project.id}">Company Buyer</label>
  </div>

  <!-- Группа ввода для ИНН покупателя -->
  <div class="modal1-input-group right">
    <input 
      type="text" 
      class="modal1-input" 
      id="project-tin-buyer-${project.id}" 
      value="${project.tin_buyer || ''}" 
      placeholder=" " 
      data-field="tin_buyer"
    />
    <label for="project-tin-buyer-${project.id}">TIN Buyer</label>
  </div>
`;
    return container;
  }

  // Динамическое управление отображением проектов
  function initializeObserver() {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        const projectId = entry.target.dataset.id;
        if (entry.isIntersecting) {
          if (!visibleProjects.has(projectId)) {
            visibleProjects.add(projectId);
            entry.target.style.transition = 'opacity 0.3s';
            entry.target.style.opacity = '1';
          }
        } else {
          visibleProjects.delete(projectId);
          entry.target.style.transition = 'opacity 0.3s';
          entry.target.style.opacity = '0';
        }
      });
    }, { root: projectsContainer, threshold: 0.1 });

    allProjects.forEach((project) => {
      const projectElement = createProjectContainer(project);
      projectsContainer.appendChild(projectElement);
      observer.observe(projectElement);
    });
  }

  // Загрузка проектов из базы
  async function loadProjects() {
    const { data, error } = await supabase.from('projects').select('*');
    if (error) {
      console.error('Ошибка загрузки проектов:', error);
      return;
    }
    allProjects = data;
    initializeObserver();
  }

  // Добавление нового проекта
  async function addNewProject() {
    const newProject = {
      project_id: generateProjectID(),
      project_name: 'Новый проект',
    };
    const { error } = await supabase.from('projects').insert([newProject]);
    if (error) console.error('Ошибка добавления проекта:', error);
  }

  // Делегирование событий
  projectsContainer.addEventListener('click', (event) => {
    const icon = event.target.closest('.modal1-icon');
    if (icon) {
      const action = icon.dataset.action;
      const projectId = icon.dataset.id;
      if (action === 'delete') deleteProject(projectId);
    }
  });

  // Удаление проекта
  async function deleteProject(projectId) {
    const { error } = await supabase.from('projects').delete().eq('id', projectId);
    if (error) console.error('Ошибка удаления проекта:', error);
  }

  // Подписка на изменения в реальном времени
  function setupRealtime() {
    const channel = supabase
      .channel('realtime_projects')
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'projects' },
        (payload) => {
          const projectId = payload.new?.id || payload.old?.id;
          if (!projectId) return;

          if (payload.eventType === 'INSERT') {
            const newProject = createProjectContainer(payload.new);
            projectsContainer.appendChild(newProject);
          } else if (payload.eventType === 'DELETE') {
            const existingElement = projectsContainer.querySelector(`[data-id="${projectId}"]`);
            if (existingElement) projectsContainer.removeChild(existingElement);
          }
        }
      )
      .subscribe();
  }

  // Инициализация
  loadProjects();
  setupRealtime();
  addProjectButton.addEventListener('click', addNewProject);
</script>
