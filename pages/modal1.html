<!-- /pages/modal1.html -->
<button class="close-modal" onclick="closeModal()">×</button>
<div class="modal111-content" style="justify-content: flex-start;">
  <h2 class="modal1-title">ELABORATION SALES</h2>
  <p class="modal1-subtitle">проекты в работе</p>
  <button id="add-project-button" class="button-D" style="top: 2vw; left: 24vw;"> 
    <span class="btn-txt">new project</span>
  </button> 

  <div id="modalBottom" class="modalVNUT" style="top: 5.5vw; left: 6vw; right: 2vw; height: calc(100vh - 7.4vw); width: 99%;">
    <div class="modalVNUT-content" id="projects-container">
      <!-- Блоки проектов будут динамически добавляться здесь -->
    </div>
  </div>
</div>

<!-- Модальное окно редактирования проекта -->
<div id="editModal" class="edit-modal hidden">
  <div class="edit-modal-content">
    <button class="close-edit-modal">×</button>
    <h3>Редактирование проекта</h3>
    <form id="edit-form">
      <!-- Название проекта -->
      <label for="edit-project-name">Название проекта</label>
      <input type="text" id="edit-project-name" placeholder="Введите название проекта" required />

      <!-- Статус проекта -->
      <label for="edit-status">Статус</label>
      <input type="text" id="edit-status" placeholder="Введите статус проекта" required />

      <!-- Сумма контракта -->
      <label for="edit-contract-amount">Сумма контракта</label>
      <input type="number" id="edit-contract-amount" step="0.01" placeholder="Введите сумму контракта" required />

      <!-- Стоимость контракта -->
      <label for="edit-contract-cost">Стоимость контракта</label>
      <input type="number" id="edit-contract-cost" step="0.01" placeholder="Введите стоимость контракта" />

      <!-- Прибыль -->
      <label for="edit-contract-profit">Прибыль</label>
      <input type="number" id="edit-contract-profit" step="0.01" placeholder="Введите прибыль" />

      <!-- Процент прибыли -->
      <label for="edit-profit-percentage">Процент прибыли</label>
      <input type="number" id="edit-profit-percentage" step="0.01" placeholder="Введите процент прибыли" />

      <!-- Компания-продавец -->
      <label for="edit-company-seller">Компания-продавец</label>
      <input type="text" id="edit-company-seller" placeholder="Введите название компании-продавца" />

      <!-- ИНН продавца -->
      <label for="edit-tin-seller">ИНН продавца</label>
      <input type="text" id="edit-tin-seller" placeholder="Введите ИНН продавца" />

      <!-- Компания-покупатель -->
      <label for="edit-buyer-company">Компания-покупатель</label>
      <input type="text" id="edit-buyer-company" placeholder="Введите название компании-покупателя" />

      <!-- ИНН покупателя -->
      <label for="edit-tin-buyer">ИНН покупателя</label>
      <input type="text" id="edit-tin-buyer" placeholder="Введите ИНН покупателя" />

      <!-- Кнопка для сохранения изменений -->
      <button type="button" class="save-button">Сохранить</button>
    </form>
  </div>
</div>

<!-- Модальное окно редактирования спецификации -->
<div id="editSpecModal" class="edit-modal hidden">
  <div class="edit-modal-content">
    <button class="close-edit-spec-modal">×</button>
    <h3>Редактирование спецификации</h3>
    <form id="edit-spec-form">
      <!-- Название спецификации -->
      <label for="edit-spec-name">Название спецификации</label>
      <input type="text" id="edit-spec-name" placeholder="Например: «Spec #1»" required />

      <!-- Статус -->
      <label for="edit-spec-status">Статус</label>
      <input type="text" id="edit-spec-status" placeholder="draft / active / closed" required />

      <!-- Сумма -->
      <label for="edit-spec-amount">Сумма</label>
      <input type="number" id="edit-spec-amount" step="0.01" placeholder="Введите сумму" />

      <!-- Стоимость -->
      <label for="edit-spec-costs">Стоимость</label>
      <input type="number" id="edit-spec-costs" step="0.01" placeholder="Введите стоимость" />

      <!-- Прибыль -->
      <label for="edit-spec-profit">Прибыль</label>
      <input type="number" id="edit-spec-profit" step="0.01" placeholder="Введите прибыль" />

      <!-- Процент прибыли -->
      <label for="edit-spec-profit-pct">Процент прибыли</label>
      <input type="number" id="edit-spec-profit-pct" step="0.01" placeholder="%" />

      <!-- Ответственный -->
      <label for="edit-spec-responsible">Ответственный</label>
      <input type="text" id="edit-spec-responsible" placeholder="ФИО / отдел" />

      <!-- Кнопка для сохранения изменений спецификации -->
      <button type="button" class="save-spec-button">Сохранить</button>
    </form>
  </div>
</div>

<!-- Шаблон для проекта -->
<template id="project-template">
  <!-- Обёртка проекта: содержит сам контейнер сделки и ниже блок спецификаций -->
  <div class="project-block">
    <div class="modal1-container" data-id="">
      <!-- Иконка Редактировать -->
      <span class="modal1-icon" style="left: 1vw;" data-action="edit" data-id="">
        <i class="material-symbols-outlined">receipt</i>
      </span>
      <!-- Иконка Создать спецификацию -->
      <span class="modal1-icon" style="left: 1vw;" data-action="new-specificstion" data-id="">
        <i class="material-symbols-outlined">stat_minus_2</i>
      </span>

      <!-- Project ID -->
      <div class="modal1-input-group left">
        <input type="text" class="modal1-input" placeholder=" " data-field="project_id" readonly />
        <label>Project ID</label>
      </div>

      <!-- Project Name -->
      <div class="modal1-input-group right">
        <input type="text" class="modal1-input" placeholder=" " data-field="project_name" readonly />
        <label>Project Name</label>
      </div>

      <!-- Status -->
      <div class="modal1-input-group right">
        <input type="text" class="modal1-input" placeholder=" " data-field="status" readonly />
        <label>Status</label>
      </div>

      <!-- Contract Amount -->
      <div class="modal1-input-group left">
        <input type="number" step="0.01" class="modal1-input" placeholder=" " data-field="contract_amount" readonly />
        <label>Contract Amount</label>
      </div>

      <!-- Contract Costs -->
      <div class="modal1-input-group right">
        <input type="number" step="0.01" class="modal1-input" placeholder=" " data-field="contract_costs" readonly />
        <label>Contract Costs</label>
      </div>

      <!-- Contract Profit -->
      <div class="modal1-input-group right">
        <input type="number" step="0.01" class="modal1-input" placeholder=" " data-field="contract_profit" readonly />
        <label>Contract Profit</label>
      </div>

      <!-- Profit % -->
      <div class="modal1-input-group right">
        <input type="number" step="0.01" class="modal1-input" style="width: 2.6vw;" placeholder=" " data-field="profit_percentage" readonly />
        <label>Profit %</label>
      </div>

      <!-- Company Seller -->
      <div class="modal1-input-group left">
        <input type="text" class="modal1-input" placeholder=" " data-field="company_seller" readonly />
        <label>Company Seller</label>
      </div>

      <!-- TIN Seller -->
      <div class="modal1-input-group right">
        <input type="text" class="modal1-input" placeholder=" " data-field="tin_seller" readonly />
        <label>TIN Seller</label>
      </div>

      <!-- Buyer Company -->
      <div class="modal1-input-group left">
        <input type="text" class="modal1-input" placeholder=" " data-field="buyer_company" readonly />
        <label>Buyer Company</label>
      </div>

      <!-- TIN Buyer -->
      <div class="modal1-input-group right">
        <input type="text" class="modal1-input" placeholder=" " data-field="tin_buyer" readonly />
        <label>TIN Buyer</label>
      </div>

      <!-- Иконка Удалить -->
      <span class="modal1-icon" style="margin-left: 6vw; right: 1vw;" data-action="delete" data-id="">
        <i class="material-symbols-outlined">delete</i>
      </span>
    </div>

    <!-- Блок для спецификаций - отдельный, чтобы не растягивать родителя -->
    <div class="specifications-wrapper"></div>
  </div>
</template>

<!-- Шаблон для спецификации -->
<template id="specification-template">
  <div class="spec-container" data-spec-id="">
    <!-- Иконка Редактировать спецификацию -->
    <span class="spec-icon" data-action="edit-spec" data-spec-id="">
      <i class="material-symbols-outlined">edit_note</i>
    </span>
    <!-- Specification Name -->
    <div class="modal1-input-group left">
      <input type="text" class="modal1-input" placeholder=" " data-field="specification_name" readonly />
      <label>Spec Name</label>
    </div>
    <!-- Status -->
    <div class="modal1-input-group right">
      <input type="text" class="modal1-input" placeholder=" " data-field="status" readonly />
      <label>Status</label>
    </div>
    <!-- Amount -->
    <div class="modal1-input-group left">
      <input type="number" step="0.01" class="modal1-input" placeholder=" " data-field="specification_amount" readonly />
      <label>Amount</label>
    </div>
    <!-- Costs -->
    <div class="modal1-input-group right">
      <input type="number" step="0.01" class="modal1-input" placeholder=" " data-field="specification_costs" readonly />
      <label>Costs</label>
    </div>
    <!-- Profit -->
    <div class="modal1-input-group right">
      <input type="number" step="0.01" class="modal1-input" placeholder=" " data-field="specification_profit" readonly />
      <label>Profit</label>
    </div>
    <!-- Profit % -->
    <div class="modal1-input-group right">
      <input type="number" step="0.01" class="modal1-input" style="width: 2.6vw;" placeholder=" " data-field="profit_percentage" readonly />
      <label>Profit %</label>
    </div>
    <!-- Responsible -->
    <div class="modal1-input-group left">
      <input type="text" class="modal1-input" placeholder=" " data-field="responsible" readonly />
      <label>Responsible</label>
    </div>
    <!-- Иконка Удалить спецификацию -->
    <span class="spec-icon" data-action="delete-spec" data-spec-id="">
      <i class="material-symbols-outlined">delete</i>
    </span>
  </div>
</template>

<!-- Оверлей-загрузчик (появляется при удалении) -->
<div class="overlay hidden" id="delete-overlay">
  <div class="loader">
    <label>Удаление записи из базы данных...</label>
    <div class="loading"></div>
  </div>
</div>

<style>
:root {
  --scrollbar-color: rgba(255, 255, 255, 0.04); 
  --scrollbar-thumb-color: #D1D5D0; 
  --scroll-y-position: 10%;
  --reflection-y-position: 50%;
  
  --borderRadius: 0.4vw;
  --spacer: 1vw; 
}

/* Закрыть главное модальное окно */
.close-modal {
  position: absolute;
  top: 1vw;
  right: 1vw;
  background: none;
  border: none;
  font-size: 1vw;
  cursor: pointer;
  color: var(--white-color2);
}
.close-modal:hover {
  color: #393E41;
}

.modal111-content {
  font-family: "Comfortaa", sans-serif;
  color: var(--white-color2);
  background-color: none;
  border-radius: var(--borderRadius);
  height: calc(100vh - (var(--spacer)*2));
  width: calc(100vw - (var(--spacer)*6));
  box-sizing: border-box;
  position: relative;
  padding: 1vw;
}

/* Заголовок и подзаголовок */
.modal1-title {
  color: var(--white-color2);
  font-size: 0.7vw;
  margin-top: 0vw;
  margin-left: 0vw;
  display: flex
}
.modal1-subtitle {
  color: var(--white-color2);
  font-size: 0.45vw;
  margin-top: 0.2vw;
  margin-left: 0vw;
  display: flex
}

/* Модальное окно с прокруткой */
.modalVNUT {
  display: flex;
  position: fixed;
  background: none;
  padding: 0vw;
  border-radius: 0.4vw;
  border: 0px solid rgba(255, 255, 255, 0.18);
  color: black;
  z-index: 1000;
  overflow: hidden;
  box-sizing: border-box;
}
.modalVNUT-content {
  padding: 0.5vh 2vh 0vw 0vw;
  height: 100%;
  width: 92vw;
  overflow-y: scroll;
  box-sizing: border-box;
}
.modalVNUT-content::-webkit-scrollbar {
  width: 4px;
  background-color: var(--scrollbar-color);
}
.modalVNUT-content::-webkit-scrollbar-thumb {
  background-color: var(--scrollbar-thumb-color);
  border-radius: 10px;
}
.modalVNUT-content::-webkit-scrollbar-track {
  background-color: var(--scrollbar-color);
}

/* Обёртка каждого проекта + спецификаций */
.project-block {
  margin-bottom: 1vw;
}

/* Родительский контейнер (сделка) */
.modal1-container {
  display: flex;
  align-items: center;
  padding: 0.4vw;
  border-radius: var(--borderRadius);
  color: var(--white-color2);
  z-index: 1100;
  box-sizing: border-box;
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.18);
  width: 90.5vw;
  height: 2.1vw;
  transform-origin: top left;
  position: relative;
}
.modal1-container:hover,
.modal1-container:focus {
  border: 1px solid var(--white-color2);
}

/* Иконки (редактировать/удалить/новая спецификация) */
.modal1-icon {
  color: rgba(255, 255, 255, 0.6);
  font-size: 0.7vw;
  margin-right: 0.5vw;
  cursor: pointer;
  display: flex;
  align-items: center;
  position: relative;
}
.modal1-icon:hover {
  color: var(--white-color2);
  transform: scale(1.1);
}
.modal1-icon:active {
  transform: scale(0.92);
}

/* Блок спецификаций */
.specifications-wrapper {
  display: flex;
  flex-direction: column;
  width: 100%;
  margin-top: 0.5vw;
}

/* Дочерний контейнер (спецификация) */
.spec-container {
  display: flex;
  align-items: center;
  padding: 0.4vw;
  border-radius: var(--borderRadius);
  color: var(--white-color2);
  z-index: 1100;
  box-sizing: border-box;
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.18);
  width: 68vw; /* 25% уже родителя */
  height: 2.1vw;
  margin-left: 5vw;
  margin-top: 0.5vw;
  position: relative;
}

/* Иконки спецификации (редактировать/удалить) */
.spec-icon {
  color: rgba(255, 255, 255, 0.6);
  font-size: 0.7vw;
  margin-right: 0.5vw;
  cursor: pointer;
  display: flex;
  align-items: center;
  position: relative;
}
.spec-icon:hover {
  color: var(--white-color2);
  transform: scale(1.1);
}
.spec-icon:active {
  transform: scale(0.92);
}

/* Группы инпутов */
.modal1-input-group {
  position: relative;
  font-family: "Comfortaa", sans-serif;
}
.modal1-input-group.left {
  margin-left: 3vw;
}
.modal1-input-group.right {
  margin-left: 0.4vw;
}
.modal1-input-group label {
  background: none;
  color: rgba(255, 255, 255, 0.6);
  position: absolute;
  top: 0.61vw;
  left: 0.28vw;
  transform: translateY(-50%);
  text-transform: uppercase;
  font-weight: 700;
  pointer-events: none;
  font-size: 0.42vw;
  transition: all 0.3s;
}
.modal1-input-group .modal1-input {
  padding: 0.28vw 0.28vw; 
  width: 100%;
  border: 1px solid rgba(255, 255, 255, 0.18);
  outline: none;
  color: var(--white-color2);
  font-size: 0.49vw; 
  font-family: inherit;
  background-color: transparent;
  border-radius: 7px; 
}
.modal1-input-group .modal1-input:hover,
.modal1-input-group .modal1-input:focus {
  border: 1px solid var(--white-color2);
}
.modal1-input-group .modal1-input:focus + label,
.modal1-input-group .modal1-input:not(:placeholder-shown) + label {
  top: -0.2vw;
  font-size: 0.28vw;
  padding: 0 0.28vw;
  background: none;
  border-radius: 7px; 
  color: var(--white-color2);
}

/* Кнопка добавления проекта */
#add-project-button {
  background-color: var(--white-color2);
  color: var(--black-color);
  border: none;
  border-radius: 5px;
  transition: background-color 0.3s;
}
#add-project-button:hover {
  background-color: var(--white-color1);
}

/* Стили модального окна редактирования (общие) */
.edit-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(15px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1100;
}
.edit-modal.hidden {
  display: none;
}
.edit-modal-content {
  background: white;
  padding: 2rem;
  border-radius: 10px;
  width: 50%;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
}
.close-edit-modal,
.close-edit-spec-modal {
  position: absolute;
  top: 1vw;
  right: 1vw;
  background: none;
  border: none;
  font-size: 0.7vw;
  cursor: pointer;
}
.close-edit-modal:hover,
.close-edit-spec-modal:hover {
  color: red;
}

/* Кнопка add project */
.button-D {
  height: 1vw;
  width: 8vw;
  position: fixed;
  background-color: transparent;
  cursor: pointer;
  border: 2px solid var(--white-color2);
  overflow: hidden;
  border-radius: 10px;
  color: var(--black-color);
  transition: all 0.2s ease-in-out;
}
.btn-txt {
  z-index: 1;
  font-weight: 800;
  letter-spacing: 2px;
  text-transform: uppercase;
  font-size: 0.5vw;
}
.button-D:active {
  transform: scale(0.9);
  background-color: var(--white-color1);
}

/* ------------------------------------
   Overlay (loader) стили 
------------------------------------- */
.overlay {
  position: fixed;
  top: 0; 
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.4);
  z-index: 9999; /* выше всего */
  display: flex;
  justify-content: center;
  align-items: center;
}
.overlay.hidden {
  display: none;
}

/* Стили loader (из вашего примера) */
.loader {
  width: 350px;
  height: 180px;
  border-radius: 10px;
  background: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-evenly;
  padding: 30px;
  box-shadow: 2px 2px 10px -5px lightgrey;
}
.loading {
  width: 100%;
  height: 10px;
  background: lightgrey;
  border-radius: 10px;
  position: relative;
}
.loading::after {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 50%;
  height: 10px;
  background: #002;
  border-radius: 10px;
  z-index: 1;
  animation: loading 0.6s alternate infinite;
}
.loader > label {
  color: #002;
  font-size: 18px;
  animation: bit 0.6s alternate infinite;
}

@keyframes bit {
  from {
    opacity: 0.3;
  }
  to {
    opacity: 1;
  }
}

@keyframes loading {
  0% {
    left: 0%;
  }
  100% {
    left: 50%;
  }
}

</style>

<script type="module">
// Инициализация Supabase (предполагаем, что window.supabase уже инициализирован)
const supabase = window.supabase;

// Локальные переменные
const projectsContainer = document.getElementById('projects-container');
const addProjectButton = document.getElementById('add-project-button');

// Модалки редактирования
const editModal = document.getElementById('editModal');
const editForm = document.getElementById('edit-form');
const editSpecModal = document.getElementById('editSpecModal');
const editSpecForm = document.getElementById('edit-spec-form');

// Оверлей-загрузчик
const deleteOverlay = document.getElementById('delete-overlay');

// Текущее редактируемое
let currentEditingProject = null;
let currentEditingSpec = null;

/**********************/
/* ФУНКЦИИ ПОКАЗ/СКРЫТЬ LOADER */
function showLoader() {
  deleteOverlay.classList.remove('hidden');
}
function hideLoader() {
  deleteOverlay.classList.add('hidden');
}

/**********************/
/* ГЕНЕРАЦИЯ ID-шников */
function generateProjectID() {
  return 'proj_' + Math.random().toString(36).substr(2, 9);
}
function generateSpecificationID() {
  return 'spec_' + Math.random().toString(36).substr(2, 9);
}

/**********************/
/*   ШАБЛОНЫ/ОТРИСОВКА */

// Создать DOM для проекта
function createProjectContainer(project) {
  if (!project || !project.project_id) {
    console.error('[LOG] Некорректные данные проекта:', project);
    return null;
  }
  const template = document.getElementById('project-template');
  if (!template) {
    console.error('[LOG] Шаблон project-template не найден.');
    return null;
  }
  const clone = template.content.cloneNode(true);
  const block = clone.querySelector('.project-block'); 
  const container = block.querySelector('.modal1-container'); 

  container.dataset.id = project.project_id;

  // Иконки
  const editIcon = container.querySelector('[data-action="edit"]');
  const deleteIcon = container.querySelector('[data-action="delete"]');
  const newSpecIcon = container.querySelector('[data-action="new-specificstion"]');
  if (editIcon) editIcon.dataset.id = project.project_id;
  if (deleteIcon) deleteIcon.dataset.id = project.project_id;
  if (newSpecIcon) newSpecIcon.dataset.id = project.project_id;

  // Сохраняем данные в data-атрибутах
  container.dataset.projectName = project.project_name || '';
  container.dataset.status = project.status || '';
  container.dataset.contractAmount = project.contract_amount || 0;
  container.dataset.contractCosts = project.contract_costs || 0;
  container.dataset.contractProfit = project.contract_profit || 0;
  container.dataset.profitPercentage = project.profit_percentage || 0;
  container.dataset.companySeller = project.company_seller || '';
  container.dataset.tinSeller = project.tin_seller || '';
  container.dataset.buyerCompany = project.buyer_company || '';
  container.dataset.tinBuyer = project.tin_buyer || '';

  // Заполняем поля (readonly)
  container.querySelector('[data-field="project_id"]').value = project.project_id;
  container.querySelector('[data-field="project_name"]').value = project.project_name || '';
  container.querySelector('[data-field="status"]').value = project.status || '';
  container.querySelector('[data-field="contract_amount"]').value = project.contract_amount || 0;
  container.querySelector('[data-field="contract_costs"]').value = project.contract_costs || 0;
  container.querySelector('[data-field="contract_profit"]').value = project.contract_profit || 0;
  container.querySelector('[data-field="profit_percentage"]').value = project.profit_percentage || 0;
  container.querySelector('[data-field="company_seller"]').value = project.company_seller || '';
  container.querySelector('[data-field="tin_seller"]').value = project.tin_seller || '';
  container.querySelector('[data-field="buyer_company"]').value = project.buyer_company || '';
  container.querySelector('[data-field="tin_buyer"]').value = project.tin_buyer || '';

  return block;
}

// Создать DOM для спецификации
function createSpecificationContainer(spec) {
  if (!spec || !spec.specification_id) {
    console.error('[LOG] Некорректные данные спецификации:', spec);
    return null;
  }
  const template = document.getElementById('specification-template');
  if (!template) {
    console.error('[LOG] Шаблон specification-template не найден.');
    return null;
  }
  const clone = template.content.cloneNode(true);
  const specContainer = clone.querySelector('.spec-container');

  specContainer.dataset.specId = spec.specification_id;
  specContainer.dataset.projectId = spec.project_id;

  // Иконки
  const editSpecIcon = specContainer.querySelector('[data-action="edit-spec"]');
  const deleteSpecIcon = specContainer.querySelector('[data-action="delete-spec"]');
  if (editSpecIcon) editSpecIcon.dataset.specId = spec.specification_id;
  if (deleteSpecIcon) deleteSpecIcon.dataset.specId = spec.specification_id;

  // Сохраняем данные в data-атрибутах
  specContainer.dataset.specificationName = spec.specification_name || '';
  specContainer.dataset.status = spec.status || '';
  specContainer.dataset.specificationAmount = spec.specification_amount || 0;
  specContainer.dataset.specificationCosts = spec.specification_costs || 0;
  specContainer.dataset.specificationProfit = spec.specification_profit || 0;
  specContainer.dataset.profitPercentage = spec.profit_percentage || 0;
  specContainer.dataset.responsible = spec.responsible || '';

  // Заполняем поля (readonly)
  specContainer.querySelector('[data-field="specification_name"]').value = spec.specification_name || '';
  specContainer.querySelector('[data-field="status"]').value = spec.status || '';
  specContainer.querySelector('[data-field="specification_amount"]').value = spec.specification_amount || 0;
  specContainer.querySelector('[data-field="specification_costs"]').value = spec.specification_costs || 0;
  specContainer.querySelector('[data-field="specification_profit"]').value = spec.specification_profit || 0;
  specContainer.querySelector('[data-field="profit_percentage"]').value = spec.profit_percentage || 0;
  specContainer.querySelector('[data-field="responsible"]').value = spec.responsible || '';

  return specContainer;
}

/**********************/
/*      ЗАГРУЗКА ДАННЫХ */

async function loadProjects() {
  console.log('[LOG] Загрузка списка проектов...');
  const { data, error } = await supabase.from('projects').select('*');
  if (error) {
    console.error('[LOG] Ошибка загрузки проектов:', error);
    return;
  }
  console.log('[LOG] Загружено проектов:', data?.length || 0);

  projectsContainer.innerHTML = '';
  const fragment = document.createDocumentFragment();
  data.forEach((project) => {
    const projectBlock = createProjectContainer(project);
    if (projectBlock) {
      fragment.appendChild(projectBlock);
    }
  });
  projectsContainer.appendChild(fragment);
}

async function loadSpecifications() {
  console.log('[LOG] Загрузка списка спецификаций...');
  const { data, error } = await supabase.from('specifications').select('*');
  if (error) {
    console.error('[LOG] Ошибка загрузки спецификаций:', error);
    return;
  }
  console.log('[LOG] Загружено спецификаций:', data?.length || 0);
  data.forEach((spec) => {
    const projectContainer = projectsContainer.querySelector(`[data-id="${spec.project_id}"]`);
    if (projectContainer) {
      const projectBlock = projectContainer.closest('.project-block');
      const specsWrapper = projectBlock.querySelector('.specifications-wrapper');
      if (specsWrapper) {
        const specElem = createSpecificationContainer(spec);
        if (specElem) {
          specsWrapper.appendChild(specElem);
        }
      }
    }
  });
}

/**********************/
/*    ДОБАВЛЕНИЕ ЗАПИСЕЙ */

async function addNewProject() {
  const newProject = {
    project_id: generateProjectID(),
    project_name: 'Новый проект',
    status: 'Новый',
    contract_amount: 0.00,
    contract_costs: 0.00,
    contract_profit: 0.00,
    profit_percentage: 0.00,
    company_seller: '',
    tin_seller: '',
    buyer_company: '',
    tin_buyer: '',
  };
  console.log('[LOG] Создаём новый проект:', newProject);
  const { error } = await supabase
    .from('projects')
    .insert([newProject]);

  if (error) {
    console.error('[LOG] Ошибка добавления проекта:', error);
  }
}

async function addNewSpecification(projectId) {
  const newSpec = {
    specification_id: generateSpecificationID(),
    project_id: projectId,
    specification_name: 'New spec',
    status: 'draft',
    specification_amount: 0.00,
    specification_costs: 0.00,
    specification_profit: 0.00,
    profit_percentage: 0.00,
    responsible: '',
  };
  console.log('[LOG] Создаём новую спецификацию:', newSpec);
  const { error } = await supabase
    .from('specifications')
    .insert([newSpec]);

  if (error) {
    console.error('[LOG] Ошибка добавления спецификации:', error);
  }
}

/**********************/
/*   УДАЛЕНИЕ / ПРОЕКТ */

async function deleteProject(projectId) {
  console.log('[LOG] Удаляем проект:', projectId);
  // Показать loader
  showLoader();
  
  const { error } = await supabase
    .from('projects')
    .delete()
    .eq('project_id', projectId);

  if (error) {
    console.error('[LOG] Ошибка удаления проекта:', error);
    // Если ошибка - можно сразу скрыть loader, 
    // или оставить до следующего действия.
    hideLoader();
    return;
  }
  console.log('[LOG] Запрос на удаление проекта успешно отправлен в БД...');
  // Фактическое удаление из DOM произойдёт в Realtime колбэке "DELETE",
  // где мы и скроем loader (см. ниже).
}

/**********************/
/*  УДАЛЕНИЕ / СПЕЦИИ  */

async function deleteSpecification(specId) {
  console.log('[LOG] Удаляем спецификацию:', specId);
  // Показать loader
  showLoader();

  const { error } = await supabase
    .from('specifications')
    .delete()
    .eq('specification_id', specId);

  if (error) {
    console.error('[LOG] Ошибка удаления спецификации:', error);
    hideLoader();
    return;
  }
  console.log('[LOG] Запрос на удаление спецификации успешно отправлен в БД...');
  // Реальный remove из DOM сделает Realtime "DELETE", там же hideLoader().
}

/**********************/
/*    РЕДАКТИРОВАНИЕ   */

function openEditModal(projectId) {
  const projectContainer = projectsContainer.querySelector(`[data-id="${projectId}"]`);
  if (!projectContainer) return;
  const project = {
    project_id: projectId,
    project_name: projectContainer.dataset.projectName,
    status: projectContainer.dataset.status,
    contract_amount: projectContainer.dataset.contractAmount,
    contract_costs: projectContainer.dataset.contractCosts,
    contract_profit: projectContainer.dataset.contractProfit,
    profit_percentage: projectContainer.dataset.profitPercentage,
    company_seller: projectContainer.dataset.companySeller,
    tin_seller: projectContainer.dataset.tinSeller,
    buyer_company: projectContainer.dataset.buyerCompany,
    tin_buyer: projectContainer.dataset.tinBuyer,
  };
  currentEditingProject = project;

  editForm['edit-project-name'].value = project.project_name;
  editForm['edit-status'].value = project.status;
  editForm['edit-contract-amount'].value = project.contract_amount;
  editForm['edit-contract-cost'].value = project.contract_costs;
  editForm['edit-contract-profit'].value = project.contract_profit;
  editForm['edit-profit-percentage'].value = project.profit_percentage;
  editForm['edit-company-seller'].value = project.company_seller;
  editForm['edit-tin-seller'].value = project.tin_seller;
  editForm['edit-buyer-company'].value = project.buyer_company;
  editForm['edit-tin-buyer'].value = project.tin_buyer;

  editModal.classList.remove('hidden');
}
function closeEditModal() {
  editModal.classList.add('hidden');
  currentEditingProject = null;
}
async function saveProject() {
  if (!currentEditingProject) return;
  const updatedProject = {
    project_name: editForm['edit-project-name'].value,
    status: editForm['edit-status'].value,
    contract_amount: parseFloat(editForm['edit-contract-amount'].value) || 0.00,
    contract_costs: parseFloat(editForm['edit-contract-cost'].value) || 0.00,
    contract_profit: parseFloat(editForm['edit-contract-profit'].value) || 0.00,
    profit_percentage: parseFloat(editForm['edit-profit-percentage'].value) || 0.00,
    company_seller: editForm['edit-company-seller'].value,
    tin_seller: editForm['edit-tin-seller'].value,
    buyer_company: editForm['edit-buyer-company'].value,
    tin_buyer: editForm['edit-tin-buyer'].value,
  };
  console.log('[LOG] Сохраняем изменения проекта:', currentEditingProject.project_id, updatedProject);
  const { error } = await supabase
    .from('projects')
    .update(updatedProject)
    .eq('project_id', currentEditingProject.project_id);

  if (error) {
    console.error('[LOG] Ошибка сохранения проекта:', error);
  }
  closeEditModal();
}

// Редактирование спецификации
function openEditSpecModal(specId) {
  const specContainer = projectsContainer.querySelector(`[data-spec-id="${specId}"]`);
  if (!specContainer) return;

  const spec = {
    specification_id: specId,
    project_id: specContainer.dataset.projectId,
    specification_name: specContainer.dataset.specificationName,
    status: specContainer.dataset.status,
    specification_amount: specContainer.dataset.specificationAmount,
    specification_costs: specContainer.dataset.specificationCosts,
    specification_profit: specContainer.dataset.specificationProfit,
    profit_percentage: specContainer.dataset.profitPercentage,
    responsible: specContainer.dataset.responsible,
  };
  currentEditingSpec = spec;

  editSpecForm['edit-spec-name'].value = spec.specification_name;
  editSpecForm['edit-spec-status'].value = spec.status;
  editSpecForm['edit-spec-amount'].value = spec.specification_amount;
  editSpecForm['edit-spec-costs'].value = spec.specification_costs;
  editSpecForm['edit-spec-profit'].value = spec.specification_profit;
  editSpecForm['edit-spec-profit-pct'].value = spec.profit_percentage;
  editSpecForm['edit-spec-responsible'].value = spec.responsible;

  editSpecModal.classList.remove('hidden');
}
function closeEditSpecModal() {
  editSpecModal.classList.add('hidden');
  currentEditingSpec = null;
}
async function saveSpecification() {
  if (!currentEditingSpec) return;
  const updatedSpec = {
    specification_name: editSpecForm['edit-spec-name'].value,
    status: editSpecForm['edit-spec-status'].value,
    specification_amount: parseFloat(editSpecForm['edit-spec-amount'].value) || 0.00,
    specification_costs: parseFloat(editSpecForm['edit-spec-costs'].value) || 0.00,
    specification_profit: parseFloat(editSpecForm['edit-spec-profit'].value) || 0.00,
    profit_percentage: parseFloat(editSpecForm['edit-spec-profit-pct'].value) || 0.00,
    responsible: editSpecForm['edit-spec-responsible'].value,
  };
  console.log('[LOG] Сохраняем изменения спецификации:', currentEditingSpec.specification_id, updatedSpec);
  const { error } = await supabase
    .from('specifications')
    .update(updatedSpec)
    .eq('specification_id', currentEditingSpec.specification_id);

  if (error) {
    console.error('[LOG] Ошибка сохранения спецификации:', error);
  }
  closeEditSpecModal();
}

/**********************/
/*   REALTIME ПОДПИСКА */

function setupRealtime() {
  // Подписка на проекты
  const channelProjects = supabase
    .channel('realtime_projects')
    .on(
      'postgres_changes',
      { event: '*', schema: 'public', table: 'projects' },
      (payload) => {
        const projectId = payload.new?.project_id || payload.old?.project_id;
        if (!projectId) return;

        if (payload.eventType === 'INSERT' && payload.new) {
          console.log('[LOG] Realtime: INSERT project:', payload.new);
          // Добавим DOM, если нет
          if (!projectsContainer.querySelector(`[data-id="${projectId}"]`)) {
            const block = createProjectContainer(payload.new);
            if (block) projectsContainer.appendChild(block);
          }
        } else if (payload.eventType === 'UPDATE' && payload.new) {
          console.log('[LOG] Realtime: UPDATE project:', payload.new);
          const projectContainer = projectsContainer.querySelector(`[data-id="${projectId}"]`);
          if (projectContainer) {
            const updatedProject = payload.new;
            // Обновляем data-атрибуты
            projectContainer.dataset.projectName = updatedProject.project_name || '';
            projectContainer.dataset.status = updatedProject.status || '';
            projectContainer.dataset.contractAmount = updatedProject.contract_amount || 0;
            projectContainer.dataset.contractCosts = updatedProject.contract_costs || 0;
            projectContainer.dataset.contractProfit = updatedProject.contract_profit || 0;
            projectContainer.dataset.profitPercentage = updatedProject.profit_percentage || 0;
            projectContainer.dataset.companySeller = updatedProject.company_seller || '';
            projectContainer.dataset.tinSeller = updatedProject.tin_seller || '';
            projectContainer.dataset.buyerCompany = updatedProject.buyer_company || '';
            projectContainer.dataset.tinBuyer = updatedProject.tin_buyer || '';

            // Обновляем поля
            const fields = [
              'project_id',
              'project_name',
              'status',
              'contract_amount',
              'contract_costs',
              'contract_profit',
              'profit_percentage',
              'company_seller',
              'tin_seller',
              'buyer_company',
              'tin_buyer'
            ];
            fields.forEach(field => {
              const input = projectContainer.querySelector(`[data-field="${field}"]`);
              if (input) {
                input.value = updatedProject[field] !== undefined ? updatedProject[field] : '';
              }
            });
          }
        } else if (payload.eventType === 'DELETE') {
          console.log('[LOG] Realtime: DELETE project:', payload.old);
          const projectContainer = projectsContainer.querySelector(`[data-id="${projectId}"]`);
          if (projectContainer) {
            const projectBlock = projectContainer.closest('.project-block');
            if (projectBlock) {
              projectsContainer.removeChild(projectBlock);
            }
          }
          // Скрываем loader, т.к. удаление (и из DOM) завершено
          hideLoader();
        }
      }
    )
    .subscribe();

  // Подписка на спецификации
  const channelSpecs = supabase
  .channel('realtime_specifications')
  .on(
    'postgres_changes',
    { event: '*', schema: 'public', table: 'specifications' },
    (payload) => {
      // Определяем specId (при DELETE часто лежит в payload.old, при INSERT/UPDATE - в payload.new)
      const specId = payload.new?.specification_id || payload.old?.specification_id;
      if (!specId) return;

      // Смотрим тип события
      if (payload.eventType === 'INSERT' && payload.new) {
        console.log('[LOG] Realtime: INSERT specification:', payload.new);

        // Логика создания DOM-элемента (если нужно):
        // Для вставки нам нужен project_id, чтобы найти родительский контейнер
        // (как вариант — project_id = payload.new.project_id)
        const projectId = payload.new.project_id;
        const projectContainer = document.querySelector(`[data-id="${projectId}"]`);
        if (projectContainer) {
          const projectBlock = projectContainer.closest('.project-block');
          const specsWrapper = projectBlock?.querySelector('.specifications-wrapper');
          if (specsWrapper) {
            // Функция createSpecificationContainer() создаёт DOM-элемент из шаблона
            const specEl = createSpecificationContainer(payload.new);
            if (specEl) {
              specsWrapper.appendChild(specEl);
            }
          }
        }

      } else if (payload.eventType === 'UPDATE' && payload.new) {
        console.log('[LOG] Realtime: UPDATE specification:', payload.new);

        // Найдём в DOM элемент спецификации напрямую по specId
        const specElem = document.querySelector(`[data-spec-id="${specId}"]`);
        if (specElem) {
          // Обновляем data-атрибуты
          const updatedSpec = payload.new;
          specElem.dataset.specificationName = updatedSpec.specification_name || '';
          specElem.dataset.status = updatedSpec.status || '';
          specElem.dataset.specificationAmount = updatedSpec.specification_amount || 0;
          specElem.dataset.specificationCosts = updatedSpec.specification_costs || 0;
          specElem.dataset.specificationProfit = updatedSpec.specification_profit || 0;
          specElem.dataset.profitPercentage = updatedSpec.profit_percentage || 0;
          specElem.dataset.responsible = updatedSpec.responsible || '';

          // Обновляем поля readonly
          specElem.querySelector('[data-field="specification_name"]').value = updatedSpec.specification_name || '';
          specElem.querySelector('[data-field="status"]').value = updatedSpec.status || '';
          specElem.querySelector('[data-field="specification_amount"]').value = updatedSpec.specification_amount || 0;
          specElem.querySelector('[data-field="specification_costs"]').value = updatedSpec.specification_costs || 0;
          specElem.querySelector('[data-field="specification_profit"]').value = updatedSpec.specification_profit || 0;
          specElem.querySelector('[data-field="profit_percentage"]').value = updatedSpec.profit_percentage || 0;
          specElem.querySelector('[data-field="responsible"]').value = updatedSpec.responsible || '';
        }

      } else if (payload.eventType === 'DELETE') {
        console.log('[LOG] Realtime: DELETE specification:', payload.old);

        // Удаляем элемент спецификации напрямую по specId (не используем project_id)
        const specElem = document.querySelector(`[data-spec-id="${specId}"]`);
        if (specElem) {
          specElem.remove();
        }
        // Скрываем лоадер, если мы его показывали на момент удаления
        hideLoader();
      }
    }
  )
  .subscribe();

  channelProjects.on('subscription_error', (status) => {
    console.error('[LOG] Ошибка подписки (projects):', status);
  });
  channelSpecs.on('subscription_error', (status) => {
    console.error('[LOG] Ошибка подписки (specifications):', status);
  });
}

/**********************/
/*   НАСТРОЙКА EVENTS  */

if (addProjectButton) {
  addProjectButton.addEventListener('click', addNewProject);
}

// Общий обработчик кликов в projectsContainer
projectsContainer.addEventListener('click', (event) => {
  // Проекты
  const iconProject = event.target.closest('.modal1-icon');
  if (iconProject) {
    const action = iconProject.dataset.action;
    const projectId = iconProject.dataset.id;
    if (action === 'delete') {
      deleteProject(projectId);
    } else if (action === 'edit') {
      openEditModal(projectId);
    } else if (action === 'new-specificstion') {
      addNewSpecification(projectId);
    }
    return;
  }

  // Спецификации
  const iconSpec = event.target.closest('.spec-icon');
  if (iconSpec) {
    const specAction = iconSpec.dataset.action;
    const specId = iconSpec.dataset.specId;
    if (specAction === 'delete-spec') {
      deleteSpecification(specId);
    } else if (specAction === 'edit-spec') {
      openEditSpecModal(specId);
    }
  }
});

// Кнопки закрыть/сохранить в модалках
document.querySelector('.close-edit-modal').addEventListener('click', closeEditModal);
editForm.querySelector('.save-button').addEventListener('click', saveProject);

document.querySelector('.close-edit-spec-modal').addEventListener('click', closeEditSpecModal);
editSpecForm.querySelector('.save-spec-button').addEventListener('click', saveSpecification);

/**********************/
/*   ЗАПУСК ПРИ ЗАГРУЗКЕ */

loadProjects()
  .then(loadSpecifications)
  .then(setupRealtime);

/**********************/
/*   Пример закрытия всего (основного) модала */
function closeModal() {
  document.querySelector('.modal111-content').style.display = 'none';
}
</script>
