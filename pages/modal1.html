<!-- /pages/modal1.html -->
<button class="close-modal" onclick="closeModal()">×</button>
<div class="modal111-content" style="justify-content: flex-start;">
  <h2 class="modal1-title">ELABORATION SALES</h2>
  <p class="modal1-subtitle">проекты в работе</p>
  <button id="add-project-button" class="button-D" style="top: 2vw; left: 24vw;"> 
    <span class="btn-txt">new project</span>
  </button> 

  <div id="modalBottom" class="modalVNUT" style="top: 5.5vw; left: 6vw; right: 2vw; height: calc(100vh - 7.4vw); width: 99%;">
    <div class="modalVNUT-content" id="projects-container">
      <!-- Блоки проектов будут динамически добавляться здесь    -->
    </div>
  </div>
</div>

<!-- Модальное окно редактирования проекта -->
<div id="editModal" class="edit-modal hidden">
  <div class="edit-modal-content">
    <button class="close-edit-modal">×</button>
    <h3>Редактирование проекта</h3>
    <form id="edit-form">
      <!-- Название проекта -->
      <label for="edit-project-name">Название проекта</label>
      <input type="text" id="edit-project-name" placeholder="Введите название проекта" required />

      <!-- Статус проекта -->
      <label for="edit-status">Статус</label>
      <input type="text" id="edit-status" placeholder="Введите статус проекта" required />

      <!-- Сумма контракта -->
      <label for="edit-contract-amount">Сумма контракта</label>
      <input type="number" id="edit-contract-amount" step="0.01" placeholder="Введите сумму контракта" required />

      <!-- Стоимость контракта -->
      <label for="edit-contract-cost">Стоимость контракта</label>
      <input type="number" id="edit-contract-cost" step="0.01" placeholder="Введите стоимость контракта" />

      <!-- Прибыль -->
      <label for="edit-contract-profit">Прибыль</label>
      <input type="number" id="edit-contract-profit" step="0.01" placeholder="Введите прибыль" />

      <!-- Процент прибыли -->
      <label for="edit-profit-percentage">Процент прибыли</label>
      <input type="number" id="edit-profit-percentage" step="0.01" placeholder="Введите процент прибыли" />

      <!-- Компания-продавец -->
      <label for="edit-company-seller">Компания-продавец</label>
      <input type="text" id="edit-company-seller" placeholder="Введите название компании-продавца" />

      <!-- ИНН продавца -->
      <label for="edit-tin-seller">ИНН продавца</label>
      <input type="text" id="edit-tin-seller" placeholder="Введите ИНН продавца" />

      <!-- Компания-покупатель -->
      <label for="edit-buyer-company">Компания-покупатель</label>
      <input type="text" id="edit-buyer-company" placeholder="Введите название компании-покупателя" />

      <!-- ИНН покупателя -->
      <label for="edit-tin-buyer">ИНН покупателя</label>
      <input type="text" id="edit-tin-buyer" placeholder="Введите ИНН покупателя" />

      <!-- Кнопка для сохранения изменений -->
      <button type="button" class="save-button">Сохранить</button>
    </form>
  </div>
</div>

<!-- 
    Обновлённый блок Модального окна редактирования спецификации 
    (замена старого содержимого полностью)
-->
<div id="editSpecModal" class="edit-modal hidden">
  <div class="edit-modal-content">
    <button class="close-edit-spec-modal">×</button>
    
    <!--форма редактирования “шапки” спецификации-->
    <form id="edit-spec-form">  
      <div class="modalProjectCalculation" style="width: 97.2vw; height: 96.8vh; flex-direction: column;">
        <p style="width: 12vw; text-transform: uppercase;">project costs</p> 

        <!-- Строка полей для заголовка спецификации + кнопка создать позицию -->
        <div class="modalRow" style="margin-top: 8vh;">
          <!--иконка/кнопка создать новую позицию спецификации-->
          <span class="modal1-icon" data-action="new-position-specification" data-id="">
            <i class="material-symbols-outlined">note_add</i>
          </span>

          <!-- поля шапки спецификации -->
          <input type="text" class="inputCALC" id="edit-spec-name" placeholder="Например: «Spec #1»" required />
          <input type="text" class="inputCALC" id="edit-spec-status" placeholder="draft / active / closed" required />
          <input type="number" class="inputCALC" id="edit-spec-amount" step="0.01" placeholder="Введите сумму" />
          <input type="number" class="inputCALC" id="edit-spec-costs" step="0.01" placeholder="Введите стоимость" />
          <input type="number" class="inputCALC" id="edit-spec-profit" step="0.01" placeholder="Введите прибыль" />
          <input type="number" class="inputCALC" id="edit-spec-profit-pct" step="0.01" placeholder="%" />
          <input type="text" class="inputCALC" id="edit-spec-responsible" placeholder="ФИО / отдел" />
          <button type="button" class="save-spec-button">Сохранить</button>
        </div>

        <!-- Нижняя часть модалки со скроллом, где будут отображаться позиции (и подпозиции) -->
        <div id="modalBottom" class="modalVNUT" style="top: 14vh; height: 84.2vh; width: 97vw;">
          <div class="modalVNUT-content" id="specPositionsContainer">
            <!-- 
              Здесь динамически добавляются .modalPositionSpecification 
              (позиции спецификации) и их дочерние блоки 
            -->
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Шаблон для проекта -->
<template id="project-template">
  <div class="project-block">
    <div class="modal1-container" data-id="">
      <!-- Иконка Редактировать -->
      <span class="modal1-icon" style="left: 0.2vw;" data-action="edit" data-id="">
        <i class="material-symbols-outlined">receipt</i>
      </span>
      <!-- Иконка Создать спецификацию -->
      <span class="modal1-icon" style="left: 0.2vw;" data-action="new-specificstion" data-id="">
        <i class="material-symbols-outlined">stat_minus_2</i>
      </span>

      <!-- Project ID -->
      <div class="modal1-input-group left">
        <input type="text" style="width: 5vw" class="modal1-input" placeholder=" " data-field="project_id" readonly />
        <label>Project ID</label>
      </div>

      <!-- Project Name -->
      <div class="modal1-input-group right">
        <input type="text" style="width: 20vw" class="modal1-input" placeholder=" " data-field="project_name" readonly />
        <label>Project Name</label>
      </div>

      <!-- Status -->
      <div class="modal1-input-group right">
        <input type="text" style="width: 7vw" class="modal1-input" placeholder=" " data-field="status" readonly />
        <label>Status</label>
      </div>

      <!-- Contract Amount -->
      <div class="modal1-input-group left">
        <input 
          type="text"
          style="width: 4.5vw; text-align: right;" 
          class="modal1-input numeric-align" 
          data-field="contract_amount" 
          readonly 
        />
        <label>Contract Amount</label>
      </div>

      <!-- Contract Costs -->
      <div class="modal1-input-group right">
        <input 
          type="text" 
          style="width: 4.5vw; text-align: right;"
          class="modal1-input numeric-align"
          data-field="contract_costs" 
          readonly 
        />
        <label>Contract Costs</label>
      </div>

      <!-- Contract Profit -->
      <div class="modal1-input-group right">
        <input 
          type="text" 
          style="width: 4.5vw; text-align:right;"
          class="modal1-input numeric-align"
          data-field="contract_profit" 
          readonly 
        />
        <label>Contract Profit</label>
      </div>

      <!-- Profit % -->
      <div class="modal1-input-group right">
        <input 
          type="text"
          style="width: 2vw; text-align:center;" 
          class="modal1-input numeric-align-center" 
          data-field="profit_percentage" 
          readonly 
        />
        <label>Profit %</label>
      </div>

      <!-- Company Seller -->
      <div class="modal1-input-group left">
        <input type="text" class="modal1-input" placeholder=" " data-field="company_seller" readonly />
        <label>Company Seller</label>
      </div>

      <!-- TIN Seller -->
      <div class="modal1-input-group right">
        <input type="text" style="width: 5vw" class="modal1-input" placeholder=" " data-field="tin_seller" readonly />
        <label>TIN Seller</label>
      </div>

      <!-- Buyer Company -->
      <div class="modal1-input-group left">
        <input type="text" class="modal1-input" placeholder=" " data-field="buyer_company" readonly />
        <label>Buyer Company</label>
      </div>

      <!-- TIN Buyer -->
      <div class="modal1-input-group right">
        <input type="text" style="width: 5vw" class="modal1-input" placeholder=" " data-field="tin_buyer" readonly />
        <label>TIN Buyer</label>
      </div>

      <!-- Иконка Удалить -->
      <span class="modal1-icon" style="right: -2.4vw;" data-action="delete" data-id="">
        <i class="material-symbols-outlined">delete</i>
      </span>
    </div>

    <!-- Блок для спецификаций - отдельный, чтобы не растягивать родителя -->
    <div class="specifications-wrapper"></div>
  </div>
</template>

<!-- Шаблон для спецификации -->
<template id="specification-template">
  <div class="spec-container" data-spec-id="">
    <!-- Иконка Редактировать спецификацию -->
    <span class="spec-icon" style="left: 0.2vw;" data-action="edit-spec" data-spec-id="">
      <i class="material-symbols-outlined">edit_note</i>
    </span>
    <!-- Specification Name -->
    <div class="modal1-input-group left" style="margin-left: 1.3vw;">
      <input type="text" style="width: 20vw" class="modal1-input" placeholder=" " data-field="specification_name" readonly />
      <label>Spec Name</label>
    </div>
    <!-- Status -->
    <div class="modal1-input-group right">
      <input type="text" style="width: 7vw" class="modal1-input" placeholder=" " data-field="status" readonly />
      <label>Status</label>
    </div>
    <!-- Amount -->
    <div class="modal1-input-group left">
      <input 
        type="text"
        style="width: 4.5vw; text-align:right;" 
        class="modal1-input numeric-align"
        data-field="specification_amount" 
        readonly 
      />
      <label>Amount</label>
    </div>
    <!-- Costs -->
    <div class="modal1-input-group right">
      <input
        type="text"
        style="width: 4.5vw; text-align:right;"
        class="modal1-input numeric-align"
        data-field="specification_costs" 
        readonly 
      />
      <label>Costs</label>
    </div>
    <!-- Profit -->
    <div class="modal1-input-group right">
      <input
        type="text"
        style="width: 4.5vw; text-align:right;"
        class="modal1-input numeric-align"
        data-field="specification_profit" 
        readonly 
      />
      <label>Profit</label>
    </div>
    <!-- Profit % -->
    <div class="modal1-input-group right">
      <input
        type="text"
        style="width: 2vw; text-align:center;"
        class="modal1-input numeric-align-center"
        data-field="profit_percentage" 
        readonly 
      />
      <label>Profit %</label>
    </div>
    <!-- Responsible -->
    <div class="modal1-input-group left">
      <input type="text" class="modal1-input" placeholder=" " data-field="responsible" readonly />
      <label>Responsible</label>
    </div>

     <!-- list of contractors -->
    <div class="modal1-input-group left">
      <input type="text" class="modal1-input" style="width: 18vw" placeholder=" " data-field="list_of_contractors" readonly />
      <label>list of contractors</label>
    </div>

    <!-- Иконка Удалить -->
    <span class="spec-icon" style="right: -2.4vw;" data-action="delete-spec" data-spec-id="">
      <i class="material-symbols-outlined">delete</i>
    </span>
  </div>
</template>

<!-- Оверлей-загрузчик (появляется при удалении) -->
<div class="overlay hidden" id="delete-overlay">
  <div class="loader">
    <label>Удаление записи из базы данных...</label>
    <div class="loading"></div>
  </div>
</div>

<style>
:root {
  --scrollbar-color: rgba(255, 255, 255, 0.04); 
  --scrollbar-thumb-color: #D1D5D0; 
  --scroll-y-position: 10%;
  --reflection-y-position: 50%;
  
  --borderRadius: 0.4vw;
  --spacer: 1vw; 
}

  /* Убираем стрелки в input[type=number] */
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* Моноширинные цифры (tabular) для некоторых полей */
.numeric-align {
  font-variant-numeric: tabular-nums;
}
.numeric-align-center {
  font-variant-numeric: tabular-nums;
  text-align: center;
}

/* Закрыть главное модальное окно (список проектов) */
.close-modal {
  position: absolute;
  top: 1vw;
  right: 1vw;
  background: none;
  border: none;
  font-size: 1vw;
  cursor: pointer;
  color: var(--white-color2);
}
.close-modal:hover {
  color: #393E41;
}

.modal111-content {
  font-family: "Comfortaa", sans-serif;
  color: var(--white-color2);
  background-color: none;
  border-radius: var(--borderRadius);
  height: calc(100vh - (var(--spacer)*2));
  width: calc(100vw - (var(--spacer)*6));
  box-sizing: border-box;
  position: relative;
  padding: 1vw;
}

/* Заголовок и подзаголовок */
.modal1-title {
  color: var(--white-color2);
  font-size: 0.7vw;
  margin-top: 0vw;
  margin-left: 0vw;
  display: flex
}
.modal1-subtitle {
  color: var(--white-color2);
  font-size: 0.45vw;
  margin-top: 0.2vw;
  margin-left: 0vw;
  display: flex
}

/* Модальное окно с прокруткой */
.modalVNUT {
  display: flex;
  position: fixed;
  background: none;
  padding: 0vw;
  border-radius: 0.4vw;
  border: 0px solid rgba(255, 255, 255, 0.18);
  color: black;
  z-index: 1000;
  overflow: hidden;
  box-sizing: border-box;
}
.modalVNUT-content {
  padding: 0.5vh 2vh 0vw 0vw;
  height: 100%;
  width: 92vw;
  overflow-y: scroll;
  box-sizing: border-box;
}
.modalVNUT-content::-webkit-scrollbar {
  width: 4px;
  background-color: var(--scrollbar-color);
}
.modalVNUT-content::-webkit-scrollbar-thumb {
  background-color: var(--scrollbar-thumb-color);
  border-radius: 10px;
}
.modalVNUT-content::-webkit-scrollbar-track {
  background-color: var(--scrollbar-color);
}

/* Обёртка каждого проекта + спецификаций */
.project-block {
  margin-bottom: 1vw;
}

/* Родительский контейнер (сделка) */
.modal1-container {
  display: flex;
  align-items: center;
  padding: 0.4vw;
  border-radius: var(--borderRadius);
  color: var(--white-color2);
  z-index: 1100;
  box-sizing: border-box;
  background: rgba(255, 255, 255, 0.04);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 0.5px solid rgba(179, 185, 193, 0.15);
  width: 90.5vw;
  height: 2.1vw;
  transform-origin: top left;
  position: relative;
}
.modal1-container:hover,
.modal1-container:focus {
  border: 1px solid var(--white-color2);
}

/* Иконки (редактировать/удалить/новая спецификация) */
.modal1-icon {
  color: rgba(255, 255, 255, 0.6);
  font-size: 0.7vw;
  margin-right: 0.5vw;
  cursor: pointer;
  display: flex;
  align-items: center;
  position: relative;
}
.modal1-icon:hover {
  color: var(--white-color2);
  transform: scale(1.1);
}
.modal1-icon:active {
  transform: scale(0.92);
}

/* Блок спецификаций */
.specifications-wrapper {
  display: flex;
  flex-direction: column;
  width: 100%;
  margin-top: 0.5vw;
}

/* Дочерний контейнер (спецификация) */
.spec-container {
  display: flex;
  align-items: center;
  padding: 0.4vw;
  border-radius: 2px;
  color: var(--white-color2);
  z-index: 1100;
  box-sizing: border-box;
  background: rgba(179, 185, 193, 0.025);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 0px solid rgba(179, 185, 193, 0.15);
  width: 83vw;
  height: 1.2vw;
  margin-left: 7.5vw;
  margin-top: 0.5vw;
  position: relative;
}
.spec-container:hover,
.spec-container:focus {
  border-left: 1px solid var(--white-color2);
  border-right: 1px solid var(--white-color2);
}

/* Иконки спецификации (редактировать/удалить) */
.spec-icon {
  color: rgba(255, 255, 255, 0.6);
  font-size: 0.7vw;
  margin-right: 0.5vw;
  cursor: pointer;
  display: flex;
  align-items: center;
  position: relative;
}
.spec-icon:hover {
  color: var(--white-color2);
  transform: scale(1.1);
}
.spec-icon:active {
  transform: scale(0.92);
}

/* Группы инпутов */
.modal1-input-group {
  position: relative;
  font-family: "Comfortaa", sans-serif;
}
.modal1-input-group.left {
  margin-left: 2vw;
}
.modal1-input-group.right {
  margin-left: 0.4vw;
}
.modal1-input-group label {
  background: none;
  color: rgba(255, 255, 255, 0.6);
  position: absolute;
  top: 0.61vw;
  left: 0.28vw;
  transform: translateY(-50%);
  text-transform: uppercase;
  font-weight: 700;
  pointer-events: none;
  font-size: 0.42vw;
  transition: all 0.3s;
}
.modal1-input-group .modal1-input {
  padding: 0.28vw 0.28vw; 
  width: 100%;
  border: 1px solid rgba(255, 255, 255, 0.18);
  outline: none;
  color: var(--white-color2);
  font-size: 0.49vw; 
  font-family: inherit;
  background-color: transparent;
  border-radius: 7px; 
}
.modal1-input-group .modal1-input:hover,
.modal1-input-group .modal1-input:focus {
  border: 1px solid var(--white-color2);
}
.modal1-input-group .modal1-input:focus + label,
.modal1-input-group .modal1-input:not(:placeholder-shown) + label {
  top: -0.2vw;
  font-size: 0.28vw;
  background: none;
  border-radius: 7px; 
  color: var(--white-color3);
}

/* Кнопка add project */
#add-project-button {
  background-color: var(--white-color2);
  color: var(--black-color);
  border: none;
  border-radius: 5px;
  transition: background-color 0.3s;
}
#add-project-button:hover {
  background-color: var(--white-color1);
}

/* Стили модального окна редактирования (общие) */
.edit-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.5);
  -webkit-backdrop-filter: blur(7px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1100;
}
.edit-modal.hidden {
  display: none;
}
.edit-modal-content {
  background: none;
  padding: 1vw;
  border-radius: none;
  width: 100vw;
  height: 100vh;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
}
.close-edit-modal,
.close-edit-spec-modal {
  position: absolute;
  top: 1vw;
  right: 1vw;
  background: none;
  border: none;
  font-size: 0.7vw;
  cursor: pointer;
}
.close-edit-modal:hover,
.close-edit-spec-modal:hover {
  color: white;
}

/* Кнопка add project */
.button-D {
  height: 1vw;
  width: 8vw;
  position: fixed;
  background-color: transparent;
  cursor: pointer;
  border: 2px solid var(--white-color2);
  overflow: hidden;
  border-radius: 10px;
  color: var(--black-color);
  transition: all 0.2s ease-in-out;
}
.btn-txt {
  z-index: 1;
  font-weight: 800;
  letter-spacing: 2px;
  text-transform: uppercase;
  font-size: 0.5vw;
}
.button-D:active {
  transform: scale(0.9);
  background-color: var(--white-color1);
}

/* Overlay (loader) стили */
.overlay {
  position: fixed;
  top: 0; 
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.4);
  z-index: 9999; 
  display: flex;
  justify-content: center;
  align-items: center;
}
.overlay.hidden {
  display: none;
}
.loader {
  width: 350px;
  height: 180px;
  border-radius: 10px;
  background: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-evenly;
  padding: 30px;
  box-shadow: 2px 2px 10px -5px lightgrey;
}
.loading {
  width: 100%;
  height: 10px;
  background: lightgrey;
  border-radius: 10px;
  position: relative;
}
.loading::after {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 50%;
  height: 10px;
  background: #002;
  border-radius: 10px;
  z-index: 1;
  animation: loading 0.6s alternate infinite;
}
.loader > label {
  color: #002;
  font-size: 18px;
  animation: bit 0.6s alternate infinite;
}

@keyframes bit {
  from {
    opacity: 0.3;
  }
  to {
    opacity: 1;
  }
}
@keyframes loading {
  0% {
    left: 0%;
  }
  100% {
    left: 50%;
  }
}


/* input без LABEL */
.inputCALC {
  position: relative;
  font-family: "Comfortaa", sans-serif;
  padding: 0.4vw 0.4vw;
  min-width: 1vw;
  height: 1.4vw;
  border: 1px solid rgba(255, 255, 255, 0.18);
  outline: none;
  color: var(--white-color2);
  font-size: 0.7vw;
  font-family: inherit;
  background-color: transparent;
  border-radius: 10px;
}

.inputCALC:hover,
.inputCALC:focus {
  border: 1px solid var(--white-color2);
}

/* модальное окно для полей карточки проекта */
.modalProjectCARD {
  display: flex;
  position: relative;
  padding: 0.5vw;
  border-radius: 0.4vw;
  color: black;
  z-index: 1100;
  box-sizing: border-box;
  vertical-align: middle;
  height: auto;
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(0px);
  border-radius: 10px;
  border: 1px solid rgba(255, 255, 255, 0.18);
}

.modalProjectCARD:hover,
.modalProjectCARD:focus {
  border: 1px solid var(--white-color2);
}

/* Отступы только между контейнерами */
.modalProjectCARD:not(:last-child) {
  margin-bottom: 0.8vw; /* Отступ снизу только между контейнерами */
}

.modalRow-child-list {
  display: flex;
  position: relative;
  flex-direction: row;
  background: none;
  gap: 1vw;
}
  
.modalRow {
  display: flex;
  position: relative;
  flex-direction: row;
  background: none;
  gap: 1vw;
}

.modalColumn {
  display: flex;
  position: relative;
  flex-direction: column;
  background: none;
  gap: 1vw;
}


  /* The switch - the box around the slider */
.switch {
  font-size: 0.7vw;
  position: relative;
  display: inline-block;
  width: 2.3vw;
  height: 1.3vw;
  border: 1px solid rgba(255, 255, 255, 0.18);
  border-radius: 6px;
  margin: 0.1vw;
}

/* Hide default HTML checkbox */
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

/* The slider */
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: var(--black-color);
  transition: .4s;
  border-radius: 6px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 0.8vw;
  width: 0.18vw;
  border-radius: 10px;
  left: 0.2vw;
  bottom: 0.2vw;
  background-color: var(--white-color2);
  transition: .4s;
}

input:checked + .slider {
  background-color: var(--white-color2);
  box-shadow: inset 4px rgb(0, 0, 0);
}

input:checked + .slider:before {
  transform: translateX(1.55vw) rotate(360deg);
  background-color: var(--black-color);
}

  
  
  
</style>

<script type="module">
  // Инициализация Supabase (предполагаем, что window.supabase уже инициализирован)
  const supabase = window.supabase;

  // Локальные переменные
  const projectsContainer = document.getElementById('projects-container');
  const addProjectButton = document.getElementById('add-project-button');

  // Модалки
  const editModal = document.getElementById('editModal');
  const editForm = document.getElementById('edit-form');
  const editSpecModal = document.getElementById('editSpecModal');
  const editSpecForm = document.getElementById('edit-spec-form');

  // Оверлей-загрузчик
  const deleteOverlay = document.getElementById('delete-overlay');

  // Текущее редактируемое
  let currentEditingProject = null;
  let currentEditingSpec = null;

  /**********************/
  // //Форматирование числа с пробелами
  function formatNumberWithSpaces(value) {
    if (value == null || value === '') return '';
    const num = Number(value);
    if (isNaN(num)) return '';
    const parts = num.toString().split('.');
    const intPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    let result = intPart;
    if (parts[1]) result += '.' + parts[1];
    return result;
  }

  /**********************/
  // //Loader
  function showLoader() {
    deleteOverlay.classList.remove('hidden');
  }
  function hideLoader() {
    deleteOverlay.classList.add('hidden');
  }

  /**********************/
  // //Генерация ID (если у вас text)
  function generateProjectID() {
    return 'proj_' + Math.random().toString(36).substr(2, 9);
  }
  function generateSpecificationID() {
    return 'spec_' + Math.random().toString(36).substr(2, 9);
  }

  /**********************/
  // //Создание DOM для проектов/спецификаций
  function createProjectContainer(project) {
    if (!project || !project.project_id) {
      console.error('[LOG] Некорректные данные проекта:', project);
      return null;
    }
    const template = document.getElementById('project-template');
    if (!template) {
      console.error('[LOG] Шаблон project-template не найден.');
      return null;
    }
    const block = template.content.cloneNode(true);
    const container = block.querySelector('.modal1-container'); 
    if (!container) return null;

    container.dataset.id = project.project_id;

    // Иконки
    const editIcon = container.querySelector('[data-action="edit"]');
    const deleteIcon = container.querySelector('[data-action="delete"]');
    const newSpecIcon = container.querySelector('[data-action="new-specificstion"]');
    if (editIcon) editIcon.dataset.id = project.project_id;
    if (deleteIcon) deleteIcon.dataset.id = project.project_id;
    if (newSpecIcon) newSpecIcon.dataset.id = project.project_id;

    // Сохраняем поля в data-атрибутах
    container.dataset.projectName = project.project_name || '';
    container.dataset.status = project.status || '';
    container.dataset.contractAmount = project.contract_amount || 0;
    container.dataset.contractCosts = project.contract_costs || 0;
    container.dataset.contractProfit = project.contract_profit || 0;
    container.dataset.profitPercentage = project.profit_percentage || 0;
    container.dataset.companySeller = project.company_seller || '';
    container.dataset.tinSeller = project.tin_seller || '';
    container.dataset.buyerCompany = project.buyer_company || '';
    container.dataset.tinBuyer = project.tin_buyer || '';

    // Заполняем поля (readonly)
    const projectIdInput = container.querySelector('[data-field="project_id"]');
    const projectNameInput = container.querySelector('[data-field="project_name"]');
    const statusInput = container.querySelector('[data-field="status"]');
    const contractAmountInput = container.querySelector('[data-field="contract_amount"]');
    const contractCostsInput = container.querySelector('[data-field="contract_costs"]');
    const contractProfitInput = container.querySelector('[data-field="contract_profit"]');
    const profitPercentageInput = container.querySelector('[data-field="profit_percentage"]');
    const companySellerInput = container.querySelector('[data-field="company_seller"]');
    const tinSellerInput = container.querySelector('[data-field="tin_seller"]');
    const buyerCompanyInput = container.querySelector('[data-field="buyer_company"]');
    const tinBuyerInput = container.querySelector('[data-field="tin_buyer"]');

    if (projectIdInput) projectIdInput.value = project.project_id;
    if (projectNameInput) projectNameInput.value = project.project_name || '';
    if (statusInput) statusInput.value = project.status || '';
    if (contractAmountInput) contractAmountInput.value = formatNumberWithSpaces(project.contract_amount) || 0;
    if (contractCostsInput) contractCostsInput.value = formatNumberWithSpaces(project.contract_costs) || 0;
    if (contractProfitInput) contractProfitInput.value = formatNumberWithSpaces(project.contract_profit) || 0;
    if (profitPercentageInput) profitPercentageInput.value = formatNumberWithSpaces(project.profit_percentage) || 0;
    if (companySellerInput) companySellerInput.value = project.company_seller || '';
    if (tinSellerInput) tinSellerInput.value = project.tin_seller || '';
    if (buyerCompanyInput) buyerCompanyInput.value = project.buyer_company || '';
    if (tinBuyerInput) tinBuyerInput.value = project.tin_buyer || '';

    return block;
  }

  function createSpecificationContainer(spec) {
    if (!spec || !spec.specification_id) {
      console.error('[LOG] Некорректные данные спецификации:', spec);
      return null;
    }
    const template = document.getElementById('specification-template');
    if (!template) {
      console.error('[LOG] Шаблон specification-template не найден.');
      return null;
    }
    const block = template.content.cloneNode(true);
    const specContainer = block.querySelector('.spec-container');
    if (!specContainer) return null;

    specContainer.dataset.specId = spec.specification_id;
    specContainer.dataset.projectId = spec.project_id;

    // Иконки
    const editSpecIcon = specContainer.querySelector('[data-action="edit-spec"]');
    const deleteSpecIcon = specContainer.querySelector('[data-action="delete-spec"]');
    if (editSpecIcon) editSpecIcon.dataset.specId = spec.specification_id;
    if (deleteSpecIcon) deleteSpecIcon.dataset.specId = spec.specification_id;

    specContainer.dataset.specificationName = spec.specification_name || '';
    specContainer.dataset.status = spec.status || '';
    specContainer.dataset.specificationAmount = spec.specification_amount || 0;
    specContainer.dataset.specificationCosts = spec.specification_costs || 0;
    specContainer.dataset.specificationProfit = spec.specification_profit || 0;
    specContainer.dataset.profitPercentage = spec.profit_percentage || 0;
    specContainer.dataset.responsible = spec.responsible || '';

    const specNameInput = specContainer.querySelector('[data-field="specification_name"]');
    const specStatusInput = specContainer.querySelector('[data-field="status"]');
    const specAmountInput = specContainer.querySelector('[data-field="specification_amount"]');
    const specCostsInput = specContainer.querySelector('[data-field="specification_costs"]');
    const specProfitInput = specContainer.querySelector('[data-field="specification_profit"]');
    const specProfitPctInput = specContainer.querySelector('[data-field="profit_percentage"]');
    const responsibleInput = specContainer.querySelector('[data-field="responsible"]');

    if (specNameInput) specNameInput.value = spec.specification_name || '';
    if (specStatusInput) specStatusInput.value = spec.status || '';
    if (specAmountInput) specAmountInput.value = formatNumberWithSpaces(spec.specification_amount) || 0;
    if (specCostsInput) specCostsInput.value = formatNumberWithSpaces(spec.specification_costs) || 0;
    if (specProfitInput) specProfitInput.value = formatNumberWithSpaces(spec.specification_profit) || 0;
    if (specProfitPctInput) specProfitPctInput.value = formatNumberWithSpaces(spec.profit_percentage) || 0;
    if (responsibleInput) responsibleInput.value = spec.responsible || '';

    return specContainer;
  }

  /**********************/
  // //Загрузка проектов и спецификаций
  async function loadProjects() {
    console.log('[LOG] Загрузка списка проектов...');
    const { data, error } = await supabase.from('projects').select('*');
    if (error) {
      console.error('[LOG] Ошибка загрузки проектов:', error);
      return;
    }
    console.log('[LOG] Загружено проектов:', data?.length || 0);

    projectsContainer.innerHTML = '';
    const fragment = document.createDocumentFragment();
    data.forEach((project) => {
      const projectBlock = createProjectContainer(project);
      if (projectBlock) {
        fragment.appendChild(projectBlock);
      }
    });
    projectsContainer.appendChild(fragment);
  }

  async function loadSpecifications() {
    console.log('[LOG] Загрузка списка спецификаций...');
    const { data, error } = await supabase.from('specifications').select('*');
    if (error) {
      console.error('[LOG] Ошибка загрузки спецификаций:', error);
      return;
    }
    console.log('[LOG] Загружено спецификаций:', data?.length || 0);

    data.forEach((spec) => {
      const projectContainer = projectsContainer.querySelector(`[data-id="${spec.project_id}"]`);
      if (projectContainer) {
        const projectBlock = projectContainer.closest('.project-block');
        const specsWrapper = projectBlock.querySelector('.specifications-wrapper');
        if (specsWrapper) {
          const specElem = createSpecificationContainer(spec);
          if (specElem) {
            specsWrapper.appendChild(specElem);
          }
        }
      }
    });
  }

  /**********************/
  // //Создание проекта/спецификации
  async function addNewProject() {
    const newProject = {
      project_id: generateProjectID(),
      project_name: 'Новый проект',
      status: 'Новый',
      contract_amount: 0.00,
      contract_costs: 0.00,
      contract_profit: 0.00,
      profit_percentage: 0.00,
      company_seller: '',
      tin_seller: '',
      buyer_company: '',
      tin_buyer: '',
    };
    console.log('[LOG] Создаём новый проект:', newProject);
    const { error } = await supabase.from('projects').insert([newProject]);
    if (error) {
      console.error('[LOG] Ошибка добавления проекта:', error);
    }
  }

  async function addNewSpecification(projectId) {
    const newSpec = {
      specification_id: generateSpecificationID(),
      project_id: projectId,
      specification_name: 'New spec',
      status: 'draft',
      specification_amount: 0.00,
      specification_costs: 0.00,
      specification_profit: 0.00,
      profit_percentage: 0.00,
      responsible: '',
    };
    console.log('[LOG] Создаём новую спецификацию:', newSpec);
    const { error } = await supabase.from('specifications').insert([newSpec]);
    if (error) {
      console.error('[LOG] Ошибка добавления спецификации:', error);
    }
  }

  /**********************/
  // //Удаление проекта/спецификации
  async function deleteProject(projectId) {
    console.log('[LOG] Удаляем проект:', projectId);
    showLoader();
    const { error } = await supabase.from('projects').delete().eq('project_id', projectId);
    if (error) {
      console.error('[LOG] Ошибка удаления проекта:', error);
      hideLoader();
    }
  }
  async function deleteSpecification(specId) {
    console.log('[LOG] Удаляем спецификацию:', specId);
    showLoader();
    const { error } = await supabase.from('specifications').delete().eq('specification_id', specId);
    if (error) {
      console.error('[LOG] Ошибка удаления спецификации:', error);
      hideLoader();
    }
  }

  /**********************/
  // //Редактирование проекта
  function openEditModal(projectId) {
    const projectContainer = projectsContainer.querySelector(`[data-id="${projectId}"]`);
    if (!projectContainer) return;
    const project = {
      project_id: projectId,
      project_name: projectContainer.dataset.projectName,
      status: projectContainer.dataset.status,
      contract_amount: projectContainer.dataset.contractAmount,
      contract_costs: projectContainer.dataset.contractCosts,
      contract_profit: projectContainer.dataset.contractProfit,
      profit_percentage: projectContainer.dataset.profitPercentage,
      company_seller: projectContainer.dataset.companySeller,
      tin_seller: projectContainer.dataset.tinSeller,
      buyer_company: projectContainer.dataset.buyerCompany,
      tin_buyer: projectContainer.dataset.tinBuyer,
    };
    currentEditingProject = project;

    editForm['edit-project-name'].value = project.project_name;
    editForm['edit-status'].value = project.status;
    editForm['edit-contract-amount'].value = project.contract_amount;
    editForm['edit-contract-cost'].value = project.contract_costs;
    editForm['edit-contract-profit'].value = project.contract_profit;
    editForm['edit-profit-percentage'].value = project.profit_percentage;
    editForm['edit-company-seller'].value = project.company_seller;
    editForm['edit-tin-seller'].value = project.tin_seller;
    editForm['edit-buyer-company'].value = project.buyer_company;
    editForm['edit-tin-buyer'].value = project.tin_buyer;

    editModal.classList.remove('hidden');
  }
  function closeEditModal() {
    editModal.classList.add('hidden');
    currentEditingProject = null;
  }
  async function saveProject() {
    if (!currentEditingProject) return;
    const updatedProject = {
      project_name: editForm['edit-project-name'].value,
      status: editForm['edit-status'].value,
      contract_amount: parseFloat(editForm['edit-contract-amount'].value) || 0.00,
      contract_costs: parseFloat(editForm['edit-contract-cost'].value) || 0.00,
      contract_profit: parseFloat(editForm['edit-contract-profit'].value) || 0.00,
      profit_percentage: parseFloat(editForm['edit-profit-percentage'].value) || 0.00,
      company_seller: editForm['edit-company-seller'].value,
      tin_seller: editForm['edit-tin-seller'].value,
      buyer_company: editForm['edit-buyer-company'].value,
      tin_buyer: editForm['edit-tin-buyer'].value,
    };
    console.log('[LOG] Сохраняем изменения проекта:', currentEditingProject.project_id, updatedProject);
    const { error } = await supabase
      .from('projects')
      .update(updatedProject)
      .eq('project_id', currentEditingProject.project_id);

    if (error) {
      console.error('[LOG] Ошибка сохранения проекта:', error);
    }
    closeEditModal();
  }

  /**********************/
  // //Редактирование спецификации
  // //функция открыть модальное окно редактирования спецификации
function openEditSpecModal(specId) {
  console.log(`[LOG] openEditSpecModal: Запущена функция, получен specId="${specId}"`);

  // Пытаемся найти в DOM элемент спецификации (список проектов находится в projectsContainer)
  const specContainer = projectsContainer.querySelector(`[data-spec-id="${specId}"]`);
  if (!specContainer) {
    console.log(`[LOG] openEditSpecModal: Не найден элемент .spec-container с data-spec-id="${specId}". Прерываем.`);
    return;
  }
  
  // Собираем данные из data-атрибутов (то, что было прописано при создании DOM-элемента спецификации)
  const spec = {
    specification_id: specId,
    project_id: specContainer.dataset.projectId,
    specification_name: specContainer.dataset.specificationName,
    status: specContainer.dataset.status,
    specification_amount: specContainer.dataset.specificationAmount,
    specification_costs: specContainer.dataset.specificationCosts,
    specification_profit: specContainer.dataset.specificationProfit,
    profit_percentage: specContainer.dataset.profitPercentage,
    responsible: specContainer.dataset.responsible,
  };

  console.log('[LOG] openEditSpecModal: Считанные данные спецификации из DOM:', spec);

  // Запоминаем текущую спецификацию, которую редактируем
  currentEditingSpec = spec;

  // Заполняем поля формы modалa редактирования спецификации
  editSpecForm['edit-spec-name'].value = spec.specification_name || '';
  editSpecForm['edit-spec-status'].value = spec.status || '';
  editSpecForm['edit-spec-amount'].value = spec.specification_amount || '';
  editSpecForm['edit-spec-costs'].value = spec.specification_costs || '';
  editSpecForm['edit-spec-profit'].value = spec.specification_profit || '';
  editSpecForm['edit-spec-profit-pct'].value = spec.profit_percentage || '';
  editSpecForm['edit-spec-responsible'].value = spec.responsible || '';

  // Привязываем specId к иконке "new-position-specification",
  // чтобы при клике на неё мы знали, к какой спецификации создавать позицию
  const newPosBtn = editSpecModal.querySelector('[data-action="new-position-specification"]');
  if (newPosBtn) {
    newPosBtn.dataset.id = specId;
    console.log(`[LOG] openEditSpecModal: У кнопки .modal1-icon[new-position-specification] теперь data-id="${specId}"`);
  } else {
    console.log('[LOG] openEditSpecModal: Не найдена кнопка [data-action="new-position-specification"] внутри editSpecModal');
  }

  // Очищаем контейнер, куда вставляются позиции (если что-то там осталось от прошлого открытия)
  const specPositionsContainer = document.getElementById('specPositionsContainer');
  if (specPositionsContainer) {
    specPositionsContainer.innerHTML = '';
    console.log('[LOG] openEditSpecModal: Очищен div#specPositionsContainer');
  }

  // Загружаем позиции данной спецификации (например, из таблицы spec_positions)
  console.log(`[LOG] openEditSpecModal: Загружаем позиции для specification_id="${specId}"...`);
  loadSpecPositions(specId);

  // Показываем модальное окно
  editSpecModal.classList.remove('hidden');
  console.log('[LOG] openEditSpecModal: Модальное окно editSpecModal открыто');
}

  function closeEditSpecModal() {
    editSpecModal.classList.add('hidden');
    currentEditingSpec = null;
  }
  async function saveSpecification() {
    if (!currentEditingSpec) return;
    const updatedSpec = {
      specification_name: editSpecForm['edit-spec-name'].value,
      status: editSpecForm['edit-spec-status'].value,
      specification_amount: parseFloat(editSpecForm['edit-spec-amount'].value) || 0.00,
      specification_costs: parseFloat(editSpecForm['edit-spec-costs'].value) || 0.00,
      specification_profit: parseFloat(editSpecForm['edit-spec-profit'].value) || 0.00,
      profit_percentage: parseFloat(editSpecForm['edit-spec-profit-pct'].value) || 0.00,
      responsible: editSpecForm['edit-spec-responsible'].value,
    };
    console.log('[LOG] Сохраняем изменения спецификации:', currentEditingSpec.specification_id, updatedSpec);
    const { error } = await supabase
      .from('specifications')
      .update(updatedSpec)
      .eq('specification_id', currentEditingSpec.specification_id);

    if (error) {
      console.error('[LOG] Ошибка сохранения спецификации:', error);
    }
    closeEditSpecModal();
  }

  /**********************/
  // //Загрузка позиций и подпозиций
  async function loadSpecPositions(specId) {
    console.log('[LOG] Загружаем spec_positions для спецификации:', specId);
    const { data, error } = await supabase.from('spec_positions').select('*').eq('specification_id', specId);
    if (error) {
      console.error('[LOG] Ошибка загрузки позиций:', error);
      return;
    }
    if (data) {
      data.forEach(pos => createPositionInDom(pos));
    }
  }
  async function loadChildPositions(positionId) {
    const { data, error } = await supabase.from('spec_child_positions').select('*').eq('position_id', positionId);
    if (error) {
      console.error('[LOG] Ошибка загрузки дочерних позиций:', error);
      return;
    }
    if (data) {
      data.forEach(child => createChildPositionInDom(child));
    }
  }

  // //Создание DOM для позиции
  function createPositionInDom(positionData) {
    const specPositionsContainer = document.getElementById('specPositionsContainer');
    if (!specPositionsContainer) return null;

    const divPosition = document.createElement('div');
    divPosition.classList.add('modalPositionSpecification');
    divPosition.style.width = '168vw';
    divPosition.dataset.positionId = positionData.position_id;

    divPosition.innerHTML = `
      <div class="modalProjectCARD" style="width: 177vw; height: auto; flex-direction: row; margin-bottom: 0.6vw;">
        <div class="modalRow">
          <input class="inputCALC" type="text" placeholder="p / p agreement" style="width: 2.3vw;" value="${positionData.p_p_agreement || ''}"/>
          <input class="inputCALC" type="text" placeholder="Description Position agreement" style="width: 16vw;" value="${positionData.description_position_agreement || ''}"/>
          <input class="inputCALC" type="text" placeholder="q-ty agreement" style="width: 2.5vw;" value="${positionData.qty_agreement || ''}"/>
          <input class="inputCALC" type="text" placeholder="price no VAT agreement" style="width: 5.2vw;" value="${positionData.price_no_vat_agreement || ''}"/>
          <input class="inputCALC" type="text" placeholder="sum no VAT agreement" style="width: 5.2vw;" value="${positionData.sum_no_vat_agreement || ''}"/>
          <input class="inputCALC" type="text" placeholder="price VAT agreement" style="width: 5.2vw;" value="${positionData.price_vat_agreement || ''}"/>
          <input class="inputCALC" type="text" placeholder="sum VAT agreement" style="width: 5.2vw;" value="${positionData.sum_vat_agreement || ''}"/>
          
          <!-- Иконка Удалить позицию -->
          <span class="spec-icon" style="font-size: 0.7vw; position: relative; display: inline-block;" data-action="delete-position-spec" data-position-id="${positionData.position_id}">
            <i class="material-symbols-outlined">delete</i>
          </span>
          
          <!-- Иконка скрыть/отобразить подпозиции -->
          <label class="switch">
            <input type="checkbox">
            <span class="slider"></span>
          </label>
          
          <!-- Иконка Создать дочернюю позицию -->
          <span class="modal1-icon" style="font-size: 0.7vw; position: relative; display: inline-block;" data-action="new-child-position" data-position-id="${positionData.position_id}">
            <i class="material-symbols-outlined">note_add</i>
          </span>
          
          <div class="modalColumn" style="height: auto; width: 93vw;">
            <div class="modalRow" id="ModalSumPosition">
            </div>
            <!-- контейнер для дочерних позиций -->
            <div class="modalRow-child-list" style="flex-direction: column;">
            </div>
          </div>
          
          <input class="inputCALC" type="text" placeholder="price no VAT margin" style="width: 5.2vw;" value="${positionData.price_no_vat_margin || ''}"/>
          <input class="inputCALC" type="text" placeholder="sum no VAT margin" style="width: 5.2vw;" value="${positionData.sum_no_vat_margin || ''}"/>
          <input class="inputCALC" type="text" placeholder="price VAT margin" style="width: 5.2vw;" value="${positionData.price_vat_margin || ''}"/>
          <input class="inputCALC" type="text" placeholder="sum VAT margin" style="width: 5.2vw;" value="${positionData.sum_vat_margin || ''}"/>
        </div>
      </div>
    `;
    specPositionsContainer.appendChild(divPosition);

    // Загружаем дочерние
    loadChildPositions(positionData.position_id);
    return divPosition;
  }
  // //Создание DOM для дочерней позиции
  // //функция создать DOM для дочерней позиции (изменённая)
function createChildPositionInDom(childData) {
  // Находим родительский блок по position_id
  const parentDiv = document.querySelector(`[data-position-id="${childData.position_id}"]`);
  if (!parentDiv) return null;

  // Внутри него ищем контейнер .modalRow-child-list
  const childList = parentDiv.querySelector('.modalRow-child-list');
  if (!childList) return null;

  // Создаём элемент для подпозиции
  const divChild = document.createElement('div');
  divChild.classList.add('modalRow');
  divChild.id = 'ModalChildPosition';
  divChild.dataset.childPositionId = childData.child_position_id || '';

  // Для плавного сдвига (анимации высоты), изначально высота = 0
  divChild.style.overflow = 'hidden';
  divChild.style.height = '0px';
  divChild.style.transition = 'height 0.3s ease';

  // Вставляем всю вашу разметку
  divChild.innerHTML = `
    <!-- Иконка Удалить подпозицию -->
    <span class="spec-icon" data-action="delete-child-position" data-child-position-id="${childData.child_position_id}">
      <i class="material-symbols-outlined">delete</i>
    </span>
    <input class="inputCALC" type="text" placeholder="p / p ChildPosition" style="width: 2.3vw;" value="${childData.p_p_child_position || ''}" />
    <input class="inputCALC" type="text" placeholder="Catalog Position ChildPosition" style="width: 6vw;" value="${childData.catalog_position_child || ''}" />
    <input class="inputCALC" type="text" placeholder="Description Position ChildPosition" style="width: 16vw;" value="${childData.description_position_child || ''}" />
    <input class="inputCALC" type="text" placeholder="q-ty ChildPosition" style="width: 2.5vw;" value="${childData.qty_child || ''}" />
    <input class="inputCALC" type="text" placeholder="supplier name ChildPosition" style="width: 8vw;" value="${childData.supplier_name_child || ''}" />
    <input class="inputCALC" type="text" placeholder="Catalog Position ChildPosition" style="width: 6vw;" />
    <input class="inputCALC" type="text" placeholder="WAT ChildPosition" style="width: 2.5vw;" value="${childData.vat_child || ''}" />
    <input class="inputCALC" type="text" placeholder="RUB ChildPosition" style="width: 5.2vw;" value="${childData.rub_child || ''}" />
    <input class="inputCALC" type="text" placeholder="USD ChildPosition" style="width: 5.2vw;" value="${childData.usd_child || ''}" />
    <input class="inputCALC" type="text" placeholder="EUR ChildPosition" style="width: 5.2vw;" value="${childData.eur_child || ''}" />
    <input class="inputCALC" type="text" placeholder="price no VAT ChildPosition" style="width: 5.2vw;" value="${childData.price_no_vat_child || ''}" />
    <input class="inputCALC" type="text" placeholder="sum no VAT ChildPosition" style="width: 5.2vw;" value="${childData.sum_no_vat_child || ''}" />
    <input class="inputCALC" type="text" placeholder="price VAT ChildPosition" style="width: 5.2vw;" value="${childData.price_vat_child || ''}" />
    <input class="inputCALC" type="text" placeholder="sum VAT ChildPosition" style="width: 5.2vw;" value="${childData.sum_vat_child || ''}" />
  `;

  // Добавляем во вложенный контейнер
  childList.appendChild(divChild);

  // Запускаем анимацию плавного "раскрытия" (увеличения высоты)
  requestAnimationFrame(() => {
    // вычисляем натуральную высоту контента
    const realHeight = divChild.scrollHeight + 'px';
    // устанавливаем эту высоту => контент плавно сдвинется
    divChild.style.height = realHeight;
  });

  return divChild;
}


  /**********************/
  // //Добавить новую позицию или подпозицию
  async function addNewPositionSpec(specificationId) {
    const newPositionData = {
      specification_id: specificationId,
      p_p_agreement: '',
      description_position_agreement: '',
      qty_agreement: 0,
      price_no_vat_agreement: 0,
      sum_no_vat_agreement: 0,
      price_vat_agreement: 0,
      sum_vat_agreement: 0,
      price_no_vat_margin: 0,
      sum_no_vat_margin: 0,
      price_vat_margin: 0,
      sum_vat_margin: 0
    };
    const { data, error } = await supabase
      .from('spec_positions')
      .insert([newPositionData])
      .select();
    if (error) {
      console.error('[LOG] Ошибка при создании позиции:', error);
      return;
    }
    if (data && data.length > 0) {
      createPositionInDom(data[0]);
    }
  }
  async function addNewChildPosition(positionId) {
    const newChildData = {
      position_id: positionId,
      p_p_child_position: '',
      catalog_position_child: '',
      description_position_child: '',
      qty_child: 0,
      supplier_name_child: '',
      vat_child: 0,
      rub_child: 0,
      usd_child: 0,
      eur_child: 0,
      price_no_vat_child: 0,
      sum_no_vat_child: 0,
      price_vat_child: 0,
      sum_vat_child: 0
    };
    const { data, error } = await supabase
      .from('spec_child_positions')
      .insert([newChildData])
      .select();
    if (error) {
      console.error('[LOG] Ошибка при создании дочерней позиции:', error);
      return;
    }
    if (data && data.length > 0) {
      // createChildPositionInDom(data[0]);
    }
  }

  /**********************/
  // //Realtime для projects и specifications (как в вашем исходном коде)
  // Если у вас уже есть эта функция setupRealtime(), сохраняйте её. Ниже — пример:
  function setupRealtime() {
    // Подписка на таблицу projects
    const channelProjects = supabase
      .channel('realtime_projects')
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'projects' },
        (payload) => {
          const projectId = payload.new?.project_id || payload.old?.project_id;
          if (!projectId) return;

          if (payload.eventType === 'INSERT' && payload.new) {
            console.log('[LOG] Realtime: INSERT project:', payload.new);
            // Добавляем DOM-элемент, если ещё нет
            if (!projectsContainer.querySelector(`[data-id="${projectId}"]`)) {
              const block = createProjectContainer(payload.new);
              if (block) projectsContainer.appendChild(block);
            }
          } else if (payload.eventType === 'UPDATE' && payload.new) {
            console.log('[LOG] Realtime: UPDATE project:', payload.new);
            const projectContainer = projectsContainer.querySelector(`[data-id="${projectId}"]`);
            if (projectContainer) {
              const updatedProject = payload.new;
              // Обновляем data-атрибуты + поля
              projectContainer.dataset.projectName = updatedProject.project_name || '';
              projectContainer.dataset.status = updatedProject.status || '';
              projectContainer.dataset.contractAmount = updatedProject.contract_amount || 0;
              projectContainer.dataset.contractCosts = updatedProject.contract_costs || 0;
              projectContainer.dataset.contractProfit = updatedProject.contract_profit || 0;
              projectContainer.dataset.profitPercentage = updatedProject.profit_percentage || 0;
              projectContainer.dataset.companySeller = updatedProject.company_seller || '';
              projectContainer.dataset.tinSeller = updatedProject.tin_seller || '';
              projectContainer.dataset.buyerCompany = updatedProject.buyer_company || '';
              projectContainer.dataset.tinBuyer = updatedProject.tin_buyer || '';

              const fields = [
                'project_id',
                'project_name',
                'status',
                'contract_amount',
                'contract_costs',
                'contract_profit',
                'profit_percentage',
                'company_seller',
                'tin_seller',
                'buyer_company',
                'tin_buyer'
              ];
              fields.forEach(field => {
                const input = projectContainer.querySelector(`[data-field="${field}"]`);
                if (input) {
                  if (['contract_amount','contract_costs','contract_profit','profit_percentage'].includes(field)) {
                    input.value = formatNumberWithSpaces(updatedProject[field]) || 0;
                  } else {
                    input.value = updatedProject[field] ?? '';
                  }
                }
              });
            }
          } else if (payload.eventType === 'DELETE') {
            console.log('[LOG] Realtime: DELETE project:', payload.old);
            const projectContainer = projectsContainer.querySelector(`[data-id="${projectId}"]`);
            if (projectContainer) {
              const projectBlock = projectContainer.closest('.project-block');
              if (projectBlock) {
                projectsContainer.removeChild(projectBlock);
              }
            }
            hideLoader();
          }
        }
      )
      .subscribe();

    // Подписка на таблицу specifications
    const channelSpecs = supabase
      .channel('realtime_specifications')
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'specifications' },
        (payload) => {
          const specId = payload.new?.specification_id || payload.old?.specification_id;
          if (!specId) return;

          if (payload.eventType === 'INSERT' && payload.new) {
            console.log('[LOG] Realtime: INSERT specification:', payload.new);
            const projectId = payload.new.project_id;
            const projectContainer = document.querySelector(`[data-id="${projectId}"]`);
            if (projectContainer) {
              const projectBlock = projectContainer.closest('.project-block');
              const specsWrapper = projectBlock?.querySelector('.specifications-wrapper');
              if (specsWrapper) {
                const specEl = createSpecificationContainer(payload.new);
                if (specEl) {
                  specsWrapper.appendChild(specEl);
                }
              }
            }
          } else if (payload.eventType === 'UPDATE' && payload.new) {
            console.log('[LOG] Realtime: UPDATE specification:', payload.new);
            const specElem = document.querySelector(`[data-spec-id="${specId}"]`);
            if (specElem) {
              const updatedSpec = payload.new;
              specElem.dataset.specificationName = updatedSpec.specification_name || '';
              specElem.dataset.status = updatedSpec.status || '';
              specElem.dataset.specificationAmount = updatedSpec.specification_amount || 0;
              specElem.dataset.specificationCosts = updatedSpec.specification_costs || 0;
              specElem.dataset.specificationProfit = updatedSpec.specification_profit || 0;
              specElem.dataset.profitPercentage = updatedSpec.profit_percentage || 0;
              specElem.dataset.responsible = updatedSpec.responsible || '';

              const specNameInput = specElem.querySelector('[data-field="specification_name"]');
              const specStatusInput = specElem.querySelector('[data-field="status"]');
              const specAmountInput = specElem.querySelector('[data-field="specification_amount"]');
              const specCostsInput = specElem.querySelector('[data-field="specification_costs"]');
              const specProfitInput = specElem.querySelector('[data-field="specification_profit"]');
              const specProfitPctInput = specElem.querySelector('[data-field="profit_percentage"]');
              const responsibleInput = specElem.querySelector('[data-field="responsible"]');

              if (specNameInput) specNameInput.value = updatedSpec.specification_name || '';
              if (specStatusInput) specStatusInput.value = updatedSpec.status || '';
              if (specAmountInput) specAmountInput.value = formatNumberWithSpaces(updatedSpec.specification_amount) || 0;
              if (specCostsInput) specCostsInput.value = formatNumberWithSpaces(updatedSpec.specification_costs) || 0;
              if (specProfitInput) specProfitInput.value = formatNumberWithSpaces(updatedSpec.specification_profit) || 0;
              if (specProfitPctInput) specProfitPctInput.value = formatNumberWithSpaces(updatedSpec.profit_percentage) || 0;
              if (responsibleInput) responsibleInput.value = updatedSpec.responsible || '';
            }
          } else if (payload.eventType === 'DELETE') {
            console.log('[LOG] Realtime: DELETE specification:', payload.old);
            const specElem = document.querySelector(`[data-spec-id="${specId}"]`);
            if (specElem) {
              specElem.remove();
            }
            hideLoader();
          }
        }
      )
      .subscribe();

    channelProjects.on('subscription_error', (status) => {
      console.error('[LOG] Ошибка подписки (projects):', status);
    });
    channelSpecs.on('subscription_error', (status) => {
      console.error('[LOG] Ошибка подписки (specifications):', status);
    });
  }

  /**********************/
  // //Realtime для spec_positions
  function setupRealtimePositions() {
    const channelPositions = supabase
      .channel('realtime_spec_positions')
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'spec_positions' },
        (payload) => {
          const positionId = payload.new?.position_id || payload.old?.position_id;
          if (!positionId) return;

          if (payload.eventType === 'INSERT' && payload.new) {
            console.log('[LOG] Realtime: INSERT spec_positions:', payload.new);
            // Если окно спецификации открыто и совпадает specification_id
            if (currentEditingSpec && currentEditingSpec.specification_id === payload.new.specification_id) {
              createPositionInDom(payload.new);
            }
          }
          else if (payload.eventType === 'UPDATE' && payload.new) {
            console.log('[LOG] Realtime: UPDATE spec_positions:', payload.new);
            const divPosition = document.querySelector(`[data-position-id="${positionId}"]`);
            if (divPosition) {
              // Обновить значения, если нужно (аналогично, как выше)
              // ...
            }
          }
          else if (payload.eventType === 'DELETE') {
            console.log('[LOG] Realtime: DELETE spec_positions:', payload.old);
            const divPosition = document.querySelector(`[data-position-id="${positionId}"]`);
            if (divPosition) {
              divPosition.remove();
            }
            hideLoader();
          }
        }
      )
      .subscribe();

    channelPositions.on('subscription_error', (status) => {
      console.error('[LOG] Ошибка подписки (spec_positions):', status);
    });
  }

  /**********************/
  // //Realtime для spec_child_positions
  function setupRealtimeChildPositions() {
    const channelChildPositions = supabase
      .channel('realtime_spec_child_positions')
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'spec_child_positions' },
        (payload) => {
          const childId = payload.new?.child_position_id || payload.old?.child_position_id;
          if (!childId) return;

          if (payload.eventType === 'INSERT' && payload.new) {
            console.log('[LOG] Realtime: INSERT spec_child_positions:', payload.new);
            // Если родительская позиция отображается:
            const parentPositionId = payload.new.position_id;
            const parentDiv = document.querySelector(`[data-position-id="${parentPositionId}"]`);
            if (parentDiv) {
              createChildPositionInDom(payload.new);
            }
          }
          else if (payload.eventType === 'UPDATE' && payload.new) {
            console.log('[LOG] Realtime: UPDATE spec_child_positions:', payload.new);
            const childDiv = document.querySelector(`[data-child-position-id="${childId}"]`);
            if (childDiv) {
              // Обновить поля, если нужно
              // ...
            }
          }
          else if (payload.eventType === 'DELETE') {
            console.log('[LOG] Realtime: DELETE spec_child_positions:', payload.old);
            const childDiv = document.querySelector(`[data-child-position-id="${childId}"]`);
            if (childDiv) {
              childDiv.remove();
            }
            hideLoader();
          }
        }
      )
      .subscribe();

    channelChildPositions.on('subscription_error', (status) => {
      console.error('[LOG] Ошибка подписки (spec_child_positions):', status);
    });
  }

  /**********************/
  // //Настройка событий

  if (addProjectButton) {
    addProjectButton.addEventListener('click', addNewProject);
  }

  // Общий обработчик кликов по списку проектов
  projectsContainer.addEventListener('click', (event) => {
    const iconProject = event.target.closest('.modal1-icon');
    if (iconProject) {
      const action = iconProject.dataset.action;
      const projectId = iconProject.dataset.id;
      if (action === 'delete') {
        deleteProject(projectId);
      } else if (action === 'edit') {
        openEditModal(projectId);
      } else if (action === 'new-specificstion') {
        addNewSpecification(projectId);
      }
      return;
    }
    const iconSpec = event.target.closest('.spec-icon');
    if (iconSpec) {
      const specAction = iconSpec.dataset.action;
      const specId = iconSpec.dataset.specId;
      if (specAction === 'delete-spec') {
        deleteSpecification(specId);
      } else if (specAction === 'edit-spec') {
        openEditSpecModal(specId);
      }
    }
  });

  // Кнопки закрыть/сохранить (проект)
  document.querySelector('.close-edit-modal').addEventListener('click', closeEditModal);
  editForm.querySelector('.save-button').addEventListener('click', saveProject);

  // Кнопки закрыть/сохранить (спецификация)
  document.querySelector('.close-edit-spec-modal').addEventListener('click', closeEditSpecModal);
  editSpecForm.querySelector('.save-spec-button').addEventListener('click', saveSpecification);

  // Обработчик кликов внутри editSpecModal (для позиций/подпозиций)
  // //обработчик кликов внутри модалки редактирования спецификации
const editSpecModalEl = document.getElementById('editSpecModal');
editSpecModalEl.addEventListener('click', async (event) => {
  // Чтобы видеть, что вообще дошли до этого обработчика
  console.log('[LOG] editSpecModal CLICK handler сработал. event target:', event.target);

  // 1) Кнопка "new-position-specification"
  const newPosBtn = event.target.closest('[data-action="new-position-specification"]');
  if (newPosBtn) {
    // Логируем факт, что нашли кнопку
    console.log('[LOG] Обнаружена кнопка "new-position-specification":', newPosBtn);

    // Считываем из неё specId
    const specId = newPosBtn.dataset.id;
    console.log('[LOG] Значение newPosBtn.dataset.id =', specId);

    // Проверяем, есть ли specId
    if (specId) {
      console.log('[LOG] Вызываем addNewPositionSpec(specId) c specId =', specId);
      await addNewPositionSpec(specId);
    } else {
      console.log('[LOG] specId оказался пустым! Позиция не будет создана.');
    }
    return; // прерываем дальнейшую обработку
  }

  // 2) Кнопка "new-child-position"
  const newChildBtn = event.target.closest('[data-action="new-child-position"]');
  if (newChildBtn) {
    console.log('[LOG] Обнаружена кнопка "new-child-position":', newChildBtn);
    const parentPositionId = newChildBtn.dataset.positionId;
    console.log('[LOG] newChildBtn.dataset.positionId =', parentPositionId);
    if (parentPositionId) {
      console.log('[LOG] Вызываем addNewChildPosition(parentPositionId) c positionId =', parentPositionId);
      await addNewChildPosition(parentPositionId);
    } else {
      console.log('[LOG] parentPositionId оказался пустым! Дочерняя позиция не будет создана.');
    }
    return;
  }

  // 3) Кнопка "delete-position-spec"
  const delPosBtn = event.target.closest('[data-action="delete-position-spec"]');
  if (delPosBtn) {
    console.log('[LOG] Обнаружена кнопка "delete-position-spec":', delPosBtn);
    const positionId = delPosBtn.dataset.positionId;
    console.log('[LOG] delPosBtn.dataset.positionId =', positionId);
    if (positionId) {
      console.log('[LOG] Удаляем позицию:', positionId);
      showLoader();
      const { error } = await supabase.from('spec_positions').delete().eq('position_id', positionId);
      if (error) {
        console.error('[LOG] Ошибка удаления позиции:', error);
      }
      hideLoader();
    } else {
      console.log('[LOG] positionId пуст — позиция не удалена.');
    }
    return;
  }

  // 4) Кнопка "delete-child-position"
  const delChildBtn = event.target.closest('[data-action="delete-child-position"]');
  if (delChildBtn) {
    console.log('[LOG] Обнаружена кнопка "delete-child-position":', delChildBtn);
    const childPositionId = delChildBtn.dataset.childPositionId;
    console.log('[LOG] delChildBtn.dataset.childPositionId =', childPositionId);
    if (childPositionId) {
      console.log('[LOG] Удаляем дочернюю позицию:', childPositionId);
      showLoader();
      const { error } = await supabase.from('spec_child_positions').delete().eq('child_position_id', childPositionId);
      if (error) {
        console.error('[LOG] Ошибка удаления дочерней позиции:', error);
      }
      hideLoader();
    } else {
      console.log('[LOG] childPositionId пуст — подпозиция не удалена.');
    }
    return;
  }

  // Если ни одна из кнопок не обнаружена — ничего не делаем
  console.log('[LOG] Клик внутри editSpecModal, но не по нужной кнопке.');
});


  /**********************/
  // //Запуск при загрузке
  loadProjects()
    .then(loadSpecifications)
    .then(() => {
      // Подписки в реальном времени
      setupRealtime();            // projects + specifications
      setupRealtimePositions();   // spec_positions
      setupRealtimeChildPositions(); // spec_child_positions
    });

  /**********************/
  // //Закрыть главное окно (пример)
  function closeModal() {
    document.querySelector('.modal111-content').style.display = 'none';
  }
</script>
