<!-- /pages/modal1.html -->
<button class="close-modal" onclick="closeModal()">×</button>
<div class="modal111-content" style="justify-content: flex-start;">
  <h2 class="modal1-title">ELABORATION SALES</h2>
  <p class="modal1-subtitle">проекты в работе</p>
  <!-- Дополнительный контент -->
  
  <!-- модальное окно проектов -->
  <div id="modalBottom" class="modalVNUT" style="top: 4.5vw; left: 6vw; right: 2vw; height: calc(100vh - 6.4vw); width: 100%;">
    <div id="projectsList" class="modalVNUT-content">
    </div>
  </div>
  
  <!-- Разметка КОНТЕЙНЕРА -->
  <template id="project-template">
    <div class="modal1-container" data-id="">
      <span class="modal1-icon project_id"><i class="material-symbols-outlined">developer_guide</i></span>
      <span class="modal1-icon project_name"><i class="material-symbols-outlined">data_table</i></span>

      <!-- Группы ввода данных -->
      <div class="modal1-input-group left">
        <input type="text" class="modal1-input project_id" id="modal1-project-id" placeholder=" " />
        <label for="modal1-project-id">project ID</label>
      </div>

      <div class="modal1-input-group right">
        <input type="text" class="modal1-input project_name" id="modal1-project-name" placeholder=" " />
        <label for="modal1-project-name">project name</label>
      </div>

      <div class="modal1-input-group right">
        <input type="text" class="modal1-input status" id="modal1-status" placeholder=" " />
        <label for="modal1-status">status</label>
      </div>

      <div class="modal1-input-group left">
        <input type="text" class="modal1-input contract_amount" id="modal1-contract-amount" placeholder=" " />
        <label for="modal1-contract-amount">contract amount</label>
      </div>

      <div class="modal1-input-group right">
        <input type="text" class="modal1-input contract_costs" id="modal1-contract-costs" placeholder=" " />
        <label for="modal1-contract-costs">contract costs</label>
      </div>

      <div class="modal1-input-group right">
        <input type="text" class="modal1-input contract_profit" id="modal1-contract-profit" placeholder=" " />
        <label for="modal1-contract-profit">contract profit</label>
      </div>

      <div class="modal1-input-group right">
        <input type="text" class="modal1-input profit_percentage" id="modal1-profit-percentage" placeholder=" " />
        <label for="modal1-profit-percentage">profit %</label>
      </div>

      <div class="modal1-input-group left">
        <input type="text" class="modal1-input company_seller" id="modal1-company-seller" placeholder=" " />
        <label for="modal1-company-seller">company seller</label>
      </div>

      <div class="modal1-input-group right">
        <input type="text" class="modal1-input tin_seller" id="modal1-tin-seller" placeholder=" " />
        <label for="modal1-tin-seller">TIN seller</label>
      </div>

      <div class="modal1-input-group left">
        <input type="text" class="modal1-input buyer_company" id="modal1-buyer-company" placeholder=" " />
        <label for="modal1-buyer-company">buyer company</label>
      </div>

      <div class="modal1-input-group right">
        <input type="text" class="modal1-input tin_buyer" id="modal1-tin-buyer" placeholder=" " />
        <label for="modal1-tin-buyer">TIN buyer</label>
      </div>

      <!-- Кнопка удаления проекта -->
      <span class="material-symbols-outlined delete-project" title="Удалить проект">delete</span>
    </div>
  </template>
</div>

<style>
.close-modal {
    position: absolute;
    top: 0.5vw;
    right: 0.5vw;
    background: none;
    border: none;
    font-size: 1vw;
    cursor: pointer;
    color: var(--white-color2);
  }

  .close-modal:hover {
    color: #393E41;
  }

  .modal111-content {
    font-family: "Comfortaa", sans-serif;
    color: var(--white-color2);
    background-color: none; /* Белый фон для контента */
    border-radius: var(--borderRadius);
    height: calc(100vh - (var(--spacer)*2));
    width: calc(100vw - (var(--spacer)*6));
    box-sizing: border-box;
    position: relative;
    pading: 1vw
  }

  /* Заголовок */
.modal1-title {
  color: var(--white-color2);
  font-size: 0.7vw;
  margin-top: 1vw;
  margin-left: 1vw;
  display: flex
}

/* Подзаголовок */
.modal1-subtitle {
  color: var(--white-color2);
  font-size: 0.45vw;
  margin-top: 0.2vw;
  margin-left: 1vw;
  display: flex
}

  /* Если необходимо выровнять h2 и p внутри flex-контейнера, можно добавить */
.modal1-content h2,
.modal1-content p {
  align-self: flex-start;
  display: flex
}
  
  
  
  /* _______________________________  стили модального окна с прокруткой / скроллом */
  
  /* Модальное окно с прокруткой */
.modalVNUT {
  display: flex;
  position: fixed;
  background: none;
  padding: 0vw;
  border-radius: 0.4vw;
  border: 1px solid rgba(255, 255, 255, 0.18);
  color: black;
  z-index: 1000;
  overflow: hidden; /* Отключаем общий скролл */
  box-sizing: border-box;
}

/* Внутренний контейнер с прокруткой */
.modalVNUT-content {
  padding: 0.5vh 2vh 0vw 0vw; /* Отступы внутри модального окна */
  height: 100%;
  width: 100%;
  overflow-y: auto; /* Включаем вертикальную прокрутку */
  box-sizing: border-box;
}

/* Стилизация скроллбара */
.modalVNUT-content::-webkit-scrollbar {
  width: 4px; /* Ширина скроллбара */
  background-color: var(--scrollbar-color);
}

.modalVNUT-content::-webkit-scrollbar-thumb {
  background-color: var(--scrollbar-thumb-color); /* Цвет ползунка */
  border-radius: 10px; /* Скругление */
}

.modalVNUT-content::-webkit-scrollbar-track {
  background-color: var(--scrollbar-color);
}
  
  /* Внутренний контейнер с прокруткой */
.modalVNUT-content {
  padding: 0.5vh 2vh 0vw 0vw; /* Отступы внутри модального окна */
  height: 100%;
  width: 100%;
  overflow-y: auto; /* Включаем вертикальную прокрутку */
  box-sizing: border-box;
}

/* Стилизация скроллбара */
.modalVNUT-content::-webkit-scrollbar {
  width: 4px; /* Ширина скроллбара */
  background-color: var(--scrollbar-color);
}

.modalVNUT-content::-webkit-scrollbar-thumb {
  background-color: var(--scrollbar-thumb-color); /* Цвет ползунка */
  border-radius: 10px; /* Скругление */
}

.modalVNUT-content::-webkit-scrollbar-track {
  background-color: var(--scrollbar-color);
}



  /* _____________________________________________________________________    Контейнеры внутри модального окна */

  .modal1-container {
    display: flex;
    align-items: center; /* Центрирование по вертикали */
    padding: 0.4vw;
    border-radius: var(--borderRadius);
    color: var(--white-color2);
    z-index: 1100;
    box-sizing: border-box;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.18);
    width: 100%; /* Ширина контейнера остается неизменной */
    height: 2.1vw;
    transform: scale(0.8); /* Уменьшаем все элементы внутри контейнера на 30% */
    transform-origin: top left; /* Сохраняем ширину контейнера */
  }

  .modal1-container:hover,
  .modal1-container:focus {
    border: 1px solid var(--white-color2);
  }

  /* Отступы только между контейнерами */
  .modal1-container:not(:last-child) {
    margin-bottom: 0.5vw; /* Отступ снизу только между контейнерами */
  }

  /* Иконки */
  .modal1-icon {
    color: rgba(255, 255, 255, 0.6);
    font-size: 1.4vw; /* Уменьшено на 30% */
    margin-right: 0.175vw; /* Уменьшено на 30% */
    cursor: pointer;
    display: flex;
    align-items: center; /* Центрирование иконок по вертикали */
  }

  .modal1-icon:hover {
    color: var(--white-color2);
    transform: scale(0.7 * 1.1); /* Увеличение иконки при наведении с учетом масштаба */
  }

  .modal1-icon:active {
    transform: scale(0.7 * 0.92); /* Сжатие иконки при клике с учетом масштаба */
  }

  /* Input группы */
  .modal1-input-group {
    position: relative;
    font-family: "Comfortaa", sans-serif;
  }

  .modal1-input-group.left {
    margin-left: 1.54vw; /* Уменьшено на 30% от 2.2vw */
  }

  .modal1-input-group.right {
    margin-left: 0.28vw; /* Уменьшено на 30% от 0.4vw */
  }

  .modal1-input-group label {
    background: none;
    color: rgba(255, 255, 255, 0.6);
    position: absolute;
    top: 0.61vw; /* Уменьшено на 30% от 0.86vw */
    left: 0.28vw; /* Уменьшено на 30% от 0.4vw */
    transform: translateY(-50%);
    text-transform: uppercase;
    font-weight: 700;
    pointer-events: none;
    font-size: 0.42vw; /* Уменьшено на 30% от 0.6vw */
    transition: all 0.3s;
  }

  .modal1-input-group .modal1-input {
    padding: 0.28vw 0.28vw; /* Уменьшено на 30% от 0.4vw */
    width: 100%;
    border: 1px solid rgba(255, 255, 255, 0.18);
    outline: none;
    color: var(--white-color2);
    font-size: 0.49vw; /* Уменьшено на 30% от 0.7vw */
    font-family: inherit;
    background-color: transparent;
    border-radius: 7px; /* Уменьшено на 30% от 10px → 7px */
  }

  .modal1-input-group .modal1-input:hover,
  .modal1-input-group .modal1-input:focus {
    border: 1px solid var(--white-color2);
  }

  .modal1-input-group .modal1-input:focus + label,
  .modal1-input-group .modal1-input:not(:placeholder-shown) + label {
    top: -0.35vw; /* Уменьшено на 30% от -0.5vw */
    font-size: 0.28vw; /* Уменьшено на 30% от 0.4vw */
    padding: 0 0.28vw; /* Уменьшено на 30% от 0.4vw */
    background: rgba(0, 0, 0, 0.5);
    border-radius: 7px; /* Уменьшено на 30% от 10px → 7px */
    color: var(--white-color2);
  }

  /* Input заголовок без границ */
  .modal1-input-TYPE1 {
    position: relative;
    font-family: "Comfortaa", sans-serif;
    width: 1.4vw; /* Уменьшено на 30% от 2vw */
    border: none;
    outline: none;
    color: rgba(255, 255, 255, 0.6);
    background-color: transparent;
    margin-top: 0.7vw; /* Уменьшено на 30% от 1vw */
  }

  /* Иконки внутри контейнера */
  .modal1-icon {
    color: rgba(255, 255, 255, 0.6);
    font-size: 1.4vw; /* Уменьшено на 30% от 2vw */
    margin-right: 0.175vw; /* Уменьшено на 30% от 0.25vw */
    cursor: pointer;
    display: flex;
    align-items: center; /* Центрирование иконок по вертикали */
  }

  .modal1-icon:hover {
    color: var(--white-color2);
    transform: scale(1.1); /* Увеличение иконки при наведении */
  }

  .modal1-icon:active {
    transform: scale(0.92); /* Сжатие иконки при клике */
  }



  /* __________________________________________________________ стили для нового функционала */

  .add-project-button {
    margin: 1vw;
    padding: 0.5vw 1vw;
    background-color: var(--white-color1);
    color: var(--black-color);
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.4vw;
    transition: background-color 0.3s;
  }

  .add-project-button:hover {
    background-color: var(--white-color2);
  }


  
  
</style>


<script type="module">
  // Инициализация Supabase
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const SUPABASE_URL = 'https://lhgwxwsawnmstplseokz.supabase.co'; 
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxoZ3d4d3Nhd25tc3RwbHNlb2t6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQzNzkxNDgsImV4cCI6MjA0OTk1NTE0OH0.yfvxLZEdkA2tGmz5ga5uZajT9xN-SbRqpy3t1S3jusA';  
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const projectsList = document.getElementById('projectsList');
  const projectTemplate = document.getElementById('project-template');

  // Функция для создания элемента проекта из шаблона
  function createProjectElement(project) {
    const projectClone = projectTemplate.content.cloneNode(true);
    const projectContainer = projectClone.querySelector('.modal1-container');
    projectContainer.setAttribute('data-id', project.id);

    // Заполнение полей данными проекта
    projectContainer.querySelector('.project_id').value = project.project_id || '';
    projectContainer.querySelector('.project_name').value = project.project_name || '';
    projectContainer.querySelector('.status').value = project.status || '';
    projectContainer.querySelector('.contract_amount').value = project.contract_amount || '';
    projectContainer.querySelector('.contract_costs').value = project.contract_costs || '';
    projectContainer.querySelector('.contract_profit').value = project.contract_profit || '';
    projectContainer.querySelector('.profit_percentage').value = project.profit_percentage || '';
    projectContainer.querySelector('.company_seller').value = project.company_seller || '';
    projectContainer.querySelector('.tin_seller').value = project.tin_seller || '';
    projectContainer.querySelector('.buyer_company').value = project.buyer_company || '';
    projectContainer.querySelector('.tin_buyer').value = project.tin_buyer || '';

    // Добавление обработчиков событий для автосохранения
    const inputs = projectContainer.querySelectorAll('input');
    inputs.forEach(input => {
      input.addEventListener('input', () => {
        const field = input.classList[1]; // предполагается, что второй класс соответствует полю
        handleInputChange(project.id, field, input.value);
      });
    });

    // Добавление обработчика для удаления проекта
    const deleteButton = projectContainer.querySelector('.delete-project');
    deleteButton.addEventListener('click', () => deleteProject(project.id));

    return projectClone;
  }

  // Загрузка проектов из Supabase
  async function loadProjects() {
    const { data, error } = await supabase
      .from('projects')
      .select('*');

    if (error) {
      console.error('Ошибка загрузки проектов:', error);
      return;
    }

    projectsList.innerHTML = ''; // Очистка списка перед загрузкой

    data.forEach(project => {
      const projectElement = createProjectElement(project);
      projectsList.appendChild(projectElement);
    });
  }

  // Добавление нового проекта
  async function addNewProject() {
    const newProject = {
      project_id: `PID-${Date.now()}`, // Пример уникального ID
      project_name: '',
      status: '',
      contract_amount: 0,
      contract_costs: 0,
      contract_profit: 0,
      profit_percentage: 0,
      company_seller: '',
      tin_seller: '',
      buyer_company: '',
      tin_buyer: ''
    };

    const { data, error } = await supabase
      .from('projects')
      .insert([newProject])
      .single();

    if (error) {
      console.error('Ошибка добавления проекта:', error);
      return;
    }

    // Проект автоматически добавится через подписку на реальное время
  }

  // Удаление проекта
  async function deleteProject(projectId) {
    const { error } = await supabase
      .from('projects')
      .delete()
      .eq('id', projectId);

    if (error) {
      console.error('Ошибка удаления проекта:', error);
    }
    // Проект автоматически удалится через подписку на реальное время
  }

  // Обработка изменений в полях ввода (автосохранение)
  async function handleInputChange(projectId, field, value) {
    const updates = {};
    updates[field] = value;
    updates['updated_at'] = new Date().toISOString();

    const { error } = await supabase
      .from('projects')
      .update(updates)
      .eq('id', projectId);

    if (error) {
      console.error(`Ошибка обновления проекта ${projectId}:`, error);
    }
  }

  // Подписка на изменения в таблице projects (реальное время)
  function subscribeToProjects() {
    supabase
      .from('projects')
      .on('*', payload => {
        console.log('Изменение в projects:', payload);
        switch (payload.eventType) {
          case 'INSERT':
            addProjectToList(payload.new);
            break;
          case 'UPDATE':
            updateProjectInList(payload.new);
            break;
          case 'DELETE':
            removeProjectFromList(payload.old.id);
            break;
          default:
            break;
        }
      })
      .subscribe();
  }

  // Добавление проекта в список
  function addProjectToList(project) {
    const projectElement = createProjectElement(project);
    projectsList.appendChild(projectElement);
  }

  // Обновление проекта в списке
  function updateProjectInList(project) {
    const projectContainer = projectsList.querySelector(`.modal1-container[data-id='${project.id}']`);
    if (projectContainer) {
      // Обновляем значения полей
      projectContainer.querySelector('.project_id').value = project.project_id || '';
      projectContainer.querySelector('.project_name').value = project.project_name || '';
      projectContainer.querySelector('.status').value = project.status || '';
      projectContainer.querySelector('.contract_amount').value = project.contract_amount || '';
      projectContainer.querySelector('.contract_costs').value = project.contract_costs || '';
      projectContainer.querySelector('.contract_profit').value = project.contract_profit || '';
      projectContainer.querySelector('.profit_percentage').value = project.profit_percentage || '';
      projectContainer.querySelector('.company_seller').value = project.company_seller || '';
      projectContainer.querySelector('.tin_seller').value = project.tin_seller || '';
      projectContainer.querySelector('.buyer_company').value = project.buyer_company || '';
      projectContainer.querySelector('.tin_buyer').value = project.tin_buyer || '';
    }
  }

  // Удаление проекта из списка
  function removeProjectFromList(projectId) {
    const projectContainer = projectsList.querySelector(`.modal1-container[data-id='${projectId}']`);
    if (projectContainer) {
      projectContainer.remove();
    }
  }

  // Инициализация при загрузке
  document.addEventListener('DOMContentLoaded', () => {
    loadProjects();
    subscribeToProjects();
  });

  // Функция закрытия модального окна (должна быть определена в основном приложении)
  function closeModal() {
    // Предполагается, что функция closeModal() уже определена в основном приложении
    if (typeof window.closeModal === 'function') {
      window.closeModal();
    }
  }
</script>
