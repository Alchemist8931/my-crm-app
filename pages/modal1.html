<!-- /pages/modal1.html -->
<button class="close-modal">×</button>
<div class="modal111-content" style="justify-content: flex-start;">
  <h2 class="modal1-title">ELABORATION SALES</h2>
  <p class="modal1-subtitle">проекты в работе</p>
  <button id="add-project-button" class="button-D" style="top: 2.7vw; left: 20vw;">
    <span class="btn-txt">new project</span>
  </button> 

  <div id="modalBottom" class="modalVNUT" style="top: 4.5vw; left: 6vw; right: 2vw; height: calc(100vh - 6.4vw); width: 99%;">
    <!-- //функция ленивая подгрузка проектов -->
    <div class="modalVNUT-content" id="projects-container">
      <!-- Контейнеры проектов будут динамически добавляться здесь -->
    </div>
  </div>
</div>



<!-- ШАБЛОН: одна карточка проекта -->
<template id="project-template">
  <div class="modal1-container">
<!-- Иконка "редактировать" -->
    <span class="modal1-icon" style="left: 1vw;" data-action="edit" data-id="${project.project_id}">
      <i class="material-symbols-outlined">edit</i>
    </span>

    <!-- //группы ввода данных -->
    <div class="modal1-input-group left">
      <input type="text" class="modal1-input" value="${project.project_id}" placeholder=" " data-field="project_id" readonly />
    </div>

    <div class="modal1-input-group right">
      <input type="text" class="modal1-input" value="${project.project_name || ''}" placeholder=" " data-field="project_name" readonly />
    </div>

    <div class="modal1-input-group right">
      <input type="text" class="modal1-input" value="${project.status || ''}" placeholder=" " data-field="status" readonly />
    </div>

    <div class="modal1-input-group left">
      <input type="number" step="0.01" class="modal1-input" value="${project.contract_amount || ''}" placeholder="8796669698" data-field="contract_amount" readonly />
    </div>

    <div class="modal1-input-group right">
      <input type="number" step="0.01" class="modal1-input" value="${project.contract_costs || ''}" placeholder=" " data-field="contract_costs" readonly />
    </div>

    <div class="modal1-input-group right">
      <input type="number" step="0.01" class="modal1-input" value="${project.contract_profit || ''}" placeholder=" " data-field="contract_profit" readonly />
    </div>

    <div class="modal1-input-group right">
      <input type="number" step="0.01" class="modal1-input" value="${project.profit_percentage || ''}" placeholder=" " data-field="profit_percentage" readonly />
    </div>

    <div class="modal1-input-group left">
      <input type="text" class="modal1-input" value="${project.company_seller || ''}" placeholder=" " data-field="company_seller" readonly />
    </div>

    <div class="modal1-input-group right">
      <input type="text" class="modal1-input" value="${project.tin_seller || ''}" placeholder=" " data-field="tin_seller" readonly />
    </div>

    <div class="modal1-input-group left">
      <input type="text" class="modal1-input" value="${project.buyer_company || ''}" placeholder=" " data-field="buyer_company" readonly />
    </div>

    <div class="modal1-input-group right">
      <input type="text" class="modal1-input" value="${project.tin_buyer || ''}" placeholder=" " data-field="tin_buyer" readonly />
    </div>

    <!-- Иконка "удалить" -->
    <span class="modal1-icon" style="margin-left: 6vw; right: 1vw;" data-action="delete" data-id="${project.project_id}">
      <i class="material-symbols-outlined">delete</i>
    </span>
  </div>
</template>



<!-- Модальное окно редактирования -->
<div id="editModal" class="edit-modal hidden">
  <div class="edit-modal-content">
    <button class="close-edit-modal">×</button>
    <h3>Редактирование проекта</h3>
    <form id="edit-form">
      <!-- Поля редактирования -->

      <!-- Название проекта -->
      <label for="edit-project-name">Название проекта</label>
      <input type="text" id="edit-project-name" placeholder="Введите название проекта" required />

      <!-- Статус проекта -->
      <label for="edit-status">Статус</label>
      <input type="text" id="edit-status" placeholder="Введите статус проекта" required />

      <!-- Сумма контракта -->
      <label for="edit-contract-amount">Сумма контракта</label>
      <input type="number" id="edit-contract-amount" step="0.01" placeholder="Введите сумму контракта" required />

      <!-- Стоимость контракта -->
      <label for="edit-contract-cost">Стоимость контракта</label>
      <input type="number" id="edit-contract-cost" step="0.01" placeholder="Введите стоимость контракта" />

      <!-- Прибыль -->
      <label for="edit-contract-profit">Прибыль</label>
      <input type="number" id="edit-contract-profit" step="0.01" placeholder="Введите прибыль" />

      <!-- Процент прибыли -->
      <label for="edit-profit-percentage">Процент прибыли</label>
      <input type="number" id="edit-profit-percentage" step="0.01" placeholder="Введите процент прибыли" />

      <!-- Компания-продавец -->
      <label for="edit-company-seller">Компания-продавец</label>
      <input type="text" id="edit-company-seller" placeholder="Введите название компании-продавца" />

      <!-- ИНН продавца -->
      <label for="edit-tin-seller">ИНН продавца</label>
      <input type="text" id="edit-tin-seller" placeholder="Введите ИНН продавца" />

      <!-- Компания-покупатель -->
      <label for="edit-buyer-company">Компания-покупатель</label>
      <input type="text" id="edit-buyer-company" placeholder="Введите название компании-покупателя" />

      <!-- ИНН покупателя -->
      <label for="edit-tin-buyer">ИНН покупателя</label>
      <input type="text" id="edit-tin-buyer" placeholder="Введите ИНН покупателя" />

      <!-- Кнопка для сохранения изменений -->
      <button type="button" class="save-button">Сохранить</button>
    </form>
  </div>
</div>

<style>
.close-modal {
    position: absolute;
    top: 0.5vw;
    right: 0.5vw;
    background: none;
    border: none;
    font-size: 1vw;
    cursor: pointer;
    color: var(--white-color2);
  }

  .close-modal:hover {
    color: #393E41;
  }

  .modal111-content {
    font-family: "Comfortaa", sans-serif;
    color: var(--white-color2);
    background-color: none; /* Белый фон для контента */
    border-radius: var(--borderRadius);
    height: calc(100vh - (var(--spacer)*2));
    width: calc(100vw - (var(--spacer)*6));
    box-sizing: border-box;
    position: relative;
    pading: 1vw
  }

  /* Заголовок */
.modal1-title {
  color: var(--white-color2);
  font-size: 0.7vw;
  margin-top: 1vw;
  margin-left: 1vw;
  display: flex
}

/* Подзаголовок */
.modal1-subtitle {
  color: var(--white-color2);
  font-size: 0.45vw;
  margin-top: 0.2vw;
  margin-left: 1vw;
  display: flex
}

  /* Если необходимо выровнять h2 и p внутри flex-контейнера, можно добавить */
.modal1-content h2,
.modal1-content p {
  align-self: flex-start;
  display: flex
}
  
  
  
  /* _______________________________  стили модального окна с прокруткой / скроллом */
  
  /* Модальное окно с прокруткой */
.modalVNUT {
  display: flex;
  position: fixed;
  background: none;
  padding: 0vw;
  border-radius: 0.4vw;
  border: 0px solid rgba(255, 255, 255, 0.18);
  color: black;
  z-index: 1000;
  overflow: hidden; /* Отключаем общий скролл */
  box-sizing: border-box;
}

/* Внутренний контейнер с прокруткой */
.modalVNUT-content {
  padding: 0.5vh 2vh 0vw 0vw; /* Отступы внутри модального окна */
  height: 100%;
  width: 100%;
  overflow-y: auto; /* Включаем вертикальную прокрутку */
  box-sizing: border-box;
}

/* Стилизация скроллбара */
.modalVNUT-content::-webkit-scrollbar {
  width: 4px; /* Ширина скроллбара */
  background-color: var(--scrollbar-color);
}

.modalVNUT-content::-webkit-scrollbar-thumb {
  background-color: var(--scrollbar-thumb-color); /* Цвет ползунка */
  border-radius: 10px; /* Скругление */
}

.modalVNUT-content::-webkit-scrollbar-track {
  background-color: var(--scrollbar-color);
}
  
  /* Внутренний контейнер с прокруткой */
.modalVNUT-content {
  padding: 0.5vh 2vh 0vw 0vw; /* Отступы внутри модального окна */
  height: 100%;
  width: 100%;
  overflow-y: auto; /* Включаем вертикальную прокрутку */
  box-sizing: border-box;
}

/* Стилизация скроллбара */
.modalVNUT-content::-webkit-scrollbar {
  width: 4px; /* Ширина скроллбара */
  background-color: var(--scrollbar-color);
}

.modalVNUT-content::-webkit-scrollbar-thumb {
  background-color: var(--scrollbar-thumb-color); /* Цвет ползунка */
  border-radius: 10px; /* Скругление */
}

.modalVNUT-content::-webkit-scrollbar-track {
  background-color: var(--scrollbar-color);
}



  /* _____________________________________________________________________    Контейнеры внутри модального окна */

  .modal1-container {
    display: flex;
    align-items: center; /* Центрирование по вертикали */
    padding: 0.4vw;
    border-radius: var(--borderRadius);
    color: var(--white-color2);
    z-index: 1100;
    box-sizing: border-box;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.18);
    width: 100%; /* Ширина контейнера остается неизменной */
    height: 2.1vw;
    transform: scale(0.86); /* Уменьшаем все элементы внутри контейнера на 30% */
    transform-origin: top left; /* Сохраняем ширину контейнера */
  }

  .modal1-container:hover,
  .modal1-container:focus {
    border: 1px solid var(--white-color2);
  }

  /* Отступы только между контейнерами */
  .modal1-container:not(:last-child) {
    margin-bottom: 0.5vw; /* Отступ снизу только между контейнерами */
  }

  /* Иконки */
  .modal1-icon {
    color: rgba(255, 255, 255, 0.6);
    font-size: 1.4vw; /* Уменьшено на 30% */
    margin-right: 0.2vw; /* Уменьшено на 30% */
    cursor: pointer;
    display: flex;
    align-items: center; /* Центрирование иконок по вертикали */
  }

  .modal1-icon:hover {
    color: var(--white-color2);
    transform: scale(0.7 * 1.1); /* Увеличение иконки при наведении с учетом масштаба */
  }

  .modal1-icon:active {
    transform: scale(0.7 * 0.92); /* Сжатие иконки при клике с учетом масштаба */
  }
















  

  /* Input заголовок без границ */
  .modal1-input-TYPE1 {
    position: relative;
    font-family: "Comfortaa", sans-serif;
    width: 1.4vw; /* Уменьшено на 30% от 2vw */
    border: none;
    outline: none;
    color: rgba(255, 255, 255, 0.6);
    background-color: transparent;
    margin-top: 0.7vw; /* Уменьшено на 30% от 1vw */
  }

  /* Иконки внутри контейнера */
  .modal1-icon {
    color: rgba(255, 255, 255, 0.6);
    font-size: 1.4vw; /* Уменьшено на 30% от 2vw */
    margin-right: 0.175vw; /* Уменьшено на 30% от 0.25vw */
    cursor: pointer;
    display: flex;
    align-items: center; /* Центрирование иконок по вертикали */
  }

  .modal1-icon:hover {
    color: var(--white-color2);
    transform: scale(1.1); /* Увеличение иконки при наведении */
  }

  .modal1-icon:active {
    transform: scale(0.92); /* Сжатие иконки при клике */
  }

    /* Дополнительные стили для кнопки добавления проекта */
  #add-project-button {
    background-color: var(--white-color2);
    color: var(--black-color);
    border: none;
    border-radius: 5px;
    transition: background-color 0.3s;
  }

  #add-project-button:hover {
    background-color: var(--white-color1);
  }



  
  /* Стили для модального окна редактирования */
.edit-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(15px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1100;
}

.edit-modal.hidden {
  display: none;
}

.edit-modal-content {
  background: white;
  padding: 2rem;
  border-radius: 10px;
  width: 50%;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
}

.close-edit-modal {
  position: absolute;
  top: 10px;
  right: 10px;
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
}



  .button-D {
  height: 1vw;
  width: 8vw;
  position: fixed;
  background-color: transparent;
  cursor: pointer;
  border: 2px solid var(--white-color2);
  overflow: hidden;
  border-radius: 10px;
  color: var(--black-color);
  transition: all 0.2s ease-in-out;
}

.btn-txt {
  z-index: 1;
  font-weight: 800;
  letter-spacing: 2px;
  text-transform: uppercase;
  font-size: 0.5vw;
}

.button-D:active {
  transform: scale(0.9);
  background-color: var(--white-color1);
  }
  
</style>

<script type="module">
const supabase = window.supabase;

const projectsContainer = document.getElementById('projects-container');
const addProjectButton = document.getElementById('add-project-button');
const editModal = document.getElementById('editModal');
const editForm = document.getElementById('edit-form');
const closeMainModalBtn = document.querySelector('.close-modal');
const closeEditModalBtn = document.querySelector('.close-edit-modal');
const saveEditBtn = editForm.querySelector('.save-button');

const CHUNK_SIZE = 10; // Количество проектов для ленивой подгрузки
let allProjects = [];
let currentIndex = 0;
let isLoading = false;
let currentEditingProject = null;
let changedRows = new Set();
let saveDebounceTimeout;

// Функция для клонирования контейнера проекта из шаблона
function createProjectContainer(project) {
  const template = document.getElementById('project-template');
  const clone = template.content.cloneNode(true);
  const container = clone.querySelector('.modal1-container');
  if (!container) return null;

  // Установка data-атрибутов
  Object.keys(project).forEach((key) => {
    container.dataset[key] = project[key] || '';
    const input = container.querySelector(`[data-field="${key}"]`);
    if (input) input.value = project[key] || '';
  });

  return container;
}

// Отрисовка проектов порциями для повышения производительности
function renderProjectsChunked(chunkSize = CHUNK_SIZE) {
  if (currentIndex >= allProjects.length) return;

  const fragment = document.createDocumentFragment();
  for (let i = 0; i < chunkSize && currentIndex < allProjects.length; i++, currentIndex++) {
    const project = allProjects[currentIndex];
    const el = createProjectContainer(project);
    if (el) fragment.appendChild(el);
  }

  projectsContainer.appendChild(fragment);
}

// Загрузка всех проектов
async function loadAllProjects() {
  if (isLoading) return;
  isLoading = true;

  const { data, error } = await supabase.from('projects').select('*');
  if (error) {
    console.error('Ошибка при загрузке проектов:', error);
    isLoading = false;
    return;
  }

  allProjects = data || [];
  currentIndex = 0;
  projectsContainer.innerHTML = '';
  isLoading = false;

  renderProjectsChunked();
}

// Ленивый рендеринг проектов при прокрутке
function setupLazyLoading() {
  projectsContainer.addEventListener('scroll', () => {
    if (projectsContainer.scrollTop + projectsContainer.clientHeight >= projectsContainer.scrollHeight) {
      renderProjectsChunked(CHUNK_SIZE);
    }
  });
}

// Функция для дебаунса при сохранении изменений
function debounceSaveChanges(projectId, updatedFields) {
  clearTimeout(saveDebounceTimeout);
  saveDebounceTimeout = setTimeout(async () => {
    const { error } = await supabase
      .from('projects')
      .update(updatedFields)
      .eq('project_id', projectId);
    if (error) {
      console.error('Ошибка сохранения изменений:', error);
    }
  }, 300); // Задержка 300 мс
}

// Добавление нового проекта
async function addNewProject() {
  const newProject = {
    project_id: 'proj_' + Math.random().toString(36).substr(2, 9),
    project_name: 'Новый проект',
    status: 'Новый',
    contract_amount: 0,
    contract_costs: 0,
    contract_profit: 0,
    profit_percentage: 0,
    company_seller: '',
    tin_seller: '',
    buyer_company: '',
    tin_buyer: '',
  };

  const { data, error } = await supabase
    .from('projects')
    .insert([newProject])
    .select('*')
    .single();

  if (error) {
    console.error('Ошибка добавления проекта:', error);
    return;
  }

  allProjects.push(data);
  const el = createProjectContainer(data);
  if (el) projectsContainer.appendChild(el);
}

// Удаление проекта
async function deleteProject(projectId) {
  const { error } = await supabase.from('projects').delete().eq('project_id', projectId);
  if (error) {
    console.error('Ошибка удаления проекта:', error);
    return;
  }

  const elem = projectsContainer.querySelector(`[data-id="${projectId}"]`);
  if (elem) projectsContainer.removeChild(elem);

  allProjects = allProjects.filter((p) => p.project_id !== projectId);
}

// Открытие модального окна редактирования
function openEditModal(projectId) {
  const project = allProjects.find((p) => p.project_id === projectId);
  if (!project) return;

  currentEditingProject = { ...project };

  Object.keys(currentEditingProject).forEach((key) => {
    const input = editForm.querySelector(`[name="edit-${key.replace('_', '-')}"]`);
    if (input) input.value = currentEditingProject[key] || '';
  });

  editModal.classList.remove('hidden');
}

// Закрытие модального окна редактирования
function closeEditModal() {
  editModal.classList.add('hidden');
  currentEditingProject = null;
}

// Сохранение изменений проекта
async function saveProject() {
  if (!currentEditingProject) return;

  const updatedFields = Object.fromEntries(
    Array.from(editForm.elements)
      .filter((el) => el.name.startsWith('edit-'))
      .map((el) => [el.name.replace('edit-', '').replace('-', '_'), el.value || ''])
  );

  debounceSaveChanges(currentEditingProject.project_id, updatedFields);

  const elem = projectsContainer.querySelector(`[data-id="${currentEditingProject.project_id}"]`);
  if (elem) {
    Object.keys(updatedFields).forEach((key) => {
      elem.dataset[key] = updatedFields[key];
      const input = elem.querySelector(`[data-field="${key}"]`);
      if (input) input.value = updatedFields[key];
    });
  }

  closeEditModal();
}

// Обработчик делегирования событий
projectsContainer.addEventListener('click', (e) => {
  const icon = e.target.closest('.modal1-icon');
  if (!icon) return;

  const action = icon.dataset.action;
  const projectId = icon.dataset.id;

  if (action === 'edit') {
    openEditModal(projectId);
  } else if (action === 'delete') {
    deleteProject(projectId);
  }
});

// Привязка событий
addProjectButton?.addEventListener('click', addNewProject);
closeMainModalBtn.addEventListener('click', () => window.closeModal?.());
closeEditModalBtn.addEventListener('click', closeEditModal);
saveEditBtn.addEventListener('click', saveProject);

// Инициализация
async function init() {
  await loadAllProjects();
  setupLazyLoading();
}

init();
</script>
