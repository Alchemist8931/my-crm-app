<!-- /pages/modal1.html -->
<button class="close-modal">×</button>
<div class="modal111-content" style="justify-content: flex-start;">
  <h2 class="modal1-title">ELABORATION SALES</h2>
  <p class="modal1-subtitle">проекты в работе</p>
  
  <!-- Пример: 2.7vw ~ 43px, 20vw ~ 320px -->
  <button id="add-project-button" class="button-D" style="top: 43px; left: 320px;">
    <span class="btn-txt">new project</span>
  </button>

  <!-- Пример: 4.5vw ~ 72px, 6vw ~ 96px, 2vw ~ 32px;  
       Вместо calc(100vh - 6.4vw) зададим, к примеру, 700px -->
  <div id="modalBottom" class="modalVNUT"
       style="top: 72px; left: 96px; right: 32px; height: 700px; width: 99%;">
    <div class="modalVNUT-content" id="projects-container">
      <!-- Контейнеры проектов будут динамически добавляться здесь -->
    </div>
  </div>
</div>

<!-- Модальное окно редактирования -->
<div id="editModal" class="edit-modal hidden">
  <div class="edit-modal-content">
    <button class="close-edit-modal">×</button>
    <h3>Редактирование проекта</h3>
    <form id="edit-form">
      <!-- Поля редактирования -->

      <label for="edit-project-name">Название проекта</label>
      <input type="text" id="edit-project-name" placeholder="Введите название проекта" required />

      <label for="edit-status">Статус</label>
      <input type="text" id="edit-status" placeholder="Введите статус проекта" required />

      <label for="edit-contract-amount">Сумма контракта</label>
      <input type="number" id="edit-contract-amount" step="0.01" placeholder="Введите сумму контракта" required />

      <label for="edit-contract-cost">Стоимость контракта</label>
      <input type="number" id="edit-contract-cost" step="0.01" placeholder="Введите стоимость контракта" />

      <label for="edit-contract-profit">Прибыль</label>
      <input type="number" id="edit-contract-profit" step="0.01" placeholder="Введите прибыль" />

      <label for="edit-profit-percentage">Процент прибыли</label>
      <input type="number" id="edit-profit-percentage" step="0.01" placeholder="Введите процент прибыли" />

      <label for="edit-company-seller">Компания-продавец</label>
      <input type="text" id="edit-company-seller" placeholder="Введите название компании-продавца" />

      <label for="edit-tin-seller">ИНН продавца</label>
      <input type="text" id="edit-tin-seller" placeholder="Введите ИНН продавца" />

      <label for="edit-buyer-company">Компания-покупатель</label>
      <input type="text" id="edit-buyer-company" placeholder="Введите название компании-покупателя" />

      <label for="edit-tin-buyer">ИНН покупателя</label>
      <input type="text" id="edit-tin-buyer" placeholder="Введите ИНН покупателя" />

      <button type="button" class="save-button">Сохранить</button>
    </form>
  </div>
</div>

<style>
.close-modal {
  position: absolute;
  /* 0.5vw ~ 8px */
  top: 8px;
  right: 8px;
  background: none;
  border: none;
  /* 1vw ~ 16px */
  font-size: 16px;
  cursor: pointer;
  color: var(--white-color2);
}

.close-modal:hover {
  color: #393E41;
}

.modal111-content {
  font-family: "Comfortaa", sans-serif;
  color: var(--white-color2);
  background-color: transparent; /* Белый фон для контента (было none) */
  border-radius: var(--borderRadius);

  /* Вместо calc(100vh - (var(--spacer)*2)) -- пример фикс:
     Пусть будет высота 800px, ширина 1200px */
  height: 800px;
  width: 1200px;

  box-sizing: border-box;
  position: relative;
  /* pading: 1vw -> ~16px */
  padding: 16px;
}

/* Заголовок */
.modal1-title {
  color: var(--white-color2);
  /* 0.7vw ~ 11px */
  font-size: 11px;
  /* margin-top: 1vw ~ 16px */
  margin-top: 16px;
  margin-left: 16px;
  display: flex;
}

/* Подзаголовок */
.modal1-subtitle {
  color: var(--white-color2);
  /* 0.45vw ~ 7px */
  font-size: 7px;
  /* 0.2vw ~ 3px */
  margin-top: 3px;
  margin-left: 16px;
  display: flex;
}

/* Если необходимо выровнять h2 и p внутри flex-контейнера */
.modal1-content h2,
.modal1-content p {
  align-self: flex-start;
  display: flex;
}

/* Модальное окно с прокруткой */
.modalVNUT {
  display: flex;
  position: fixed;
  background: none;
  /* 0.4vw ~ 6px */
  border-radius: 6px;
  border: 0px solid rgba(255, 255, 255, 0.18);
  color: black;
  z-index: 1000;
  overflow: hidden; /* Отключаем общий скролл */
  box-sizing: border-box;
}

/* Внутренний контейнер с прокруткой */
.modalVNUT-content {
  /* вместо 0.5vh 2vh ... пусть будет ~ 5px 20px ... */
  padding: 5px 20px 0px 0px;
  height: 100%;
  width: 100%;
  overflow-y: auto;
  box-sizing: border-box;
}

/* Стилизация скроллбара */
.modalVNUT-content::-webkit-scrollbar {
  width: 4px;
  background-color: var(--scrollbar-color);
}

.modalVNUT-content::-webkit-scrollbar-thumb {
  background-color: var(--scrollbar-thumb-color);
  border-radius: 10px;
}

.modalVNUT-content::-webkit-scrollbar-track {
  background-color: var(--scrollbar-color);
}

/* _____________________________________________________________________
   Контейнеры внутри модального окна */

.modal1-container {
  display: flex;
  align-items: center; /* Центрирование по вертикали */
  /* padding: 0.4vw ~ 6px */
  padding: 6px;

  border-radius: var(--borderRadius);
  color: var(--white-color2);
  z-index: 1100;
  box-sizing: border-box;

  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.18);

  width: 100%; /* Ширина контейнера остается неизменной */
  /* height: 2.1vw ~ 34px */
  height: 34px;

  /* transform: scale(0.86) */
  transform: scale(0.86);
  transform-origin: top left;
}

.modal1-container:hover,
.modal1-container:focus {
  border: 1px solid var(--white-color2);
}

/* Отступы только между контейнерами */
/* margin-bottom: 0.5vw ~ 8px */
.modal1-container:not(:last-child) {
  margin-bottom: 8px;
}

/* Иконки */
.modal1-icon {
  color: rgba(255, 255, 255, 0.6);
  /* 1.4vw ~ 22px */
  font-size: 22px;
  /* margin-right: 0.2vw ~ 3px */
  margin-right: 3px;
  cursor: pointer;
  display: flex;
  align-items: center; /* Центрирование иконок по вертикали */
}

.modal1-icon:hover {
  color: var(--white-color2);
  /* transform: scale(0.7 * 1.1) ~ 0.77 */
  transform: scale(0.77);
}

.modal1-icon:active {
  /* transform: scale(0.7 * 0.92) ~ 0.64 */
  transform: scale(0.64);
}

/* Input группы */
.modal1-input-group {
  position: relative;
  font-family: "Comfortaa", sans-serif;
}

/* Раньше .left { margin-left: 2vw } ~ 32px */
.modal1-input-group.left {
  margin-left: 32px;
}

/* Раньше .right { margin-left: 0.3vw } ~ 5px */
.modal1-input-group.right {
  margin-left: 5px;
}

/* Раньше label: top: 0.61vw ~ 10px, left: 0.28vw ~ 4px, font-size: 0.42vw ~ 7px */
.modal1-input-group label {
  background: none;
  color: rgba(255, 255, 255, 0.6);
  position: absolute;
  top: 10px;
  left: 4px;
  transform: translateY(-50%);
  text-transform: uppercase;
  font-weight: 700;
  pointer-events: none;
  font-size: 7px;
  transition: all 0.3s;
}

/* .modal1-input padding: 0.28vw ~ 4.5px => 4px, font-size: 0.49vw ~ 8px */
.modal1-input-group .modal1-input {
  padding: 4px;
  width: 100%;
  border: 1px solid rgba(255, 255, 255, 0.18);
  outline: none;
  color: var(--white-color2);
  font-size: 8px;
  font-family: inherit;
  background-color: transparent;
  border-radius: 7px; /* ok */
}

.modal1-input-group .modal1-input:hover,
.modal1-input-group .modal1-input:focus {
  border: 1px solid var(--white-color2);
}

/* При focus => label поднимается */
.modal1-input-group .modal1-input:focus + label,
.modal1-input-group .modal1-input:not(:placeholder-shown) + label {
  top: -4px; /* ~ -0.06vw -> примерно -4px */
  font-size: 6px; /* ~ 0.28vw */
  padding: 0 4px;
  background: rgba(0, 0, 0, 0.5);
  border-radius: 7px;
  color: var(--white-color2);
}

/* Дополнительные стили для кнопки добавления проекта */
#add-project-button {
  background-color: var(--white-color2);
  color: var(--black-color);
  border: none;
  border-radius: 5px;
  transition: background-color 0.3s;
}

#add-project-button:hover {
  background-color: var(--white-color1);
}

/* Стили для модального окна редактирования */
.edit-modal {
  position: fixed;
  top: 0;
  left: 0;
  /* 100vw x 100vh можно заменить на 100% x 100% или оставить как есть */
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(15px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1100;
}

.edit-modal.hidden {
  display: none;
}

.edit-modal-content {
  background: white;
  padding: 2rem;
  border-radius: 10px;
  width: 50%;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
}

.close-edit-modal {
  position: absolute;
  top: 10px;
  right: 10px;
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
}

/* Кнопка .button-D
   Раньше: height: 1vw ~ 16px, width: 8vw ~ 128px, font-size: 0.5vw ~ 8px */
.button-D {
  height: 16px;
  width: 128px;
  position: fixed;
  background-color: transparent;
  cursor: pointer;
  border: 2px solid var(--white-color2);
  overflow: hidden;
  border-radius: 10px;
  color: var(--black-color);
  transition: all 0.2s ease-in-out;
}

.btn-txt {
  z-index: 1;
  font-weight: 800;
  letter-spacing: 2px;
  text-transform: uppercase;
  font-size: 8px;
}

.button-D:active {
  transform: scale(0.9);
  background-color: var(--white-color1);
}
</style>

<script type="module">
/* // ИСПОЛЬЗУЕМ Supabase Realtime ВМЕСТО ПОЛЛИНГА.
// // Глобальный объект Supabase (должен быть доступен) */
const supabase = window.supabase;

// // DOM-элементы
const projectsContainer = document.getElementById('projects-container'); // Основной контейнер для проектов
const addProjectButton = document.getElementById('add-project-button');  // Кнопка "new project"
const editModal = document.getElementById('editModal');                  // Модалка редактирования
const editForm = document.getElementById('edit-form');                   // Форма редактирования
const closeMainModalBtn = document.querySelector('.close-modal');        // Кнопка "×" у modal1
const closeEditModalBtn = document.querySelector('.close-edit-modal');   // Кнопка "×" у editModal
const saveEditBtn = editForm.querySelector('.save-button');             // Кнопка "Сохранить" в editModal

let allProjects = [];          // //Хранилище проектов
let isLoading = false;         // //Флаг загрузки
let currentEditingProject = null; // //Текущий проект в режиме редактирования

// //функция создания DOM-карточки проекта
function createProjectContainer(project) {
  if (!project || !project.project_id) return null;

  // //рендеринг карточки проекта
  const container = document.createElement('div');
  container.classList.add('modal1-container');
  container.dataset.id = project.project_id;

  container.dataset.projectName = project.project_name || '';
  container.dataset.status = project.status || '';
  container.dataset.contractAmount = project.contract_amount || 0;
  container.dataset.contractCosts = project.contract_costs || 0;
  container.dataset.contractProfit = project.contract_profit || 0;
  container.dataset.profitPercentage = project.profit_percentage || 0;
  container.dataset.companySeller = project.company_seller || '';
  container.dataset.tinSeller = project.tin_seller || '';
  container.dataset.buyerCompany = project.buyer_company || '';
  container.dataset.tinBuyer = project.tin_buyer || '';

  container.innerHTML = `
  <!-- Иконка "редактировать" -->
  <span class="modal1-icon" style="left: 16px;" data-action="edit" data-id="${project.project_id}">
    <i class="material-symbols-outlined">edit</i>
  </span>

  <!-- //группы ввода данных -->
  <div class="modal1-input-group left">
    <input type="text" class="modal1-input" value="${project.project_id}" placeholder=" " data-field="project_id" readonly />
  </div>

  <div class="modal1-input-group right">
    <input type="text" class="modal1-input" value="${project.project_name || ''}" placeholder=" " data-field="project_name" readonly />
  </div>

  <div class="modal1-input-group right">
    <input type="text" class="modal1-input" value="${project.status || ''}" placeholder=" " data-field="status" readonly />
  </div>

  <div class="modal1-input-group left">
    <input type="number" step="0.01" class="modal1-input" value="${project.contract_amount || ''}" placeholder=" " data-field="contract_amount" readonly />
  </div>

  <div class="modal1-input-group right">
    <input type="number" step="0.01" class="modal1-input" value="${project.contract_costs || ''}" placeholder=" " data-field="contract_costs" readonly />
  </div>

  <div class="modal1-input-group right">
    <input type="number" step="0.01" class="modal1-input" value="${project.contract_profit || ''}" placeholder=" " data-field="contract_profit" readonly />
  </div>

  <div class="modal1-input-group right">
    <input type="number" step="0.01" class="modal1-input" value="${project.profit_percentage || ''}" placeholder=" " data-field="profit_percentage" readonly />
  </div>

  <div class="modal1-input-group left">
    <input type="text" class="modal1-input" value="${project.company_seller || ''}" placeholder=" " data-field="company_seller" readonly />
  </div>

  <div class="modal1-input-group right">
    <input type="text" class="modal1-input" value="${project.tin_seller || ''}" placeholder=" " data-field="tin_seller" readonly />
  </div>

  <div class="modal1-input-group left">
    <input type="text" class="modal1-input" value="${project.buyer_company || ''}" placeholder=" " data-field="buyer_company" readonly />
  </div>

  <div class="modal1-input-group right">
    <input type="text" class="modal1-input" value="${project.tin_buyer || ''}" placeholder=" " data-field="tin_buyer" readonly />
  </div>

  <!-- Иконка "удалить" -->
  <span class="modal1-icon" style="margin-left: 96px; right: 16px;" data-action="delete" data-id="${project.project_id}">
    <i class="material-symbols-outlined">delete</i>
  </span>
`;
return container;

// //"функция однократной отрисовки проектов"
function renderAllProjects() {
  console.time('renderAllProjects');
  projectsContainer.innerHTML = '';
  const fragment = document.createDocumentFragment();
  allProjects.forEach((project) => {
    const el = createProjectContainer(project);
    if (el) fragment.appendChild(el);
  });
  projectsContainer.appendChild(fragment);
  console.timeEnd('renderAllProjects');
}

// //функция начальной загрузки проектов из БД
async function loadAllProjects() {
  if (isLoading) return;
  isLoading = true;
  console.time('loadProjectsFromDB');

  const { data, error } = await supabase.from('projects').select('*');
  if (error) {
    console.error('Ошибка при загрузке projects:', error);
    isLoading = false;
    return;
  }

  allProjects = data || [];
  isLoading = false;
  console.timeEnd('loadProjectsFromDB');
}

// //функция добавления нового проекта
async function addNewProject() {
  const newProject = {
    project_id: 'proj_' + Math.random().toString(36).substr(2, 9),
    project_name: 'Новый проект',
    status: 'Новый',
    contract_amount: 0,
    contract_costs: 0,
    contract_profit: 0,
    profit_percentage: 0,
    company_seller: '',
    tin_seller: '',
    buyer_company: '',
    tin_buyer: '',
  };

  const { data, error } = await supabase
    .from('projects')
    .insert([newProject])
    .select('*')
    .single();

  if (error) {
    console.error('Ошибка добавления проекта:', error);
    return;
  }
  if (data) {
    // //добавляем созданный проект в массив и перерисовываем
    allProjects.push(data);
    renderAllProjects();
  }
}

// //функция удаления проекта
async function deleteProject(projectId) {
  const { error } = await supabase.from('projects').delete().eq('project_id', projectId);
  if (error) {
    console.error('Ошибка удаления проекта:', error);
    return;
  }
  removeProjectInDOM(projectId);
}

// //функция удаления DOM-элемента проекта
function removeProjectInDOM(projectId) {
  const elem = projectsContainer.querySelector(`[data-id="${projectId}"]`);
  if (elem) {
    projectsContainer.removeChild(elem);
  }
  allProjects = allProjects.filter(p => p.project_id !== projectId);
}

// //функции для модального окна редактирования
function openEditModal(projectId) {
  const elem = projectsContainer.querySelector(`[data-id="${projectId}"]`);
  if (!elem) return;

  currentEditingProject = {
    project_id: projectId,
    project_name: elem.dataset.projectName,
    status: elem.dataset.status,
    contract_amount: elem.dataset.contractAmount,
    contract_costs: elem.dataset.contractCosts,
    contract_profit: elem.dataset.contractProfit,
    profit_percentage: elem.dataset.profitPercentage,
    company_seller: elem.dataset.companySeller,
    tin_seller: elem.dataset.tinSeller,
    buyer_company: elem.dataset.buyerCompany,
    tin_buyer: elem.dataset.tinBuyer,
  };

  editForm['edit-project-name'].value = currentEditingProject.project_name;
  editForm['edit-status'].value = currentEditingProject.status;
  editForm['edit-contract-amount'].value = currentEditingProject.contract_amount;
  editForm['edit-contract-cost'].value = currentEditingProject.contract_costs;
  editForm['edit-contract-profit'].value = currentEditingProject.contract_profit;
  editForm['edit-profit-percentage'].value = currentEditingProject.profit_percentage;
  editForm['edit-company-seller'].value = currentEditingProject.company_seller;
  editForm['edit-tin-seller'].value = currentEditingProject.tin_seller;
  editForm['edit-buyer-company'].value = currentEditingProject.buyer_company;
  editForm['edit-tin-buyer'].value = currentEditingProject.tin_buyer;

  editModal.classList.remove('hidden');
}

function closeEditModal() {
  editModal.classList.add('hidden');
  currentEditingProject = null;
}

// //функция сохранения изменений проекта
async function saveProject() {
  if (!currentEditingProject) return;

  const updatedFields = {
    project_name: editForm['edit-project-name'].value,
    status: editForm['edit-status'].value,
    contract_amount: parseFloat(editForm['edit-contract-amount'].value) || 0,
    contract_costs: parseFloat(editForm['edit-contract-cost'].value) || 0,
    contract_profit: parseFloat(editForm['edit-contract-profit'].value) || 0,
    profit_percentage: parseFloat(editForm['edit-profit-percentage'].value) || 0,
    company_seller: editForm['edit-company-seller'].value,
    tin_seller: editForm['edit-tin-seller'].value,
    buyer_company: editForm['edit-buyer-company'].value,
    tin_buyer: editForm['edit-tin-buyer'].value,
  };

  const { data, error } = await supabase
    .from('projects')
    .update(updatedFields)
    .eq('project_id', currentEditingProject.project_id)
    .select('*')
    .single();

  if (error) {
    console.error('Ошибка сохранения проекта:', error);
    return;
  }

  if (data) {
    updateProjectInDOM(data);
  }
  closeEditModal();
}

// //"функция точечного обновления DOM" (при UPDATE через Realtime или вручную)
function updateProjectInDOM(updatedProj) {
  const elem = projectsContainer.querySelector(`[data-id="${updatedProj.project_id}"]`);
  if (!elem) return;

  // //обновляем dataset
  elem.dataset.projectName = updatedProj.project_name || '';
  elem.dataset.status = updatedProj.status || '';
  elem.dataset.contractAmount = updatedProj.contract_amount || 0;
  elem.dataset.contractCosts = updatedProj.contract_costs || 0;
  elem.dataset.contractProfit = updatedProj.contract_profit || 0;
  elem.dataset.profitPercentage = updatedProj.profit_percentage || 0;
  elem.dataset.companySeller = updatedProj.company_seller || '';
  elem.dataset.tinSeller = updatedProj.tin_seller || '';
  elem.dataset.buyerCompany = updatedProj.buyer_company || '';
  elem.dataset.tinBuyer = updatedProj.tin_buyer || '';

  // //обновляем поля внутри карточки
  const fields = [
    'project_name','status','contract_amount','contract_costs','contract_profit',
    'profit_percentage','company_seller','tin_seller','buyer_company','tin_buyer'
  ];
  fields.forEach(field => {
    const input = elem.querySelector(`[data-field="${field}"]`);
    if (input) {
      input.value = updatedProj[field] || '';
    }
  });

  // //обновляем запись в allProjects
  const idx = allProjects.findIndex(p => p.project_id === updatedProj.project_id);
  if (idx !== -1) {
    allProjects[idx] = updatedProj;
  }
}

// //"функция добавления карточки в DOM" (при INSERT через Realtime)
function addProjectInDOM(newProj) {
  // //проверяем, нет ли такого project_id уже
  const exists = allProjects.some(p => p.project_id === newProj.project_id);
  if (exists) return;

  allProjects.push(newProj);
  // //добавляем новую карточку в конец
  const el = createProjectContainer(newProj);
  if (el) {
    projectsContainer.appendChild(el);
  }
}

// //"функция обработки событий Realtime"
function handleRealtimeChange(payload) {
  const eventType = payload.eventType; 
  const newData = payload.new;
  const oldData = payload.old;

  if (eventType === 'INSERT' && newData) {
    console.log('INSERT:', newData);
    addProjectInDOM(newData);
  } else if (eventType === 'UPDATE' && newData) {
    console.log('UPDATE:', newData);
    updateProjectInDOM(newData);
  } else if (eventType === 'DELETE' && oldData) {
    console.log('DELETE:', oldData);
    removeProjectInDOM(oldData.project_id);
  }
}

// //"обработчики кликов/действий в контейнере"
projectsContainer.addEventListener('click', (e) => {
  const icon = e.target.closest('.modal1-icon');
  if (!icon) return;

  const action = icon.dataset.action;
  const projectId = icon.dataset.id;

  if (action === 'edit') {
    openEditModal(projectId);
  } else if (action === 'delete') {
    deleteProject(projectId);
  }
});

// //"обработчики для кнопок"
addProjectButton?.addEventListener('click', addNewProject);
closeMainModalBtn.addEventListener('click', () => {
  if (window.closeModal) {
    window.closeModal();
  }
});
closeEditModalBtn.addEventListener('click', closeEditModal);
saveEditBtn.addEventListener('click', saveProject);

// //"инициализация (замена поллинга на realtime-подписку)"
async function init() {
  await loadAllProjects();
  // //отрисовываем все проекты одним проходом
  renderAllProjects();

  // //Подписка на события изменения таблицы projects
  supabase
 //   .channel('projects-changes')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'projects' }, (payload) => {
      handleRealtimeChange(payload);
    })
    .subscribe();
}

init();

// // Экспорт, если нужно
window.closeEditModal = closeEditModal;
window.saveProject = saveProject;
</script>
