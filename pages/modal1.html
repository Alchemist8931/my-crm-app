<!-- /pages/modal1.html -->
<button class="close-modal" onclick="closeModal()">×</button>
<div class="modal111-content" style="justify-content: flex-start;">
  <h2 class="modal1-title">ELABORATION SALES</h2>
  <p class="modal1-subtitle">проекты в работе</p>
  <!-- Дополнительный контент -->

  <!-- Кнопка для добавления нового проекта -->
  <button id="add-project-button" style="margin-top: -4.2vw; padding: 0.5vw 1vw; font-size: 0.4vw; cursor: pointer;">Добавить проект</button>

  <!-- Модальное окно проектов -->
  <div id="modalBottom" class="modalVNUT" style="top: 4.5vw; left: 6vw; right: 2vw; height: calc(100vh - 6.4vw); width: 99%;">
    <div class="modalVNUT-content" id="projects-container">
      <!-- Контейнеры проектов будут динамически добавляться здесь -->
    </div>
  </div>
</div>


<template id="project-template">
  <div class="modal1-container">
    <span class="modal1-icon" data-action="delete"><i class="material-symbols-outlined">delete</i></span>
    <span class="modal1-icon" data-action="edit"><i class="material-symbols-outlined">edit</i></span>

    <!-- Группы ввода данных -->
    <div class="modal1-input-group left">
      <input type="text" class="modal1-input" placeholder=" " data-field="project_id" />
      <label>project ID</label>
    </div>

    <div class="modal1-input-group right">
      <input type="text" class="modal1-input" placeholder=" " data-field="project_name" />
      <label>project name</label>
    </div>

    <div class="modal1-input-group right">
      <input type="text" class="modal1-input" placeholder=" " data-field="status" />
      <label>status</label>
    </div>

    <div class="modal1-input-group left">
      <input type="number" step="0.01" class="modal1-input" placeholder=" " data-field="contract_amount" />
      <label>contract amount</label>
    </div>

    <div class="modal1-input-group right">
      <input type="number" step="0.01" class="modal1-input" placeholder=" " data-field="contract_costs" />
      <label>contract costs</label>
    </div>

    <div class="modal1-input-group right">
      <input type="number" step="0.01" class="modal1-input" placeholder=" " data-field="contract_profit" />
      <label>contract profit</label>
    </div>

    <div class="modal1-input-group right">
      <input type="number" step="0.01" class="modal1-input" placeholder=" " data-field="profit_percentage" />
      <label>profit %</label>
    </div>

    <div class="modal1-input-group left">
      <input type="text" class="modal1-input" placeholder=" " data-field="company_seller" />
      <label>company seller</label>
    </div>

    <div class="modal1-input-group right">
      <input type="text" class="modal1-input" placeholder=" " data-field="tin_seller" />
      <label>TIN seller</label>
    </div>

    <div class="modal1-input-group left">
      <input type="text" class="modal1-input" placeholder=" " data-field="buyer_company" />
      <label>buyer company</label>
    </div>

    <div class="modal1-input-group right">
      <input type="text" class="modal1-input" placeholder=" " data-field="tin_buyer" />
      <label>TIN buyer</label>
    </div>
  </div>
</template>


<style>
.close-modal {
    position: absolute;
    top: 0.5vw;
    right: 0.5vw;
    background: none;
    border: none;
    font-size: 1vw;
    cursor: pointer;
    color: var(--white-color2);
  }

  .close-modal:hover {
    color: #393E41;
  }

  .modal111-content {
    font-family: "Comfortaa", sans-serif;
    color: var(--white-color2);
    background-color: none; /* Белый фон для контента */
    border-radius: var(--borderRadius);
    height: calc(100vh - (var(--spacer)*2));
    width: calc(100vw - (var(--spacer)*6));
    box-sizing: border-box;
    position: relative;
    pading: 1vw
  }

  /* Заголовок */
.modal1-title {
  color: var(--white-color2);
  font-size: 0.7vw;
  margin-top: 1vw;
  margin-left: 1vw;
  display: flex
}

/* Подзаголовок */
.modal1-subtitle {
  color: var(--white-color2);
  font-size: 0.45vw;
  margin-top: 0.2vw;
  margin-left: 1vw;
  display: flex
}

  /* Если необходимо выровнять h2 и p внутри flex-контейнера, можно добавить */
.modal1-content h2,
.modal1-content p {
  align-self: flex-start;
  display: flex
}
  
  
  
  /* _______________________________  стили модального окна с прокруткой / скроллом */
  
  /* Модальное окно с прокруткой */
.modalVNUT {
  display: flex;
  position: fixed;
  background: none;
  padding: 0vw;
  border-radius: 0.4vw;
  border: 0px solid rgba(255, 255, 255, 0.18);
  color: black;
  z-index: 1000;
  overflow: hidden; /* Отключаем общий скролл */
  box-sizing: border-box;
}

/* Внутренний контейнер с прокруткой */
.modalVNUT-content {
  padding: 0.5vh 2vh 0vw 0vw; /* Отступы внутри модального окна */
  height: 100%;
  width: 100%;
  overflow-y: auto; /* Включаем вертикальную прокрутку */
  box-sizing: border-box;
}

/* Стилизация скроллбара */
.modalVNUT-content::-webkit-scrollbar {
  width: 4px; /* Ширина скроллбара */
  background-color: var(--scrollbar-color);
}

.modalVNUT-content::-webkit-scrollbar-thumb {
  background-color: var(--scrollbar-thumb-color); /* Цвет ползунка */
  border-radius: 10px; /* Скругление */
}

.modalVNUT-content::-webkit-scrollbar-track {
  background-color: var(--scrollbar-color);
}
  
  /* Внутренний контейнер с прокруткой */
.modalVNUT-content {
  padding: 0.5vh 2vh 0vw 0vw; /* Отступы внутри модального окна */
  height: 100%;
  width: 100%;
  overflow-y: auto; /* Включаем вертикальную прокрутку */
  box-sizing: border-box;
}

/* Стилизация скроллбара */
.modalVNUT-content::-webkit-scrollbar {
  width: 4px; /* Ширина скроллбара */
  background-color: var(--scrollbar-color);
}

.modalVNUT-content::-webkit-scrollbar-thumb {
  background-color: var(--scrollbar-thumb-color); /* Цвет ползунка */
  border-radius: 10px; /* Скругление */
}

.modalVNUT-content::-webkit-scrollbar-track {
  background-color: var(--scrollbar-color);
}



  /* _____________________________________________________________________    Контейнеры внутри модального окна */

  .modal1-container {
    display: flex;
    align-items: center; /* Центрирование по вертикали */
    padding: 0.4vw;
    border-radius: var(--borderRadius);
    color: var(--white-color2);
    z-index: 1100;
    box-sizing: border-box;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.18);
    width: 100%; /* Ширина контейнера остается неизменной */
    height: 2.1vw;
    transform: scale(0.86); /* Уменьшаем все элементы внутри контейнера на 30% */
    transform-origin: top left; /* Сохраняем ширину контейнера */
  }

  .modal1-container:hover,
  .modal1-container:focus {
    border: 1px solid var(--white-color2);
  }

  /* Отступы только между контейнерами */
  .modal1-container:not(:last-child) {
    margin-bottom: 0.5vw; /* Отступ снизу только между контейнерами */
  }

  /* Иконки */
  .modal1-icon {
    color: rgba(255, 255, 255, 0.6);
    font-size: 1.4vw; /* Уменьшено на 30% */
    margin-right: 0.175vw; /* Уменьшено на 30% */
    cursor: pointer;
    display: flex;
    align-items: center; /* Центрирование иконок по вертикали */
  }

  .modal1-icon:hover {
    color: var(--white-color2);
    transform: scale(0.7 * 1.1); /* Увеличение иконки при наведении с учетом масштаба */
  }

  .modal1-icon:active {
    transform: scale(0.7 * 0.92); /* Сжатие иконки при клике с учетом масштаба */
  }

  /* Input группы */
  .modal1-input-group {
    position: relative;
    font-family: "Comfortaa", sans-serif;
  }

  .modal1-input-group.left {
    margin-left: 1.54vw; /* Уменьшено на 30% от 2.2vw */
  }

  .modal1-input-group.right {
    margin-left: 0.28vw; /* Уменьшено на 30% от 0.4vw */
  }

  .modal1-input-group label {
    background: none;
    color: rgba(255, 255, 255, 0.6);
    position: absolute;
    top: 0.61vw; /* Уменьшено на 30% от 0.86vw */
    left: 0.28vw; /* Уменьшено на 30% от 0.4vw */
    transform: translateY(-50%);
    text-transform: uppercase;
    font-weight: 700;
    pointer-events: none;
    font-size: 0.42vw; /* Уменьшено на 30% от 0.6vw */
    transition: all 0.3s;
  }

  .modal1-input-group .modal1-input {
    padding: 0.28vw 0.28vw; /* Уменьшено на 30% от 0.4vw */
    width: 100%;
    border: 1px solid rgba(255, 255, 255, 0.18);
    outline: none;
    color: var(--white-color2);
    font-size: 0.49vw; /* Уменьшено на 30% от 0.7vw */
    font-family: inherit;
    background-color: transparent;
    border-radius: 7px; /* Уменьшено на 30% от 10px → 7px */
  }

  .modal1-input-group .modal1-input:hover,
  .modal1-input-group .modal1-input:focus {
    border: 1px solid var(--white-color2);
  }

  .modal1-input-group .modal1-input:focus + label,
  .modal1-input-group .modal1-input:not(:placeholder-shown) + label {
    top: -0.06vw; /* Уменьшено на 30% от -0.5vw */
    font-size: 0.28vw; /* Уменьшено на 30% от 0.4vw */
    padding: 0 0.28vw; /* Уменьшено на 30% от 0.4vw */
    background: rgba(0, 0, 0, 0.5);
    border-radius: 7px; /* Уменьшено на 30% от 10px → 7px */
    color: var(--white-color2);
  }

  /* Input заголовок без границ */
  .modal1-input-TYPE1 {
    position: relative;
    font-family: "Comfortaa", sans-serif;
    width: 1.4vw; /* Уменьшено на 30% от 2vw */
    border: none;
    outline: none;
    color: rgba(255, 255, 255, 0.6);
    background-color: transparent;
    margin-top: 0.7vw; /* Уменьшено на 30% от 1vw */
  }

  /* Иконки внутри контейнера */
  .modal1-icon {
    color: rgba(255, 255, 255, 0.6);
    font-size: 1.4vw; /* Уменьшено на 30% от 2vw */
    margin-right: 0.175vw; /* Уменьшено на 30% от 0.25vw */
    cursor: pointer;
    display: flex;
    align-items: center; /* Центрирование иконок по вертикали */
  }

  .modal1-icon:hover {
    color: var(--white-color2);
    transform: scale(1.1); /* Увеличение иконки при наведении */
  }

  .modal1-icon:active {
    transform: scale(0.92); /* Сжатие иконки при клике */
  }





    /* Дополнительные стили для кнопки добавления проекта */
  #add-project-button {
    background-color: var(--white-color2);
    color: var(--black-color);
    border: none;
    border-radius: 5px;
    transition: background-color 0.3s;
  }

  #add-project-button:hover {
    background-color: var(--white-color1);
  }
  
  
</style>

<script type="module">
  // Доступ к Supabase клиенту через window.supabase
  const supabase = window.supabase;

  const projectsContainer = document.getElementById('projects-container');
  const addProjectButton = document.getElementById('add-project-button');
  const projectTemplate = document.getElementById('project-template');

  // Настройки виртуализации
  const ITEM_HEIGHT = 60; // Высота одного элемента (в пикселях)
  const BUFFER = 5; // Количество элементов, добавляемых сверху и снизу видимой области

  // Создаем Map для кэширования элементов проектов по их ID
  const projectElementsMap = new Map();

  // Хранилище всех проектов
  let allProjects = [];

  // Функция для генерации уникального project_id
  function generateProjectID() {
    return 'proj_' + Math.random().toString(36).substr(2, 9);
  }

  // Функция для создания и заполнения контейнера проекта из шаблона
  function createProjectElement(project) {
    const templateClone = projectTemplate.content.cloneNode(true);
    const container = templateClone.querySelector('.modal1-container');
    container.dataset.id = project.id;

    // Заполняем поля
    const inputs = container.querySelectorAll('.modal1-input');
    inputs.forEach(input => {
      const field = input.dataset.field;
      if (field && project.hasOwnProperty(field)) {
        input.value = project[field] !== null ? project[field] : '';
        // Присваиваем уникальный ID только если необходимо
        // Например:
        // input.id = `${field}-${project.id}`;
      }
    });

    // Добавляем контейнер в Map для быстрого доступа
    projectElementsMap.set(project.id, container);

    return container;
  }

  // Функция для загрузки всех проектов
  async function loadProjects() {
    try {
      const { data, error } = await supabase.from('projects').select('*');
      if (error) {
        console.error('Ошибка при загрузке проектов:', error);
        return;
      }

      allProjects = data;
      renderVisibleProjects();
    } catch (err) {
      console.error('Ошибка при загрузке проектов:', err);
    }
  }

  // Функция для добавления нового проекта
  async function addNewProject() {
    const newProject = {
      project_id: generateProjectID(),
      project_name: 'Новый проект',
      status: 'В процессе',
      contract_amount: 0.00,
      contract_costs: 0.00,
      contract_profit: 0.00,
      profit_percentage: 0.00,
      company_seller: '',
      tin_seller: '',
      buyer_company: '',
      tin_buyer: ''
    };

    try {
      const { data, error } = await supabase.from('projects').insert([newProject]).single();
      if (error) {
        console.error('Ошибка при добавлении проекта:', error);
        return;
      }
      // Проект будет автоматически добавлен через подписку на INSERT
    } catch (err) {
      console.error('Ошибка при добавлении проекта:', err);
    }
  }

  // Функция для обновления поля проекта
  async function updateProjectField(projectId, field, value) {
    try {
      const { data, error } = await supabase.from('projects').update({ [field]: value }).eq('id', projectId);
      if (error) {
        console.error(`Ошибка при обновлении поля ${field}:`, error);
        return;
      }
      // Изменения будут автоматически обновлены через подписку на UPDATE
    } catch (err) {
      console.error(`Ошибка при обновлении поля ${field}:`, err);
    }
  }

  // Дебаунсинг для функции обновления поля проекта
  function debounce(func, delay) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), delay);
    };
  }

  const debouncedUpdateProjectField = debounce(updateProjectField, 300);

  // Функция для удаления проекта
  async function deleteProject(projectId) {
    try {
      const { data, error } = await supabase.from('projects').delete().eq('id', projectId);
      if (error) {
        console.error('Ошибка при удалении проекта:', error);
        return;
      }
      // Удаление будет автоматически отражено через подписку на DELETE
    } catch (err) {
      console.error('Ошибка при удалении проекта:', err);
    }
  }

  // Функция для обновления только измененных полей без замены всего контейнера
  function updateProjectInDOM(project) {
    const existingElement = projectElementsMap.get(project.id);
    if (existingElement) {
      requestAnimationFrame(() => {
        const inputs = existingElement.querySelectorAll('.modal1-input');
        inputs.forEach(input => {
          const field = input.dataset.field;
          if (field && project.hasOwnProperty(field)) {
            const newValue = project[field] !== null ? project[field] : '';
            if (input.value !== newValue) {
              input.value = newValue;
            }
          }
        });
      });
    }
  }

  // Функция для рендеринга видимых проектов (виртуализация)
  function renderVisibleProjects() {
    // Получаем высоту контейнера
    const containerHeight = projectsContainer.clientHeight;
    // Получаем текущую позицию прокрутки
    const scrollTop = projectsContainer.scrollTop;
    // Вычисляем индекс первого видимого элемента
    const startIndex = Math.floor(scrollTop / ITEM_HEIGHT) - BUFFER;
    // Вычисляем индекс последнего видимого элемента
    const endIndex = Math.ceil((scrollTop + containerHeight) / ITEM_HEIGHT) + BUFFER;

    // Ограничиваем индексы
    const visibleStartIndex = Math.max(0, startIndex);
    const visibleEndIndex = Math.min(allProjects.length, endIndex);

    // Очищаем текущие элементы
    projectsContainer.innerHTML = '';

    // Создаем DocumentFragment для быстрого добавления элементов
    const fragment = document.createDocumentFragment();

    for (let i = visibleStartIndex; i < visibleEndIndex; i++) {
      const project = allProjects[i];
      let projectElement = projectElementsMap.get(project.id);

      if (!projectElement) {
        projectElement = createProjectElement(project);
      }

      // Устанавливаем позицию элемента
      projectElement.style.position = 'absolute';
      projectElement.style.top = `${i * ITEM_HEIGHT}px`;
      projectElement.style.height = `${ITEM_HEIGHT}px`;
      projectElement.style.width = '100%';

      fragment.appendChild(projectElement);
    }

    // Устанавливаем общую высоту контейнера для правильной прокрутки
    projectsContainer.style.position = 'relative';
    projectsContainer.style.height = `${allProjects.length * ITEM_HEIGHT}px`;

    projectsContainer.appendChild(fragment);
  }

  // Обработчик события прокрутки для рендеринга видимых проектов
  function onScroll() {
    renderVisibleProjects();
  }

  // Подписка на изменения в таблице projects
  function setupRealtime() {
    supabase.from('projects').on('INSERT', payload => {
      allProjects.push(payload.new);
      renderVisibleProjects();
    }).on('UPDATE', payload => {
      const index = allProjects.findIndex(p => p.id === payload.new.id);
      if (index !== -1) {
        allProjects[index] = payload.new;
        updateProjectInDOM(payload.new);
      }
    }).on('DELETE', payload => {
      const index = allProjects.findIndex(p => p.id === payload.old.id);
      if (index !== -1) {
        allProjects.splice(index, 1);
        const existingElement = projectElementsMap.get(payload.old.id);
        if (existingElement) {
          projectsContainer.removeChild(existingElement);
          projectElementsMap.delete(payload.old.id);
        }
        renderVisibleProjects();
      }
    }).subscribe();
  }

  // Добавляем обработчик для кнопки добавления проекта
  if (addProjectButton) {
    addProjectButton.addEventListener('click', addNewProject);
  }

  // Делегирование событий для контейнера проектов
  projectsContainer.addEventListener('input', (event) => {
    const input = event.target;
    if (input.classList.contains('modal1-input')) {
      const field = input.dataset.field;
      const value = input.value;
      const projectId = input.closest('.modal1-container').dataset.id;
      debouncedUpdateProjectField(projectId, field, value);
    }
  });

  // Делегирование событий для иконок (delete и edit)
  projectsContainer.addEventListener('click', (event) => {
    const icon = event.target.closest('.modal1-icon');
    if (icon) {
      const action = icon.dataset.action;
      const projectId = icon.closest('.modal1-container').dataset.id;
      if (action === 'delete') {
        deleteProject(projectId);
      }
      // Добавьте обработку 'edit', если необходимо
    }
  });

  // Инициализация при загрузке модала
  loadProjects();
  setupRealtime();

  // Добавляем обработчик события прокрутки
  projectsContainer.addEventListener('scroll', onScroll);

  // Экспортируем функции, чтобы они были доступны из HTML (если необходимо)
  window.deleteProject = deleteProject;
</script>
